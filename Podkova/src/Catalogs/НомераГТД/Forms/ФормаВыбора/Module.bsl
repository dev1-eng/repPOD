
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если Параметры.Свойство("АвтоТест") Тогда // Возврат при получении формы для анализа.
		Возврат;
	КонецЕсли;

	Если Параметры.Отбор.Свойство("СтранаПроисхождения", СтранаПроисхождения) Тогда
		Если Не ЗначениеЗаполнено(СтранаПроисхождения) Тогда
			Параметры.Отбор.Удалить("СтранаПроисхождения");
		КонецЕсли;
		ОбщегоНазначенияКлиентСервер.УстановитьЭлементОтбораДинамическогоСписка(Список, "СтранаПроисхождения", СтранаПроисхождения, ВидСравненияКомпоновкиДанных.Равно,, ЗначениеЗаполнено(СтранаПроисхождения));
	КонецЕсли;
	
	Параметры.Свойство("Номенклатура", Номенклатура);
	Параметры.Свойство("ДокументПередачи", ДокументПродажиПередачи);
	
	Элементы.ГруппаДокументПродажиПередачи.Видимость = ЗначениеЗаполнено(ДокументПродажиПередачи);
	Элементы.ОтборВключен.Видимость                  = ЗначениеЗаполнено(ДокументПродажиПередачи);
	ОтборВключен                                     = ЗначениеЗаполнено(ДокументПродажиПередачи);
	
	Если ОтборВключен Тогда
		УстановитьОтборПоДокументуПродажиПередачи();
	КонецЕсли;

	СобытияФорм.ПриСозданииНаСервере(ЭтаФорма, Отказ, СтандартнаяОбработка);

КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура Подключаемый_ВыполнитьПереопределяемуюКоманду(Команда)
	
	СобытияФормКлиент.ВыполнитьПереопределяемуюКоманду(ЭтаФорма, Команда);
	
КонецПроцедуры

&НаКлиенте
Процедура СтранаПриИзменении(Элемент)
	ОбщегоНазначенияКлиентСервер.УстановитьЭлементОтбораДинамическогоСписка(Список, "СтранаПроисхождения", СтранаПроисхождения, ВидСравненияКомпоновкиДанных.Равно,, ЗначениеЗаполнено(СтранаПроисхождения));
КонецПроцедуры

&НаКлиенте
Процедура ОтборВключенПриИзменении(Элемент)
	УстановитьОтборПоДокументуПродажиПередачи();
КонецПроцедуры

&НаКлиенте
Процедура СписокОбработкаЗаписиНового(НовыйОбъект, Источник, СтандартнаяОбработка)
	Если ОтборВключен Тогда
		ОтборВключен = Ложь;
		УстановитьОтборПоДокументуПродажиПередачи();
	КонецЕсли;
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура УстановитьОтборПоДокументуПродажиПередачи()
	
	Если ОтборВключен Тогда
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	РеализацияТоваровУслугВидыЗапасов.НомерГТД КАК Ссылка
			|ИЗ
			|	Документ.РеализацияТоваровУслуг.ВидыЗапасов КАК РеализацияТоваровУслугВидыЗапасов
			|ГДЕ
			|	РеализацияТоваровУслугВидыЗапасов.Ссылка = &ДокументПродажиПередачи
			|	И РеализацияТоваровУслугВидыЗапасов.АналитикаУчетаНоменклатуры.Номенклатура = &Номенклатура
			|
			|ОБЪЕДИНИТЬ
			|
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ОтчетОРозничныхПродажахВидыЗапасов.НомерГТД
			|ИЗ
			|	Документ.ОтчетОРозничныхПродажах.ВидыЗапасов КАК ОтчетОРозничныхПродажахВидыЗапасов
			|ГДЕ
			|	ОтчетОРозничныхПродажахВидыЗапасов.Ссылка = &ДокументПродажиПередачи
			|	И ОтчетОРозничныхПродажахВидыЗапасов.АналитикаУчетаНоменклатуры.Номенклатура = &Номенклатура
			|
			|ОБЪЕДИНИТЬ
			|
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ПередачаТоваровМеждуОрганизациямиВидыЗапасов.НомерГТД
			|ИЗ
			|	Документ.ПередачаТоваровМеждуОрганизациями.ВидыЗапасов КАК ПередачаТоваровМеждуОрганизациямиВидыЗапасов
			|ГДЕ
			|	ПередачаТоваровМеждуОрганизациямиВидыЗапасов.Ссылка = &ДокументПродажиПередачи
			|	И ПередачаТоваровМеждуОрганизациямиВидыЗапасов.АналитикаУчетаНоменклатуры.Номенклатура = &Номенклатура";
		
		Запрос.УстановитьПараметр("ДокументПродажиПередачи", ДокументПродажиПередачи);
		Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
		
		РезультатЗапроса = Запрос.Выполнить();
		ВыборкаНомеровГТД = РезультатЗапроса.Выбрать();
		СписокНомеровГТД = Новый СписокЗначений;
		Пока ВыборкаНомеровГТД.Следующий() Цикл
			СписокНомеровГТД.Добавить(ВыборкаНомеровГТД.Ссылка);
		КонецЦикла;
		
		ОбщегоНазначенияКлиентСервер.УстановитьЭлементОтбораДинамическогоСписка(
			Список, "Ссылка", СписокНомеровГТД, ВидСравненияКомпоновкиДанных.ВСписке, , Истина);
	Иначе
		ОбщегоНазначенияКлиентСервер.УстановитьЭлементОтбораДинамическогоСписка(
			Список, "Ссылка", , , , Ложь);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти