#Область ПрограммныйИнтерфейс

#Область ЭтапыРасчета

// Этап "ПодготовкаДанныхДляУчетаНДСиУСН"
//
// Параметры:
//	ПараметрыРасчета - Структура - параметры расчета себестоимости
//
Процедура ПодготовкаДанныхДляУчетаНДСиУСН(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "ПодготовкаДанныхДляУчетаНДСиУСН");
	
	// 1. Инициализация структуры данных для расчета
	//	- формирует структуру ПараметрыРасчета.РаспределениеПартий.
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьРаспределениеПартий(
		ПараметрыРасчета,
		ТаблицаДляРаспределенияПартийНДС(ПараметрыРасчета),
		ОписаниеЦепочекПартийНДС(ПараметрыРасчета),
		ОписаниеДвиженийПартийНДС(ПараметрыРасчета),
		ОписаниеНезаписываемыхПартийНДС(ПараметрыРасчета));
		
	// 2. Получение исходных данных для расчета
	// 	- формирует временную таблицу Данные.
	ПолучитьДанныеДляПартийНДС(ПараметрыРасчета);
	
	// 3. Получение цепочек из исходных данных
	// 	- формирует временные таблицы Источники и Приемники.
	РасчетСебестоимостиПрикладныеАлгоритмы.ПостроитьЦепочкиДвижений(ПараметрыРасчета);
	
	// 4. Заполнение партий в цепочках
	// 	- заполняет таблицу ПараметрыРасчета.РаспределениеПартий.РасчетныеПартии.
	РасчетСебестоимостиПрикладныеАлгоритмы.РассчитатьПартииПоЦепочкам(ПараметрыРасчета);
	
	// 5. Помещение данных в таблицу-приемник и очистка вспомогательных временных таблиц.
	// 	- формирует движения по регистру ДетализацияПартийТоваровДляНДСиУСН.
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗавершитьРаспределениеПартий(ПараметрыРасчета);
	
КонецПроцедуры

// Этап "ПодготовкаДанныхДляУчетаНДСиУСН2_4"
//
// Параметры:
//	ПараметрыРасчета - Структура - параметры расчета себестоимости
//
Процедура ПодготовкаДанныхДляУчетаНДСиУСН2_4(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "ПодготовкаДанныхДляУчетаНДСиУСН2_4");
	
	// 1. Инициализация структуры данных для расчета
	//	- формирует структуру ПараметрыРасчета.РаспределениеПартий
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьРаспределениеПартий(
		ПараметрыРасчета,
		ТаблицаДляРаспределенияПартийНДС2_4(ПараметрыРасчета),
		ОписаниеЦепочекПартийНДС2_4(ПараметрыРасчета),
		ОписаниеДвиженийПартийНДС2_4(ПараметрыРасчета),
		ОписаниеНезаписываемыхПартийНДС2_4(ПараметрыРасчета));
		
	// 2. Получение исходных данных для расчета
	// 	- формирует временную таблицу Данные
	ПолучитьДанныеДляПартийНДС2_4(ПараметрыРасчета);
	
	// 3. Получение цепочек из исходных данных
	// 	- формирует временные таблицы Источники и Приемники
	РасчетСебестоимостиПрикладныеАлгоритмы.ПостроитьЦепочкиДвижений(ПараметрыРасчета);
	
	// 4. Заполнение партий в цепочках
	// 	- заполняет таблицу ПараметрыРасчета.РаспределениеПартий.РасчетныеПартии
	РасчетСебестоимостиПрикладныеАлгоритмы.РассчитатьПартииПоЦепочкам(ПараметрыРасчета);
	
	// 5. Помещение данных в таблицу-приемник и очистка вспомогательных временных таблиц.
	// 	- формирует движения по регистру ДетализацияПартийТоваровДляНДСиУСН2_4
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗавершитьРаспределениеПартий(ПараметрыРасчета);
	
КонецПроцедуры

		
// Этап "ПодготовкаДанныхДляПартийНДСКРаспределению"
//
// Параметры:
//	ПараметрыРасчета - Структура - параметры расчета себестоимости
//
Процедура ПодготовкаДанныхДляПартийНДСКРаспределению(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "ПодготовкаДанныхДляПартийНДСКРаспределению");
	
	// 1. Инициализация структуры данных для расчета
	//	- формирует структуру ПараметрыРасчета.РаспределениеПартий.
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьТрансляциюПартий(
		ПараметрыРасчета,
		Неопределено,
		Метаданные.РегистрыНакопления.ПартииНДСКРаспределению.Имя);
	
	// 2. Получение исходных данных для трансляции
	// 	- формирует временную таблицу Данные.
	ПолучитьДанныеДляПартийНДСКРаспределению(ПараметрыРасчета);
	
	// 3. Помещение данных в таблицу-приемник и очистка вспомогательных временных таблиц.
	// 	- формирует движения по регистру ПартииНДСКРаспределению.
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗавершитьРаспределениеПартий(ПараметрыРасчета);
	
КонецПроцедуры

// Этап формирования документов РаспределениеНДС
//
// Параметры:
//	ПараметрыРасчета - Структура - параметры расчета себестоимости
//
Процедура РаспределениеНДСПоВидамНалогообложения(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "РаспределениеНДСПоВидамНалогообложения");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	// Сохраним движения документа РаспределениеНДС по регистру ПрочиеРасходы до расчета.
	// Эти движения не имеют признаков "расчетные", т.к. формируются самим документом, а не механикой расчета себестоимости.
	// При окончании расчета механизм расчета не имеет возможности определить наличие изменений в таких движения.
	Запрос.Текст =
	"ВЫБРАТЬ
	|	*
	|ПОМЕСТИТЬ ВТДвиженияРаспределенияНДСПоПрочиеРасходыДоРасчета
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходы КАК Т
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|	И Т.Регистратор ССЫЛКА Документ.РаспределениеНДС
	|	И НЕ Т.РасчетПартий
	|	И НЕ Т.РасчетСебестоимости
	|	И Т.Активность";
	
	Запрос.Выполнить();
	
	// Вызовем "внешнюю" логику перепроведения документов РаспределениеНДС.
	// При этом будут переформированы "первичные" движения этих документов.
	РезультатРаспределенияНДС = Документы.РаспределениеНДС.РаспределитьНДС(
		ПараметрыРасчета.РасчетныйПериод.НачалоПериода,
		ПараметрыРасчета.МассивОрганизаций,
		РасчетСебестоимостиПрикладныеАлгоритмы.ИмяСобытияОшибкиДляЖурналаРегистрации(ПараметрыРасчета),
		ПараметрыРасчета.МенеджерВременныхТаблиц,
		Истина);
	
	РасчетСебестоимостиПротоколРасчета.УвеличитьКоличествоОбработанныхДанныхДляЗамера(
		ПараметрыРасчета,
		ПараметрыРасчета.МассивОрганизаций.Количество());
	
	// Сохраним движения документа РаспределениеНДС по регистру ПрочиеРасходы после расчета.
	Запрос.Текст =
	"ВЫБРАТЬ
	|	*
	|ПОМЕСТИТЬ ВТДвиженияРаспределенияНДСПоПрочиеРасходыПослеРасчета
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходы КАК Т
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|	И Т.Регистратор ССЫЛКА Документ.РаспределениеНДС
	|	И НЕ Т.РасчетПартий
	|	И НЕ Т.РасчетСебестоимости
	|	И Т.Активность";
	
	Запрос.Выполнить();
	
	Если ЗначениеЗаполнено(РезультатРаспределенияНДС.ТекстОшибки) Тогда
		
		ТекстДляПротокола = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru='Операция ""Распределение НДС"" не была выполнена по причине:
				|%1'"),
			РезультатРаспределенияНДС.ТекстОшибки);
			
		// В механизме закрытия месяца ошибка зарегистрирована из механизма распределения НДС.
		РасчетСебестоимостиПротоколРасчета.ЗафиксироватьОшибкуРасчета(
			ПараметрыРасчета,
			Перечисления.ТипыОшибокПартионногоУчетаИСебестоимости.ОшибкаРаспределенияНДС,
			ТекстДляПротокола);
		
	КонецЕсли;
		
	// Если документ РаспределениеНДС может делать движения по регистру,
	// обслуживаемому механизмом партионного учета и себестоимости,
	// то по этому регистру надо обновить расчетные кэши остатков и оборотов.
	// Иначе получится ситуация, что данные ИБ при проведении этих документов изменились,
	// а следующие этапы расчета "не увидят" этого во временных таблицах кэшей регистров.
	Если РезультатРаспределенияНДС.МассивДокументов.Количество() > 0 Тогда
		
		ВозможныеДвиженияДокументов = Метаданные.Документы.РаспределениеНДС.Движения;
		
		Для Каждого КлючИЗначение Из ПараметрыРасчета.Движения Цикл
			
			ОписаниеРегистра = КлючИЗначение.Значение;
			
			Если ВозможныеДвиженияДокументов.Содержит(ОписаниеРегистра.МетаданныеРегистра) Тогда
				ОписаниеРегистра.НадоОбновитьРасчетныйКэш = Истина;
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ОбновитьРасчетныеКэшиРегистров(ПараметрыРасчета, Истина);
	
	РасчетСебестоимостиПротоколРасчета.ДополнительнаяИнформация(
		ПараметрыРасчета,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru='Обработано документов ""Распределение НДС"": %1'"),
			РасчетСебестоимостиПротоколРасчета.ПредставлениеЗначения(
				РезультатРаспределенияНДС.МассивДокументов.Количество())));
	
КонецПроцедуры

#КонецОбласти

#Область Инициализация

// Инициализирует общие параметры расчета, описывающие обслуживаемые механизмом расчета регистры.
//
// Параметры:
//	ПараметрыРасчета - Структура - параметры расчета себестоимости
//
Процедура ИнициализироватьОбслуживаемыеРегистры(ПараметрыРасчета) Экспорт
	
	ПараметрыРасчета.РегистрыСРасчетнымиОборотами.Вставить(Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН.Имя, Истина);
	ПараметрыРасчета.РегистрыСРасчетнымиОборотами.Вставить(Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН2_4.Имя, Истина);
	
	ПараметрыРасчета.РегистрыСРасчетнымиОстатками.Вставить(Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН2_4.Имя, Истина);
	
КонецПроцедуры

// Дополняет перечень документов, которые могут иметь движения в разных месяцах или по нескольким организациям.
//
// Параметры:
//	РазныеПериоды - Булево - добавлять в результат документы с движениями в разных периодах
//	РазныеОрганизации - Булево - добавлять в результат документы с движениями по нескольким организациям
//	ИмяРегистра - Строка - имя регистра накопления, для которого нужно получить перечень документов;
//		пустое значение - перечень документов для всех регистров.
//	ОписаниеДокументов - Соответствие - Ключ - ОбъектМетаданных.
//
Процедура ДополнитьДокументыСРазнымиПериодамиИлиОрганизациямиВДвижениях(РазныеПериоды, РазныеОрганизации, ИмяРегистра, ОписаниеДокументов) Экспорт
	
	// Для движений в других периодах Значение = Истина означает
	// - наличие первичных+расчетных движений,
	// - расчетные движения формируются при расчете их периода.
	// Если указано значение Ложь, то это означает, что
	// - расчетные движения могут быть без первичных движений,
	// - расчетные движения любых периодов формируются при расчете периода документа.
	// Для движений других организаций Значение должно быть только Истина.
	
	Значение = Истина;
	
	Если ИмяРегистра = ""
	 ИЛИ ИмяРегистра = Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя Тогда
		Если РазныеПериоды Тогда
			ОписаниеДокументов.Вставить(Метаданные.Документы.СчетФактураНалоговыйАгент,  Значение); // движения могут быть любым периодом
		КонецЕсли;
	КонецЕсли;
	
	Если ИмяРегистра = ""
	 ИЛИ ИмяРегистра = Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН.Имя
	 ИЛИ ИмяРегистра = Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН2_4.Имя Тогда
		
		Если РазныеПериоды Тогда
			ОписаниеДокументов.Вставить(Метаданные.Документы.РеализацияТоваровУслуг, 	 Значение); // операция РеализацияБезПереходаПраваСобственности
			ОписаниеДокументов.Вставить(Метаданные.Документы.СчетФактураНалоговыйАгент,	 Значение); // движения могут быть любым периодом
		КонецЕсли;
		
	КонецЕсли;

	Если ИмяРегистра = ""
	 ИЛИ ИмяРегистра = Метаданные.РегистрыНакопления.НДСПредъявленный.Имя Тогда
		
		Если РазныеПериоды Тогда
			ОписаниеДокументов.Вставить(Метаданные.Документы.РасчетСебестоимостиТоваров, Значение);
		КонецЕсли;
		
	КонецЕсли;
	
	Если ИмяРегистра = ""
	 ИЛИ ИмяРегистра = Метаданные.РегистрыНакопления.ПартииНДСКРаспределению.Имя Тогда
		
		Если РазныеПериоды Тогда
			Для Каждого МетаДокумент Из Метаданные.Документы Цикл
				Если МетаДокумент.Движения.Содержит(Метаданные.РегистрыНакопления.ПартииНДСКРаспределению) Тогда
					ОписаниеДокументов.Вставить(МетаДокумент, Значение);
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// Формирует общие временные таблицы для отбора данных в запросах.
//
Процедура ИнициализироватьВременныеТаблицыДляОтборов(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоФормированиеВременнойТаблицы(ПараметрыРасчета, "ВТОтборАналитикиУчетаПартийНДС2_4");
	
	ИнициализироватьТаблицуДляОтбораАналитикУчетаПартийНДС2_4(ПараметрыРасчета.МенеджерВременныхТаблиц);
	
	РасчетСебестоимостиПротоколРасчета.ОкончаниеФормированиеВременнойТаблицы(ПараметрыРасчета, Истина);
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область Инициализация

Процедура ИнициализироватьТаблицуДляОтбораАналитикУчетаПартийНДС2_4(МенеджерВременныхТаблиц) Экспорт
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(МенеджерВременныхТаблиц, "ВТОтборАналитикиУчетаПартийНДС2_4");
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	Запрос.Текст = ТекстЗапросаТаблицыДляОтбораАналитикУчетаПартийНДС2_4();
	Запрос.Выполнить();
	
КонецПроцедуры

Функция ТекстЗапросаТаблицыДляОтбораАналитикУчетаПартийНДС2_4() Экспорт
	
	Возврат 
		"ВЫБРАТЬ
		|	Т.Ссылка КАК Ссылка,
		|	ВЫБОР
		|		КОГДА НЕ Т.Контрагент В (ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка), ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка), НЕОПРЕДЕЛЕНО)
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ВнешнийКонтрагент,
		|	ВЫБОР
		|		КОГДА Т.КодСтроки <> 0
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ЗаполненКодСтроки
		|ПОМЕСТИТЬ ВТОтборАналитикиУчетаПартийНДС2_4
		|ИЗ
		|	Справочник.КлючиАналитикиУчетаПартий КАК Т
		|ГДЕ
		|	НЕ Т.Контрагент В (ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка), ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка), НЕОПРЕДЕЛЕНО)
		|	ИЛИ Т.КодСтроки <> 0
		|";
	
КонецФункции

#КонецОбласти

#Область ПроцедурыЭтапа_РасчетПартийНДС

// Инициализация данных

Функция ПоляПотребленийПартииНДС(ПараметрыРасчета)
	
	Возврат "АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС";
	
КонецФункции

Функция ОписаниеЦепочекПартийНДС(ПараметрыРасчета) Экспорт
	
	ОписаниеЦепочек = Новый Соответствие;
	ПоляПотреблений	= ПоляПотребленийПартииНДС(ПараметрыРасчета);
	
	// ОстатокСгруппированный <- Остаток, ДопРасходы, ДопРасходыСПартией, КорректировкаСтоимости, ОтклонениеВСтоимости, ОстатокДляРаспределения 
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный, ПоляПотреблений + ", Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный,
		Перечисления.ТипыЗаписейПартий.Остаток, ПоляПотреблений + ", Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный,
		Перечисления.ТипыЗаписейПартий.ДопРасходы, ПоляПотреблений + ", Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный,
		Перечисления.ТипыЗаписейПартий.ДопРасходыСПартией, ПоляПотреблений + ", Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный,
		Перечисления.ТипыЗаписейПартий.КорректировкаСтоимости, ПоляПотреблений + ", Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный,
		Перечисления.ТипыЗаписейПартий.ОтклонениеВСтоимости, ПоляПотреблений + ", Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный,
		Перечисления.ТипыЗаписейПартий.ОстатокДляРаспределения, ПоляПотреблений + ", Партия");
		
	// ОстатокДляРаспределения <- ДопРасходыБезПартии
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ОстатокДляРаспределения, ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ОстатокДляРаспределения,
		Перечисления.ТипыЗаписейПартий.ДопРасходыБезПартии, ПоляПотреблений + ", ДокументИсточник");
	
	// ПартияСгруппированная <- Партия, ДопРасходы, ДопРасходыБезПартии, ДопРасходыСПартией, КорректировкаСтоимости, ОтклонениеВСтоимости,
	// Перемещение
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПартияСгруппированная, ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,
		Перечисления.ТипыЗаписейПартий.Партия, ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,
		Перечисления.ТипыЗаписейПартий.ДопРасходы, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,
		Перечисления.ТипыЗаписейПартий.ДопРасходыБезПартии, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,
		Перечисления.ТипыЗаписейПартий.ДопРасходыСПартией, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,
		Перечисления.ТипыЗаписейПартий.КорректировкаСтоимости, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,
		Перечисления.ТипыЗаписейПартий.ОтклонениеВСтоимости, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,
		Перечисления.ТипыЗаписейПартий.Перемещение, ПоляПотреблений + ", Регистратор");
	
	// Потребление <- (ОстатокСгруппированный, ПартияСгруппированная,
	// КорректировкаПриобретенияПрошлогоПериода, Перемещение, ПеремещениеОбособленно, Сторно, ВозвратПрошлыхПериодов, Выпуск,
	// ВозвратБезДокументаИсточника).
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Потребление, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный,		ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,		ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.Перемещение, ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно, ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.Сторно, 		ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.ВозвратПрошлыхПериодов, ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.Выпуск, 		ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Потребление,
		Перечисления.ТипыЗаписейПартий.ВозвратБезДокументаИсточника, ПоляПотреблений + ", Регистратор");
		
	// ПотреблениеАвто <- (ОстатокСгруппированный, ПартияСгруппированная, Перемещение, ПеремещениеОбособленно, Сторно).
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПотреблениеАвто, 		ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный,				ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,				ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.Перемещение, 		ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно, 		ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		Перечисления.ТипыЗаписейПартий.Сторно, 				ПоляПотреблений + ", Регистратор");
		
	// КорректировкаПриобретения <- (ОстатокСгруппированный, ПартияСгруппированная, ВозвратПрошлыхПериодов)	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.КорректировкаПриобретения, ПоляПотреблений);
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.КорректировкаПриобретения,
		Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный, 				 ПоляПотреблений);
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.КорректировкаПриобретения,
		Перечисления.ТипыЗаписейПартий.ПартияСгруппированная, 				 	 ПоляПотреблений);
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.КорректировкаПриобретения,
		Перечисления.ТипыЗаписейПартий.ВозвратПрошлыхПериодов,	 ПоляПотреблений);	
		
	// Сторно <- (Потребление, ПотреблениеАвто, Прошлое)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Сторно, 		"ДокументИсточник, КорАналитикаУчетаНоменклатуры, КорВидЗапасов");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Сторно,
		Перечисления.ТипыЗаписейПартий.Потребление, "Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Сторно,
		Перечисления.ТипыЗаписейПартий.ПотреблениеАвто, "Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Сторно,
		Перечисления.ТипыЗаписейПартий.Прошлое, 	"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
		
	// СторноВозвратНаДругойСклад <- (Потребление, ПотреблениеАвто, Прошлое)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.СторноВозвратНаДругойСклад,	"ДокументИсточник, КорАналитикаУчетаНоменклатуры, КорВидЗапасов");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СторноВозвратНаДругойСклад,
		Перечисления.ТипыЗаписейПартий.Потребление,					"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СторноВозвратНаДругойСклад,
		Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,				"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СторноВозвратНаДругойСклад,
		Перечисления.ТипыЗаписейПартий.Прошлое,						"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
	
	// ВозвратБезДокументаИсточника <- (Потребление)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ВозвратБезДокументаИсточника, ПоляПотреблений);
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ВозвратБезДокументаИсточника,
		Перечисления.ТипыЗаписейПартий.Потребление, 				 ПоляПотреблений);
		
	// ВозвратНаДругойСклад <- (СторноВозвратНаДругойСклад)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ВозвратНаДругойСклад,
		"Регистратор, АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ВозвратНаДругойСклад,
		Перечисления.ТипыЗаписейПартий.СторноВозвратНаДругойСклад,
		"Регистратор, АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС");
		
	// Распределение <- (Перемещение, ПеремещениеОбособленно, ОстатокСгруппированный, ПартияСгруппированная, Выпуск, ВозвратПрошлыхПериодов, Распределение)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Распределение,
		"АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.Перемещение,
		"АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно,
		"АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный,
		"АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,
		"АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.Выпуск,
		"АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Регистратор");	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.ВозвратПрошлыхПериодов,
		"АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Распределение,
		Перечисления.ТипыЗаписейПартий.Распределение,
		"АналитикаУчетаНоменклатуры, Организация, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Регистратор");
	
	// Перемещение <- (Потребление, ПотреблениеАвто, ПотреблениеПроизводство, ВозвратНаДругойСклад).
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Перемещение,
		"ДокументИсточник, Партия, АналитикаУчетаНоменклатуры, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Организация");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Перемещение,
		Перечисления.ТипыЗаписейПартий.Потребление,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС, Организация");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Перемещение,
		Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС, Организация");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Перемещение,
		Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС, Организация");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Перемещение,
		Перечисления.ТипыЗаписейПартий.ВозвратНаДругойСклад,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС, Организация");
		
	// ПеремещениеОбособленно <- (Потребление)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно,
		"ДокументИсточник, Партия, АналитикаУчетаНоменклатуры, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС, Организация");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно,
		Перечисления.ТипыЗаписейПартий.Потребление,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС, КорОрганизация");
		
	// ПеремещениеАвто <- (Потребление, ПотреблениеПроизводство, ПотреблениеАвто, Распределение).
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПеремещениеАвто,
		"ДокументИсточник, Партия, АналитикаУчетаНоменклатуры, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеАвто,
		Перечисления.ТипыЗаписейПартий.Потребление,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеАвто,
		Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеАвто,
		Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеАвто,
		Перечисления.ТипыЗаписейПартий.Распределение,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС");
		
	// СписанияНаВыпуск <- (Перемещение, ПеремещениеОбособленно, ПеремещениеАвто, ПартияСгруппированная, ОстатокСгруппированный, Выпуск).
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск, ПоляПотреблений + ",Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		Перечисления.ТипыЗаписейПартий.Перемещение, ПоляПотреблений + ",Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно, ПоляПотреблений + ",Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		Перечисления.ТипыЗаписейПартий.ПеремещениеАвто, ПоляПотреблений + ",Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		Перечисления.ТипыЗаписейПартий.ПартияСгруппированная, ПоляПотреблений + ",Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный, ПоляПотреблений + ",Партия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		Перечисления.ТипыЗаписейПартий.Выпуск, ПоляПотреблений + ",Партия");
		
	// Выпуск <- (СписанияНаВыпуск, Потребление)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Выпуск,
		"Регистратор, Партия, АналитикаУчетаНоменклатуры, РазделУчета, ВидЗапасов, АналитикаФинансовогоУчета, ВидДеятельностиНДС");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Выпуск,
		Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Выпуск,
		Перечисления.ТипыЗаписейПартий.Потребление,
		"Регистратор, КорПартия, КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС");	
	// Также эта связь используется в ТекстДвиженияСебестоимостиТоваров()
		
	// ПотреблениеПроизводство <- (ПартияСгруппированная, Перемещение, ПеремещениеОбособленно, ОстатокСгруппированный)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство, "АналитикаУчетаНоменклатуры, Организация, РазделУчета, ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство,
		Перечисления.ТипыЗаписейПартий.ПартияСгруппированная, "АналитикаУчетаНоменклатуры, Организация, РазделУчета, Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство,
		Перечисления.ТипыЗаписейПартий.Перемещение, 		"АналитикаУчетаНоменклатуры, Организация, РазделУчета, Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно, "АналитикаУчетаНоменклатуры, Организация, РазделУчета, Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство,
		Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный, "АналитикаУчетаНоменклатуры, Организация, РазделУчета, Регистратор");
		
	// СписаниеНаРасходы <- (ПартияСгруппированная, Выпуск)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.СписаниеНаРасходы, ПоляПотреблений + ", ДокументИсточник");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписаниеНаРасходы,
		Перечисления.ТипыЗаписейПартий.ПартияСгруппированная, ПоляПотреблений + ", Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.СписаниеНаРасходы,
		Перечисления.ТипыЗаписейПартий.Выпуск, ПоляПотреблений + ", Регистратор");
		
	// ВозвратПрошлыхПериодов <- (Прошлое)
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ВозвратПрошлыхПериодов, "ДокументИсточник, КорАналитикаУчетаНоменклатуры, КорВидЗапасов, Организация, РазделУчета");
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеИсточника(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ВозвратПрошлыхПериодов,
		Перечисления.ТипыЗаписейПартий.Прошлое, 			   "Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, РазделУчета");	
		
	// Дополнение, ОтклонениеВСтоимости, РаспределениеПоВыбывшимТоварам, ПеремещениеУпр <- (<без источников - для формирования записей по
	// данным запроса>).
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеДополнения(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Дополнение);
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеДополнения(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ВключениеИсключениеНДСВСтоимости);
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеДополнения(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ОтклонениеВСтоимости);
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеДополнения(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам);
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеДополнения(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеУпр);
	
	Возврат ОписаниеЦепочек;
	
КонецФункции

Функция ОписаниеДвиженийПартийНДС(ПараметрыРасчета)
	
	КолонкиТаблицыРаспределения = ТаблицаДляРаспределенияПартийНДС(ПараметрыРасчета).Колонки;
	
	ОписаниеДвижений = РасчетСебестоимостиПрикладныеАлгоритмы.ОписаниеДвижений();
	ОписаниеДвижений.Вставить("Контекст", "ПодготовкаДанныхДляУчетаНДСиУСН");
	ОписаниеДвижений.Вставить("ИмяРегистра", Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН.Имя);
	ОписаниеДвижений.Вставить("ПоляРасчета", РасчетСебестоимостиПрикладныеАлгоритмы.ПереченьПолей(КолонкиТаблицыРаспределения));
	ОписаниеДвижений.Вставить("КлючиСравнения",	ПоляПотребленийПартииНДС(ПараметрыРасчета));
	ОписаниеДвижений.Вставить("Показатели", "Знаменатель, ЗнаменательДляИсточников, Количество, СтоимостьБезНДС, НДС, НДСУпр");
	ОписаниеДвижений.Вставить("БазисПрихода", "Знаменатель");
	ОписаниеДвижений.Вставить("БазисРасхода", "Знаменатель");
	ОписаниеДвижений.Вставить("КлючРасхода", "ДокументИсточник");
	ОписаниеДвижений.Вставить("ПолеПорядка", "Период");
	ОписаниеДвижений.Вставить("ПоляСортировки", "Партия");
	ОписаниеДвижений.Вставить("СортировкаПоУсловию", Истина);

	ОписаниеДвижений.Вставить("ПоляСуммирования", "Количество, СтоимостьБезНДС, НДС, НДСУпр");
	ОписаниеДвижений.Вставить("ПоляГруппировки", 
		РасчетСебестоимостиПрикладныеАлгоритмы.ПереченьПолей(КолонкиТаблицыРаспределения, ОписаниеДвижений.ПоляСуммирования));
	ОписаниеДвижений.Вставить("ЕстьСторно", Истина);
	ОписаниеДвижений.Вставить("УменьшатьБазис", Истина);
	ОписаниеДвижений.Вставить("УдалятьСтрокиБезИсточников", Истина);
	
	ОписаниеДвижений.Вставить("ВременныеТаблицыДляСледующихЭтапов", "ПриходыТоваровНДС");
	
	Возврат ОписаниеДвижений;
	
КонецФункции

Функция ОписаниеНезаписываемыхПартийНДС(ПараметрыРасчета)
	
	НезаписываемыеТипыЗаписей = Новый Соответствие;
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.Остаток,   Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.Прошлое,   Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный, Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.ПартияСгруппированная, Истина);
	
	НезаписываемыеРазделы = Новый Соответствие;
	НезаписываемыеРазделы.Вставить(Перечисления.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка(), Истина);
	
	Возврат РасчетСебестоимостиПрикладныеАлгоритмы.ОписаниеНезаписываемыхДанных(Ложь, НезаписываемыеТипыЗаписей, НезаписываемыеРазделы);
	
КонецФункции

Функция ТаблицаДляРаспределенияПартийНДС(ПараметрыРасчета)
	
	Возврат РасчетСебестоимостиПрикладныеАлгоритмы.ТаблицаДляРаспределенияПартий(ПараметрыРасчета,	ТекстОписаниеДанныхДляПартийНДСиУСН());
	
КонецФункции

// Выборка данных

Процедура ПолучитьДанныеДляПартийНДС(ПараметрыРасчета)
	
	ПараметрыНумерации = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		"АналитикаУчетаНоменклатуры", // разделитель
		"Знаменатель, Количество, СтоимостьБезНДС, НДС, НДСУпр", // ресурсы
		"АналитикаУчетаНоменклатуры, Период, Приоритет ВОЗР, РазделУчета, Организация, АналитикаУчетаНоменклатуры, Партия, Регистратор"); // порядок
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьДанныеЭтапаРасчета(
		ПараметрыРасчета,
		ТекстЗапросаДляПартийНДС(ПараметрыРасчета),
		ПараметрыНумерации);
	
	СкорректироватьАналитикиУчетаПартийДляПартийНДС(ПараметрыРасчета);
	
КонецПроцедуры

Процедура СкорректироватьАналитикиУчетаПартийДляПартийНДС(ПараметрыРасчета)
	
	ТекстЗапроса = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий
	|ИЗ
	|	Данные КАК Т";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.СкорректироватьАналитикиУчетаПартийПриРасчете(ПараметрыРасчета, ТекстЗапроса);
	
КонецПроцедуры

// Тексты запросов

// ... общий

Функция ТекстЗапросаДляПартийНДС(ПараметрыРасчета = Неопределено) Экспорт
	
	ТекстЗапроса = ""
		// подготовка временных таблиц
		+ ТекстИнициализацияПартийНДС() // вт ПриходыТоваров, СписаниеОтклоненийВСтоимости, ОстаткиТоваров, ПрошлыеРеализацииПартийНДС, ПриходыТоваровНДС
		+ ОбщегоНазначенияУТ.РазделительЗапросовВПакете()
		+ ТекстДвиженияСебестоимостиНДС() // вт ДвиженияСебестоимостиНДС
		+ ОбщегоНазначенияУТ.РазделительЗапросовВПакете()
		+ ТекстПрошлыеРеализацииСебестоимость() // вт ПрошлыеРеализацииСебестоимость
		+ ОбщегоНазначенияУТ.РазделительЗапросовВПакете()
		// выборка данных
		+ ТекстОписаниеДанныхДляПартийНДСиУСН() //вт Данные
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстДетальныеНачальныеОстаткиПартийНДС() // использует ВТНачальныеОстаткиПартийНДС
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстНачальныеОстаткиПартийНДС() // использует ОстаткиТоваров, ОстаткиСебестоимостиТоваров
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстНачальныеОстаткиПартийДляДопРасходов() // использует ОстаткиТоваров, ОстаткиСебестоимостиТоваров
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстДетальныеПриходыСебестоимостиТоваров() // использует ПриходыТоваровНДС
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстПриходыСебестоимостиТоваров() // использует ПриходыТоваровНДС
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстДвиженияСебестоимостиТоваров()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстДвиженияСебестоимостиТоваровСборка()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстВозвратыПрошлыхПериодов()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстРеализацииПрошлыхМесяцевПартииНДС() // использует ПрошлыеРеализации
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстРеализацииПрошлыхМесяцевПартииНДС21() // использует ПрошлыеРеализации
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстТаможенныеДекларацииИзменениеВидыДеятельностиНДС()
		+ "";
	
	Возврат ТекстЗапроса;
	
КонецФункции

// ... описания данных

Функция ТекстОписаниеДанныхДляПартийНДСиУСН()
	Возврат
		"ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80)) 					КАК ЗапросИсточник,
		|	ДД.ТипЗаписи 									КАК ТипЗаписи,
		|	ЛОЖЬ											КАК Сторно,
		|	0 												КАК Приоритет,
		|	0 												КАК Знаменатель,
		|	0 												КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ 											КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) 	КАК Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС 		КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|
		|	ДД.Количество,
		|	ДД.СтоимостьБезНДС,
		|	ДД.НДС,
		|	ДД.НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.РазделУчета КАК КорРазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ДД.Организация КАК КорОрганизация,
		|	ДД.Партия КАК КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	ДД.ДокументИсточник,
		|	ДД.СтатьяСписанияНДС,
		|	ДД.АналитикаСписанияНДС,
		|	ДД.КорНаправлениеДеятельности
		|//ВоВременнуюТаблицу
		|ИЗ
		|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН КАК ДД
		|";
КонецФункции

// ... формирования временные таблиц

Функция ТекстИнициализацияПартийНДС() // вт ПриходыТоваров, СписаниеОтклоненийВСтоимости, ОстаткиТоваров, ПрошлыеРеализацииПартийНДС, ПриходыТоваровНДС, ДвиженияСебестоимостиНДС
	Возврат
		"ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.Организация В (&ОрганизацииСФИФОСкользящая)
		|			ТОГДА ДД.Партия
		|		КОГДА НЕ Корректировка.ДокументОснование ЕСТЬ NULL
		|			ТОГДА Корректировка.ДокументОснование
		|		КОГДА НЕ ВводОстатков.Партия ЕСТЬ NULL
		|			ТОГДА ВводОстатков.Партия
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ) КАК Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	СУММА(ДД.Количество) КАК Количество
		|ПОМЕСТИТЬ ПриходыТоваров
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК Корректировка
		|		ПО Корректировка.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВводОстатков КАК ВводОстатков
		|		ПО ВводОстатков.Ссылка = ДД.Регистратор
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.Количество > 0
		|	И ДД.СлужебноеВидДвиженияПриход
		|	И ДД.ТипЗаписи <> ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.Организация В (&ОрганизацииСФИФОСкользящая)
		|			ТОГДА ДД.Партия
		|		КОГДА НЕ Корректировка.ДокументОснование ЕСТЬ NULL
		|			ТОГДА Корректировка.ДокументОснование
		|		КОГДА НЕ ВводОстатков.Партия ЕСТЬ NULL
		|			ТОГДА ВводОстатков.Партия
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ),
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС
		|ИНДЕКСИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.Регистратор,
		|	СУММА(ДД.Количество) КАК Количество
		|ПОМЕСТИТЬ ПриходыСборокТоваров
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.Количество > 0
		|	И ДД.СлужебноеВидДвиженияПриход
		|	И ДД.Регистратор ССЫЛКА Документ.СборкаТоваров
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.Регистратор
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	СУММА(ДД.ДопРасходыРегл)	КАК ДопРасходыРегл,
		|	СУММА(ДД.НДСРегл)			КАК НДСРегл,
		|	СУММА(ДД.НДСУпр)			КАК НДСУпр
		|ПОМЕСТИТЬ СписаниеОтклоненийВСтоимости
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
		|	И НЕ ДД.СлужебноеВидДвиженияПриход
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.КоличествоОстаток КАК Количество
		|ПОМЕСТИТЬ ОстаткиТоваров
		|ИЗ
		|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН.Остатки(&ГраницаКонецПредыдущегоПериода,
		|		Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)) КАК ДД
		|ГДЕ
		|	ДД.КоличествоОстаток > 0
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.ДокументИсточник,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС
		|	КОНЕЦ КАК ВидДеятельностиНДС,
		|	СУММА(ДД.Количество) КАК Количество
		|ПОМЕСТИТЬ ПрошлыеРеализацииПартийНДС
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов)
		|	И ДД.Количество <> 0
		|СГРУППИРОВАТЬ ПО
		|	ДД.ДокументИсточник,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС
		|	КОНЕЦ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход
		|			И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|		ИНАЧЕ ДД.ТипЗаписи КОНЕЦ) КАК ТипЗаписи,
		|	ЛОЖЬ КАК Сторно,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|		 ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.Организация В (&ОрганизацииСФИФОСкользящая)
		|			ТОГДА ДД.Партия
		|		КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|			ТОГДА ЕСТЬNULL(ВводОстатков.Партия,
		|					ЕСТЬNULL(ДопРасходыКорректировка.ДокументОснование, ДД.ДокументИсточник))
		|		КОГДА НЕ Корректировка.ДокументОснование ЕСТЬ NULL
		|			ТОГДА Корректировка.ДокументОснование
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ) КАК Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам))
		|		И ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		КОГДА ДД.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия) И ДД.Количество = 0
		|		 И ДД.КорАналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		ИНАЧЕ ДД.АналитикаУчетаПартий КОНЕЦ) КАК АналитикаУчетаПартий,
		|	(ВЫБОР
		|		КОГДА НЕ Корректировка.ВидКорректировки ЕСТЬ NULL
		|		 И Корректировка.ВидКорректировки <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон)
		|			ТОГДА Корректировка.ДокументОснование
		|		КОГДА НЕ СчетФактура.Исправление ЕСТЬ NULL И СчетФактура.Исправление
		|			ТОГДА СчетФактура.СчетФактураОснование
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ) КАК ДокументПоступления,
		|
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(
		|		ВЫБОР КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|		 И ДД.НДСРегл = 0
		|			ТОГДА 0
		|			ИНАЧЕ ДД.СтоимостьРегл + ДД.ДопРасходыРегл КОНЕЦ
		|		+ ВЫБОР
		|			КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|				ТОГДА -ДД.НДСРегл
		|			ИНАЧЕ 0
		|	КОНЕЦ - ЕСТЬNULL(СписаниеОтклонений.ДопРасходыРегл, 0)) КАК СтоимостьБезНДС,
		|	СУММА(ДД.НДСРегл - ЕСТЬNULL(СписаниеОтклонений.НДСРегл, 0)) КАК НДС,
		|	СУММА(ВЫБОР
		|		КОГДА &УправленческийУчетОрганизаций
		|			ТОГДА ДД.НДСУпр - ЕСТЬNULL(СписаниеОтклонений.НДСУпр, 0)
		|		ИНАЧЕ 0
		|	КОНЕЦ) КАК НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	(ВЫБОР
		|		КОГДА ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|		 И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.СтатьяРасходовСписания
		|		КОГДА ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
		|			ТОГДА ДД.СтатьяАктивовПассивов
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов КАК АналитикаАктивов,
		|	(ВЫБОР
		|		КОГДА НЕ ДД.Организация В (&ОрганизацииСФИФОСкользящая)
		|		 И Реестр.ДатаДокументаИБ < &НачалоПериода
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		КОГДА ДД.Партия <> НЕОПРЕДЕЛЕНО
		|		 И ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|			ТОГДА ДД.Партия
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ) КАК ДокументИсточник
		|ПОМЕСТИТЬ ПриходыТоваровНДС
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПоПартнерам КАК АналитикаРасчетов
		|		ПО АналитикаРасчетов.Ссылка = ДД.АналитикаУчетаПоПартнерам
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК Договоры
		|		ПО Договоры.Ссылка = АналитикаРасчетов.Договор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК Корректировка
		|		ПО Корректировка.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК ДопРасходыКорректировка
		|		ПО ДопРасходыКорректировка.Ссылка = ДД.ДокументИсточник
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученныйНалоговыйАгент КАК СчетФактура
		|		ПО СчетФактура.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВводОстатков КАК ВводОстатков
		|		ПО ВводОстатков.Ссылка = ДД.ДокументИсточник
		|	ЛЕВОЕ СОЕДИНЕНИЕ СписаниеОтклоненийВСтоимости КАК СписаниеОтклонений
		|		ПО СписаниеОтклонений.Организация = ДД.Организация
		|		И СписаниеОтклонений.РазделУчета = ДД.РазделУчета
		|		И СписаниеОтклонений.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И СписаниеОтклонений.ВидЗапасов = ДД.ВидЗапасов
		|		И СписаниеОтклонений.Партия = ДД.Партия
		|		И СписаниеОтклонений.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И СписаниеОтклонений.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|		И ДД.СлужебноеВидДвиженияПриход
		|		И ДД.ТипЗаписи <> ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РеестрДокументов КАК Реестр
		|		ПО Реестр.Ссылка = ДД.ДокументИсточник
		|		И НЕ Реестр.ДополнительнаяЗапись
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И (ДД.СлужебноеВидДвиженияПриход
		|		ИЛИ ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
		|		ИЛИ ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
		|		ИЛИ ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
		|	И НЕ ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВключениеИсключениеНДСВСтоимости)
		// Исключаем суммовую корректировку приобретения, если корректируемый документ относится к периоду с выключенным партионным учетом.
		|	И НЕ (
		|		ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода)
		|   	И ДД.СлужебноеВидДвиженияПриход
		|		И ДД.Количество = 0
		|		И Реестр.ДатаДокументаИБ < &ДатаПереходаНаПартионныйУчетВерсии22
		|		И &ИспользовалсяПартионныйУчетДоПереходаНаВерсию22 = ЛОЖЬ)
		|	И (ДД.НДСРегл <> 0
		|		ИЛИ ДД.НДСУпр <> 0
		|		ИЛИ ДД.Организация В (&ОрганизацииНаУСН)
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.СборкаТоваров
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ТаможеннаяДекларацияИмпорт
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПорчаТоваров
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПересортицаТоваров
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ОприходованиеИзлишковТоваров
		|		ИЛИ ЕСТЬNULL(Договоры.УчетАгентскогоНДС, ЛОЖЬ)
		|		ИЛИ ДД.ХозяйственнаяОперация В (
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭС),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСНеотфактурованнаяПоставка),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСТоварыВПути),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаПоИмпорту),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаПоИмпортуТоварыВПути))
		|		ИЛИ ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.ПоступлениеТоваровНаСклад)
		|		)
		|	И НЕ (ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|			И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства))
		|	И ДД.ТипЗаписи В (
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение))
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И (ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
		|		)
		|	И НЕ ДД.РазделУчета В (
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажи),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажиПереданныеПартнерам),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажиКОформлениюСписания),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки))
		|	И (ВЫБОР
		|		КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам))
		|		И ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		КОГДА ДД.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия) И ДД.Количество = 0
		|		 И ДД.КорАналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		ИНАЧЕ ДД.АналитикаУчетаПартий КОНЕЦ) <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ОтчетКомитентуОСписании
		|	И НЕ (ДД.Регистратор ССЫЛКА Документ.ВводОстатков
		|			И НЕ ВЫРАЗИТЬ(ДД.Регистратор КАК Документ.ВводОстатков).ВводОстатков22)
		|	И НЕ (НЕ Корректировка.ВидКорректировки ЕСТЬ NULL
		|			И Корректировка.ВидКорректировки = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон)
		|			И ДД.Количество = 0
		|			И (ДД.СтоимостьРегл < 0 ИЛИ ДД.ДопРасходыРегл < 0))
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход
		|			И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|		ИНАЧЕ ДД.ТипЗаписи КОНЕЦ),
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|		 ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.Организация В (&ОрганизацииСФИФОСкользящая)
		|			ТОГДА ДД.Партия
		|		КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|			ТОГДА ЕСТЬNULL(ВводОстатков.Партия,
		|					ЕСТЬNULL(ДопРасходыКорректировка.ДокументОснование, ДД.ДокументИсточник))
		|		КОГДА НЕ Корректировка.ДокументОснование ЕСТЬ NULL
		|			ТОГДА Корректировка.ДокументОснование
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ),
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам))
		|		И ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		КОГДА ДД.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия) И ДД.Количество = 0
		|		 И ДД.КорАналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		ИНАЧЕ ДД.АналитикаУчетаПартий КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА НЕ Корректировка.ВидКорректировки ЕСТЬ NULL
		|		 И Корректировка.ВидКорректировки <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон)
		|			ТОГДА Корректировка.ДокументОснование
		|		КОГДА НЕ СчетФактура.Исправление ЕСТЬ NULL И СчетФактура.Исправление
		|			ТОГДА СчетФактура.СчетФактураОснование
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ),
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	(ВЫБОР
		|		КОГДА ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|		 И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.СтатьяРасходовСписания
		|		КОГДА ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
		|			ТОГДА ДД.СтатьяАктивовПассивов
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	(ВЫБОР
		|		КОГДА НЕ ДД.Организация В (&ОрганизацииСФИФОСкользящая)
		|		 И Реестр.ДатаДокументаИБ < &НачалоПериода
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		КОГДА ДД.Партия <> НЕОПРЕДЕЛЕНО
		|		 И ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|			ТОГДА ДД.Партия
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) КАК ТипЗаписи,
		|	ЛОЖЬ КАК Сторно,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|
		|	(ВЫБОР
		|		КОГДА ДД.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		ИНАЧЕ ДД.АналитикаУчетаПартий КОНЕЦ) КАК АналитикаУчетаПартий,
		|	ДД.Регистратор КАК ДокументПоступления,
		|
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(СписаниеОтклонений.ДопРасходыРегл
		|		+ ВЫБОР
		|			КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|				ТОГДА -СписаниеОтклонений.НДСРегл
		|			ИНАЧЕ 0
		|	КОНЕЦ) КАК СтоимостьБезНДС,
		|	СУММА(СписаниеОтклонений.НДСРегл) КАК НДС,
		|	СУММА(ВЫБОР
		|		КОГДА &УправленческийУчетОрганизаций
		|			ТОГДА СписаниеОтклонений.НДСУпр
		|		ИНАЧЕ 0
		|	КОНЕЦ) КАК НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов КАК АналитикаАктивов,
		|	(ВЫБОР
		|		КОГДА ДД.Партия <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Партия
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ) КАК ДокументИсточник
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ СписаниеОтклоненийВСтоимости КАК СписаниеОтклонений
		|		ПО СписаниеОтклонений.Организация = ДД.Организация
		|		И СписаниеОтклонений.РазделУчета = ДД.РазделУчета
		|		И СписаниеОтклонений.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И СписаниеОтклонений.ВидЗапасов = ДД.ВидЗапасов
		|		И СписаниеОтклонений.Партия = ДД.Партия
		|		И СписаниеОтклонений.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И СписаниеОтклонений.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|		И ДД.СлужебноеВидДвиженияПриход
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.СлужебноеВидДвиженияПриход
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
		|	И (ВЫБОР
		|		КОГДА ДД.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		ИНАЧЕ ДД.АналитикаУчетаПартий КОНЕЦ) <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|СГРУППИРОВАТЬ ПО
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	(ВЫБОР
		|		КОГДА ДД.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		ИНАЧЕ ДД.АналитикаУчетаПартий КОНЕЦ),
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	(ВЫБОР
		|		КОГДА ДД.Партия <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Партия
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОстатокСгруппированный) КАК ТипЗаписи,
		|	ЛОЖЬ КАК Сторно,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|		 ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.НДС) КАК НДС,
		|	СУММА(ДД.НДСУпр) КАК НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов КАК АналитикаАктивов,
		|	ДД.Регистратор КАК ДокументИсточник
		|ИЗ
		|	ВТКэшРасчетныеОборотыДетализацияПартийТоваровДляНДСиУСН КАК ДД
		|ГДЕ
		|	ДД.Регистратор ССЫЛКА Документ.ВводОстатков
		|	И ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И НЕ ВЫРАЗИТЬ(Регистратор КАК Документ.ВводОстатков).ВводОстатков22
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.ТипЗаписи,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|		 ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.КоличествоОстаток КАК Количество
		|ПОМЕСТИТЬ ОстаткиСебестоимостиТоваров
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Остатки(&ГраницаКонецПредыдущегоПериода,
		|		Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)) КАК ДД
		|ГДЕ
		|	ДД.КоличествоОстаток > 0
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВЫБОР КОГДА ЕСТЬNULL(Остатки.Количество, ДД.КоличествоОстаток) < 0
		|		ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК Сторно,
		|	ЕСТЬNULL(Остатки.Количество, ДД.КоличествоОстаток) КАК Знаменатель,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура 	КАК Номенклатура,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС 	КАК НалогообложениеПартии,
		|	
		| ЕСТЬNULL(ПериодикаПартии.ДатаРегистратора, &КонецПредыдущегоПериода) КАК Период,
		|	(ВЫБОР
		|		КОГДА ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути)
		|			ТОГДА ДД.Партия
		|		КОГДА ОстаткиСебестоимостиТоваров.Партия ЕСТЬ NULL
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		КОГДА ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
		|			ТОГДА ДД.Партия
		|		ИНАЧЕ ДД.Партия КОНЕЦ) КАК Регистратор,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|
		|	ДД.КоличествоОстаток КАК Количество,
		|	ДД.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
		|	ДД.НДСОстаток КАК НДС,
		|	ДД.НДСУпрОстаток КАК НДСУпр
		|ПОМЕСТИТЬ ВТНачальныеОстаткиПартийНДС
		|ИЗ
		|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН.Остатки(&ГраницаКонецПредыдущегоПериода,
		|		Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)) КАК ДД
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиТоваров КАК Остатки
		|		ПО Остатки.Организация = ДД.Организация
		|		И Остатки.РазделУчета = ДД.РазделУчета
		|		И Остатки.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Остатки.ВидЗапасов = ДД.ВидЗапасов
		|		И Остатки.Партия = ДД.Партия
		|		И Остатки.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Остатки.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиСебестоимостиТоваров КАК ОстаткиСебестоимостиТоваров
		|		ПО ОстаткиСебестоимостиТоваров.Организация = ДД.Организация
		|		И ОстаткиСебестоимостиТоваров.РазделУчета = ДД.РазделУчета
		|		И ОстаткиСебестоимостиТоваров.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И ОстаткиСебестоимостиТоваров.ВидЗапасов = ДД.ВидЗапасов
		|		И ОстаткиСебестоимостиТоваров.Партия = ДД.Партия
		|		И ОстаткиСебестоимостиТоваров.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И ОстаткиСебестоимостиТоваров.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ПериодикаПартии
		|		ПО ПериодикаПартии.Организация = ДД.Организация
		|		И ПериодикаПартии.Документ = ДД.Партия
		|";
КонецФункции
	
Функция ТекстДвиженияСебестоимостиНДС() // вт ДвиженияСебестоимостиНДС 	
	Возврат "
		|ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства))
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск) И НЕ ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщика)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПеремещениеАвто)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию))
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|
		|		ИНАЧЕ ДД.ТипЗаписи
		|	КОНЕЦ КАК ТипЗаписи,
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК Сторно,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|		 ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|
		|	СУММА(ДД.Количество) КАК Количество,
		|
		|	ДД.ХозяйственнаяОперация,
		|	(ВЫБОР
		|		КОГДА НЕ ПередачаВидыЗапасов.Ссылка ЕСТЬ NULL И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ПередачаВидыЗапасов.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
		|		 И Передача.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
		|		КОГДА НЕ Передача.Ссылка ЕСТЬ NULL И НЕ ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА Передача.НалогообложениеНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС КОНЕЦ) КАК КорВидДеятельностиНДС,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	(ВЫБОР
		|		КОГДА ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|		 И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.СтатьяРасходовСписания
		|		КОГДА ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
		|			ТОГДА ДД.СтатьяАктивовПассивов
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов КАК АналитикаАктивов,
		|	ДД.КорНаправлениеДеятельности,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства))
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение))
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ) КАК ДокументИсточник
		|ПОМЕСТИТЬ ДвиженияСебестоимостиНДС
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями КАК Передача
		|		ПО Передача.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями.ВидыЗапасов КАК ПередачаВидыЗапасов
		|		ПО ПередачаВидыЗапасов.Ссылка = ДД.Регистратор
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.Количество <> 0
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И НЕ ДД.РазделУчета В (
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажи),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажиПереданныеПартнерам),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажиКОформлениюСписания),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки))
		|	И (НЕ ДД.ТипЗаписи В (
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВключениеИсключениеНДСвСтоимости),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов))
		|	)
		|	И НЕ (ДД.Регистратор ССЫЛКА Документ.ПересортицаТоваров И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение))
		|	И НЕ (ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение) И ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением))
		|
		|СГРУППИРОВАТЬ ПО
		|	ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства))
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск) И НЕ ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщика)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПеремещениеАвто)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию))
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|
		|		ИНАЧЕ ДД.ТипЗаписи
		|	КОНЕЦ, // ТипЗаписи
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ), // Сторно
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|		 ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ, // ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|
		|	ДД.ХозяйственнаяОперация,
		|	(ВЫБОР
		|		КОГДА НЕ ПередачаВидыЗапасов.Ссылка ЕСТЬ NULL И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ПередачаВидыЗапасов.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
		|		 И Передача.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
		|		КОГДА НЕ Передача.Ссылка ЕСТЬ NULL И НЕ ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА Передача.НалогообложениеНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС КОНЕЦ), // КорВидДеятельностиНДС
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	(ВЫБОР
		|		КОГДА ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|		 И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.СтатьяРасходовСписания
		|		КОГДА ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
		|			ТОГДА ДД.СтатьяАктивовПассивов
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ), // СтатьяРасходовАктивов
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.КорНаправлениеДеятельности,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства))
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение))
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ) // ДокументИсточник
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор
		|";
КонецФункции

Функция ТекстПрошлыеРеализацииСебестоимость() // вт ПрошлыеРеализацииСебестоимость
	Возврат "
		|ВЫБРАТЬ
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	Прошлые.ВидЗапасов,
		|	Прошлые.АналитикаФинансовогоУчета,
		|	Прошлые.ВидДеятельностиНДС,
		|	СУММА(ДД.Количество) КАК Количество
		|
		|ПОМЕСТИТЬ ПрошлыеРеализацииСебестоимость
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрошлыеРеализацииПартийНДС КАК Прошлые
		|		ПО ДД.Регистратор = Прошлые.ДокументИсточник
		|		И ДД.Организация = Прошлые.Организация
		|		И ДД.РазделУчета = Прошлые.РазделУчета
		|		И ДД.АналитикаУчетаНоменклатуры = Прошлые.АналитикаУчетаНоменклатуры
		|		И (ДД.ВидЗапасов = Прошлые.ВидЗапасов
		|			ИЛИ ДД.ВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка))
		|		И ДД.АналитикаФинансовогоУчета = Прошлые.АналитикаФинансовогоУчета
		|		И ДД.КорВидДеятельностиНДС = Прошлые.ВидДеятельностиНДС
		|СГРУППИРОВАТЬ ПО
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	Прошлые.ВидЗапасов,
		|	Прошлые.АналитикаФинансовогоУчета,
		|	Прошлые.ВидДеятельностиНДС
		|";
КонецФункции

// ... выборки данных

Функция ТекстДетальныеНачальныеОстаткиПартийНДС() // использует ВТНачальныеОстаткиПартийНДС
	Возврат
		"ВЫБРАТЬ
		|	""ТекстДетальныеНачальныеОстаткиПартийНДС"" 	 КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Остаток) КАК ТипЗаписи,
		|	ВЫБОР
		|		КОГДА ДД.Знаменатель < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК Сторно,
		|	0 КАК Приоритет,
		|	ДД.Знаменатель,
		|	0 КАК ЗнаменательДляИсточников,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.Номенклатура,
		|	ДД.НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|
		|	ДД.Количество,
		|	ДД.СтоимостьБезНДС,
		|	ДД.НДС,
		|	ДД.НДСУпр,
		|
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности
		|ИЗ
		|	ВТНачальныеОстаткиПартийНДС КАК ДД
		|";
КонецФункции

Функция ТекстНачальныеОстаткиПартийНДС() // использует ОстаткиТоваров, ОстаткиСебестоимостиТоваров
	Возврат
		"ВЫБРАТЬ
		|	""ТекстНачальныеОстаткиПартийНДС"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОстатокСгруппированный) КАК ТипЗаписи,
		|	ВЫБОР
		|		КОГДА МАКСИМУМ(ДД.Знаменатель) < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК Сторно,
		|	0 КАК Приоритет,
		|	МАКСИМУМ(ДД.Знаменатель),
		|	СУММА(ДД.Знаменатель) КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|
		|	0,
		|	0,
		|	0,
		|	0,
		|
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности
		|ИЗ
		|	ВТНачальныеОстаткиПартийНДС КАК ДД
		|СГРУППИРОВАТЬ ПО
		|	ДД.Сторно,
		|	ДД.Номенклатура,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС
		|";
КонецФункции

Функция ТекстНачальныеОстаткиПартийДляДопРасходов() // использует ОстаткиТоваров, ОстаткиСебестоимостиТоваров
	Возврат
		"ВЫБРАТЬ
		|	""ТекстНачальныеОстаткиПартийДляДопРасходов"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОстатокДляРаспределения) КАК ТипЗаписи,
		|	ВЫБОР
		|		КОГДА МАКСИМУМ(ДД.Знаменатель) < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК Сторно,
		|	0 КАК Приоритет,
		|	МАКСИМУМ(ДД.Знаменатель),
		|	СУММА(ДД.Знаменатель) КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|
		|	0 КАК Количество,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДС,
		|	0 КАК НДСУпр,
		|
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности
		|ИЗ
		|	ВТНачальныеОстаткиПартийНДС КАК ДД
		|ГДЕ
		|	ДД.Количество <> 0
		|СГРУППИРОВАТЬ ПО
		|	ДД.Сторно,
		|	ДД.Номенклатура,
		|	ДД.Период,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС
		|";
КонецФункции

Функция ТекстДетальныеПриходыСебестоимостиТоваров() // использует ПриходыТоваровНДС
	Возврат
		"ВЫБРАТЬ
		|	""ТекстПриходыСебестоимостиТоваров"" КАК ЗапросИсточник,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы)
		|		 И ДД.Партия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии)
		|		ИНАЧЕ ДД.ТипЗаписи КОНЕЦ) КАК ТипЗаписи,
		|	(ВЫБОР
		|		КОГДА НЕ Приходы.Количество ЕСТЬ NULL И Приходы.Количество < 0 ТОГДА ИСТИНА
		|		КОГДА НЕ Остатки.Количество ЕСТЬ NULL И Остатки.Количество < 0 ТОГДА ИСТИНА
		|		КОГДА НЕ ОстаткиСебестоимостиТоваров.Количество ЕСТЬ NULL И ОстаткиСебестоимостиТоваров.Количество < 0
		|			ТОГДА ИСТИНА
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК Сторно,
		|	0 КАК Приоритет,
		|	(ВЫБОР
		|		КОГДА НЕ Приходы.Количество ЕСТЬ NULL ТОГДА Приходы.Количество
		|		КОГДА НЕ Остатки.Количество ЕСТЬ NULL ТОГДА Остатки.Количество
		|		КОГДА НЕ ОстаткиСебестоимостиТоваров.Количество ЕСТЬ NULL ТОГДА ОстаткиСебестоимостиТоваров.Количество
		|		ИНАЧЕ ДД.Количество КОНЕЦ) КАК Знаменатель,
		|	0 КАК ЗнаменательДляИсточников,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.Номенклатура,
		|	ДД.НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|
		|	ДД.Количество,
		|	ДД.СтоимостьБезНДС,
		|	ДД.НДС,
		|	ДД.НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	ДД.ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности
		|ИЗ
		|	ПриходыТоваровНДС КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиТоваров КАК Остатки
		|		ПО ДД.ТипЗаписи В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|		И ДД.Количество = 0
		|		И Остатки.Организация = ДД.Организация
		|		И Остатки.РазделУчета = ДД.РазделУчета
		|		И Остатки.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Остатки.ВидЗапасов = ДД.ВидЗапасов
		|		И Остатки.Партия = ДД.Партия
		|		И Остатки.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Остатки.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|	ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиСебестоимостиТоваров КАК ОстаткиСебестоимостиТоваров
		|		ПО ОстаткиСебестоимостиТоваров.Организация = ДД.Организация
		|		И ОстаткиСебестоимостиТоваров.РазделУчета = ДД.РазделУчета
		|		И ОстаткиСебестоимостиТоваров.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И ОстаткиСебестоимостиТоваров.ВидЗапасов = ДД.ВидЗапасов
		|		И ОстаткиСебестоимостиТоваров.Партия = ДД.Партия
		|		И ОстаткиСебестоимостиТоваров.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И ОстаткиСебестоимостиТоваров.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПриходыТоваров КАК Приходы
		|		ПО ДД.ТипЗаписи В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|		И ДД.Количество = 0
		|		И Приходы.Организация = ДД.Организация
		|		И Приходы.РазделУчета = ДД.РазделУчета
		|		И Приходы.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Приходы.ВидЗапасов = ДД.ВидЗапасов
		|		И Приходы.Партия = ДД.Партия
		|		И Приходы.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Приходы.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|ГДЕ
		|	НЕ (ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|		И ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)))
		|	И (ДД.Количество <> 0
		|		ИЛИ ДД.СтоимостьБезНДС <> 0
		|		ИЛИ ДД.НДС <> 0
		|		ИЛИ ДД.НДСУпр <> 0)
		|";
КонецФункции

Функция ТекстПриходыСебестоимостиТоваров() // использует ПриходыТоваровНДС
	Возврат
		"ВЫБРАТЬ
		|	""ТекстПриходыСебестоимостиТоваров"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПартияСгруппированная) КАК ТипЗаписи,
		|	МАКСИМУМ(ВЫБОР
		|		КОГДА НЕ Приходы.Количество ЕСТЬ NULL И Приходы.Количество < 0 ТОГДА ИСТИНА
		|		КОГДА НЕ Остатки.Количество ЕСТЬ NULL И Остатки.Количество < 0 ТОГДА ИСТИНА
		|		КОГДА НЕ ОстаткиСебестоимостиТоваров.Количество ЕСТЬ NULL И ОстаткиСебестоимостиТоваров.Количество < 0
		|			ТОГДА ИСТИНА
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК Сторно,
		|	0 КАК Приоритет,
		|	МАКСИМУМ(ВЫБОР
		|		КОГДА НЕ Приходы.Количество ЕСТЬ NULL ТОГДА Приходы.Количество
		|		КОГДА НЕ Остатки.Количество ЕСТЬ NULL ТОГДА Остатки.Количество
		|		КОГДА НЕ ОстаткиСебестоимостиТоваров.Количество ЕСТЬ NULL ТОГДА ОстаткиСебестоимостиТоваров.Количество
		|		ИНАЧЕ ДД.Количество КОНЕЦ) КАК Знаменатель,
		|	0 КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	
		|	ЕСТЬNULL(ПериодикаПартии.ДатаРегистратора, &КонецПредыдущегоПериода) КАК Период,
		|	ДД.Партия КАК Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|
		|	0 КАК Количество,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДС,
		|	0 КАК НДСУпр,
		|
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности
		|ИЗ
		|	ПриходыТоваровНДС КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиТоваров КАК Остатки
		|		ПО ДД.ТипЗаписи В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|		И ДД.Количество = 0
		|		И Остатки.Организация = ДД.Организация
		|		И Остатки.РазделУчета = ДД.РазделУчета
		|		И Остатки.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Остатки.ВидЗапасов = ДД.ВидЗапасов
		|		И Остатки.Партия = ДД.Партия
		|		И Остатки.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Остатки.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|	ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиСебестоимостиТоваров КАК ОстаткиСебестоимостиТоваров
		|		ПО ОстаткиСебестоимостиТоваров.Организация = ДД.Организация
		|		И ОстаткиСебестоимостиТоваров.РазделУчета = ДД.РазделУчета
		|		И ОстаткиСебестоимостиТоваров.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И ОстаткиСебестоимостиТоваров.ВидЗапасов = ДД.ВидЗапасов
		|		И ОстаткиСебестоимостиТоваров.Партия = ДД.Партия
		|		И ОстаткиСебестоимостиТоваров.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И ОстаткиСебестоимостиТоваров.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПриходыТоваров КАК Приходы
		|		ПО ДД.ТипЗаписи В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|		И ДД.Количество = 0
		|		И Приходы.Организация = ДД.Организация
		|		И Приходы.РазделУчета = ДД.РазделУчета
		|		И Приходы.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Приходы.ВидЗапасов = ДД.ВидЗапасов
		|		И Приходы.Партия = ДД.Партия
		|		И Приходы.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Приходы.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ПериодикаПартии
		|		ПО ПериодикаПартии.Организация = ДД.Организация
		|		И ПериодикаПартии.Документ = ДД.Партия
		|ГДЕ
		|	НЕ (ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|		И ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)))
		|	И (ДД.Количество <> 0
		|		ИЛИ ДД.СтоимостьБезНДС <> 0
		|		ИЛИ ДД.НДС <> 0
		|		ИЛИ ДД.НДСУпр <> 0)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Номенклатура,
		|	ЕСТЬNULL(ПериодикаПартии.ДатаРегистратора, &КонецПредыдущегоПериода),
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС
		|";
КонецФункции

Функция ТекстДвиженияСебестоимостиТоваров()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстДвиженияСебестоимостиТоваров"" КАК ЗапросИсточник,
		|	ДД.ТипЗаписи,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|		 И Выпуски.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|			ТОГДА ЛОЖЬ
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|		 И Выпуски.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|			ТОГДА ЛОЖЬ
		|			ИНАЧЕ ДД.Сторно
		|		КОНЕЦ) КАК Сторно,
		|	0 КАК Приоритет,
		|	СУММА(ДД.Знаменатель) КАК Знаменатель,
		|	СУММА(ВЫБОР
		|			КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|			 И Выпуски.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|				ТОГДА Выпуски.Знаменатель
		|			КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|			 И Выпуски.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|				ТОГДА Выпуски.Знаменатель
		|			КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|			 И РаботыДляДавальца.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|				ТОГДА РаботыДляДавальца.Знаменатель
		|			КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|			 И РаботыДляДавальца.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|				ТОГДА РаботыДляДавальца.Знаменатель
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|		 И ДД.Партия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути)
		|		 И ДД.Партия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.Партия КОНЕЦ) КАК Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДС,
		|	0 КАК НДСУпр,
		|	ДД.ХозяйственнаяОперация,
		|	(ВЫБОР
		|		КОГДА РаботыДляДавальца.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		 И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА РаботыДляДавальца.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС КОНЕЦ) КАК КорВидДеятельностиНДС,
		|	(ВЫБОР
		|		КОГДА РаботыДляДавальца.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		 И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА РаботыДляДавальца.РазделУчета
		|		ИНАЧЕ ДД.КорРазделУчета КОНЕЦ) КАК КорРазделУчета,
		|	(ВЫБОР
		|		КОГДА РаботыДляДавальца.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		 И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА РаботыДляДавальца.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ ДД.КорАналитикаУчетаНоменклатуры КОНЕЦ) КАК КорАналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		|		КОГДА РаботыДляДавальца.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		 И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА РаботыДляДавальца.ВидЗапасов
		|		ИНАЧЕ ДД.КорВидЗапасов КОНЕЦ) КАК КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|		 И ДД.КорПартия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|		 И ДД.КорПартия = НЕОПРЕДЕЛЕНО
		|		 И Выпуски.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|		 И ДД.КорПартия = НЕОПРЕДЕЛЕНО
		|		 И ДД.Регистратор ССЫЛКА Документ.СборкаТоваров
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути)
		|		 И ДД.КорПартия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.КорПартия КОНЕЦ) КАК КорПартия,
		|	(ВЫБОР
		|		КОГДА РаботыДляДавальца.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		 И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА РаботыДляДавальца.АналитикаФинансовогоУчета
		|		ИНАЧЕ ДД.КорАналитикаФинансовогоУчета КОНЕЦ) КАК КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	ДД.ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	ДД.КорНаправлениеДеятельности
		|ИЗ
		|	ДвиженияСебестоимостиНДС КАК ДД
		|		ЛЕВОЕ СОЕДИНЕНИЕ ДвиженияСебестоимостиНДС КАК Выпуски
		|		ПО ДД.Регистратор = Выпуски.Регистратор
		|			И ДД.КорПартия = Выпуски.Партия
		|			И ДД.КорАналитикаУчетаНоменклатуры = Выпуски.АналитикаУчетаНоменклатуры
		|			И ДД.КорРазделУчета = Выпуски.РазделУчета
		|			И ДД.КорВидЗапасов = Выпуски.ВидЗапасов
		|			И ДД.КорАналитикаФинансовогоУчета = Выпуски.АналитикаФинансовогоУчета
		|			И ДД.КорВидДеятельностиНДС = Выпуски.ВидДеятельностиНДС
		|			И (ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)))
		|			И (Выпуски.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск))
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ ДвиженияСебестоимостиНДС КАК РаботыДляДавальца
		|		ПО ДД.Регистратор = РаботыДляДавальца.Регистратор
		|			И ДД.КорПартия = РаботыДляДавальца.Партия
		|			И ДД.КорАналитикаУчетаНоменклатуры = РаботыДляДавальца.КорАналитикаУчетаНоменклатуры
		|			И ДД.КорВидЗапасов = РаботыДляДавальца.КорВидЗапасов
		|			И (ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)))
		|			И (РаботыДляДавальца.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск))
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.ТипЗаписи,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|		 И Выпуски.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|			ТОГДА ЛОЖЬ
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|		 И Выпуски.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|			ТОГДА ЛОЖЬ
		|			ИНАЧЕ ДД.Сторно
		|		КОНЕЦ),
		|	ДД.Номенклатура,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|		 И ДД.Партия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути)
		|		 И ДД.Партия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.Партия КОНЕЦ),
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.ХозяйственнаяОперация,
		|	(ВЫБОР
		|		КОГДА РаботыДляДавальца.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		 И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА РаботыДляДавальца.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА РаботыДляДавальца.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		 И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА РаботыДляДавальца.РазделУчета
		|		ИНАЧЕ ДД.КорРазделУчета КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА РаботыДляДавальца.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		 И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА РаботыДляДавальца.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ ДД.КорАналитикаУчетаНоменклатуры КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА РаботыДляДавальца.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		 И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА РаботыДляДавальца.ВидЗапасов
		|		ИНАЧЕ ДД.КорВидЗапасов КОНЕЦ),
		|	ДД.КорОрганизация,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|		 И ДД.КорПартия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|		 И ДД.КорПартия = НЕОПРЕДЕЛЕНО
		|		 И Выпуски.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|		 И ДД.КорПартия = НЕОПРЕДЕЛЕНО
		|		 И ДД.Регистратор ССЫЛКА Документ.СборкаТоваров
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути)
		|		 И ДД.КорПартия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.КорПартия КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА РаботыДляДавальца.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		 И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА РаботыДляДавальца.АналитикаФинансовогоУчета
		|		ИНАЧЕ ДД.КорАналитикаФинансовогоУчета КОНЕЦ),
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.ДокументИсточник";
КонецФункции

Функция ТекстДвиженияСебестоимостиТоваровСборка()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстДвиженияСебестоимостиТоваровСборка"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение) КАК ТипЗаписи,
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК Сторно,
		|	0 КАК Приоритет,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	МАКСИМУМ(Приходы.Количество) КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.КорАналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.КорРазделУчета КАК РазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов КАК ВидЗапасов,
		|	ДД.Регистратор КАК Партия,
		|	ДД.КорАналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
		|	ДД.КорВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДС,
		|	0 КАК НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	ДД.КорНаправлениеДеятельности
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПриходыСборокТоваров КАК Приходы
		|		ПО Приходы.Организация = ДД.Организация
		|		И Приходы.РазделУчета = ДД.КорРазделУчета
		|		И Приходы.АналитикаУчетаНоменклатуры = ДД.КорАналитикаУчетаНоменклатуры
		|		И Приходы.Партия = ДД.КорПартия
		|		И Приходы.АналитикаФинансовогоУчета = ДД.КорАналитикаФинансовогоУчета
		|		И Приходы.ВидДеятельностиНДС = ДД.КорВидДеятельностиНДС
		|		И Приходы.Регистратор = ДД.Регистратор
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.Количество <> 0
		|	И ДД.Регистратор ССЫЛКА Документ.СборкаТоваров
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ),
		|	ДД.КорАналитикаУчетаНоменклатуры.Номенклатура,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.КорРазделУчета,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.ХозяйственнаяОперация
		|";
КонецФункции

Функция ТекстВозвратыПрошлыхПериодов()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстВозвратыПрошлыхПериодов"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов) КАК ТипЗаписи,
		|	ИСТИНА КАК Сторно,
		|	0 КАК Приоритет,
		|	-ДД.Количество КАК Знаменатель,
		|	0 КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|
		|	-ДД.Количество,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДС,
		|	0 КАК НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.РазделУчета КАК КорРазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ДД.Организация КАК КорОрганизация,
		|	ДД.Партия КАК КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходовСписания КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	ДД.ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	ДД.КорНаправлениеДеятельности
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.Количество <> 0
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов)
		|";
КонецФункции

Функция ТекстРеализацииПрошлыхМесяцевПартииНДС() // использует ПрошлыеРеализации 
	Возврат
		"ВЫБРАТЬ
		|	""ТекстРеализацииПрошлыхМесяцевПартииНДС"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Прошлое) КАК ТипЗаписи,
		|	ЛОЖЬ КАК Сторно,
		|	0 КАК Приоритет,
		|	ПрошлыеСебестоимость.Количество				КАК Знаменатель,
		|	0 											КАК ЗнаменательДляИсточников,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура 	КАК Номенклатура,
		|	ДД.КорВидДеятельностиНДС 					КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.КорВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|
		|	ДД.Количество,
		|	ДД.СтоимостьБезНДС,
		|	ДД.НДС,
		|	ДД.НДСУпр,
		|
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности
		|ИЗ
		|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрошлыеРеализацииПартийНДС КАК Прошлые
		|		ПО ДД.Регистратор = Прошлые.ДокументИсточник
		|		И ДД.Организация = Прошлые.Организация
		|		И ДД.РазделУчета = Прошлые.РазделУчета
		|		И ДД.АналитикаУчетаНоменклатуры = Прошлые.АналитикаУчетаНоменклатуры
		|		И ДД.ВидЗапасов = Прошлые.ВидЗапасов
		|		И ДД.АналитикаФинансовогоУчета = Прошлые.АналитикаФинансовогоУчета
		|		И ДД.КорВидДеятельностиНДС = Прошлые.ВидДеятельностиНДС
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрошлыеРеализацииСебестоимость КАК ПрошлыеСебестоимость
		|		ПО ДД.Регистратор = ПрошлыеСебестоимость.Регистратор
		|		И ДД.Организация = ПрошлыеСебестоимость.Организация
		|		И ДД.РазделУчета = ПрошлыеСебестоимость.РазделУчета
		|		И ДД.АналитикаУчетаНоменклатуры = ПрошлыеСебестоимость.АналитикаУчетаНоменклатуры
		|		И ДД.ВидЗапасов = ПрошлыеСебестоимость.ВидЗапасов
		|		И ДД.АналитикаФинансовогоУчета = ПрошлыеСебестоимость.АналитикаФинансовогоУчета
		|		И ДД.КорВидДеятельностиНДС = ПрошлыеСебестоимость.ВидДеятельностиНДС
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.Активность
		|	И НЕ (ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|		И ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением))
		|";
КонецФункции

Функция ТекстРеализацииПрошлыхМесяцевПартииНДС21() // использует ПрошлыеРеализации 
	Возврат
		"ВЫБРАТЬ
		|	""ТекстРеализацииПрошлыхМесяцевПартииНДС21"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Прошлое) КАК ТипЗаписи,
		|	ЛОЖЬ КАК Сторно,
		|	0 КАК Приоритет,
		|	Прошлые.Количество							КАК Знаменатель,
		|	0 											КАК ЗнаменательДляИсточников,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.Номенклатура								КАК Номенклатура,
		|	ДД.НалогообложениеНДС						КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	Прошлые.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	Прошлые.Партия,
		|	Прошлые.АналитикаФинансовогоУчета,
		|	ДД.НалогообложениеНДС КАК ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступления,
		|
		|	ДД.Количество,
		|	ДД.СтоимостьБезНДС,
		|	ДД.НДСРегл,
		|	0 КАК НДСУпр,
		|
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрошлыеРеализацииПартийНДС КАК Прошлые
		|		ПО ДД.Регистратор = Прошлые.ДокументИсточник
		|		И ДД.Организация = Прошлые.Организация
		|		И ДД.АналитикаУчетаНоменклатуры = Прошлые.АналитикаУчетаНоменклатуры
		|		И ДД.ВидЗапасов = Прошлые.ВидЗапасов
		|		И (ДД.ДокументПоступления = Прошлые.Партия
		|			ИЛИ Прошлые.Партия = НЕОПРЕДЕЛЕНО)
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.Активность
		|";
КонецФункции

Функция ТекстТаможенныеДекларацииИзменениеВидыДеятельностиНДС()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстТаможенныеДекларацииИзменениеВидыДеятельностиНДС"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВключениеИсключениеНДСВСтоимости) КАК ТипЗаписи,
		|	ЛОЖЬ КАК Сторно,
		|	0 КАК Приоритет,
		|	0 КАК Знаменатель,
		|	0 КАК ЗнаменательДляИсточников,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.Организация В (&ОрганизацииСФИФОСкользящая)
		|			ТОГДА ДД.Партия
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ) КАК Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.КорВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|
		|	ДД.КорАналитикаУчетаПартий КАК АналитикаУчетаПартий,
		|	ДД.Регистратор КАК ДокументПоступления,
		|
		|	0 КАК Количество,
		|	0 КАК СтоимостьБезНДС,
		|	ДД.НДСРегл КАК НДС,
		|	(ВЫБОР
		|		КОГДА &УправленческийУчетОрганизаций ТОГДА ДД.НДСУпр
		|		ИНАЧЕ 0 КОНЕЦ) КАК НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	ДД.ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.ВидДеятельностиНДС <> ДД.КорВидДеятельностиНДС
		|	И ДД.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И (ДД.НДСРегл <> 0 ИЛИ ДД.НДСУпр <> 0)
		|	И ДД.ТипЗаписи В (
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии))
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	""ТекстТаможенныеДекларацииИзменениеВидыДеятельностиНДС"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВключениеИсключениеНДСВСтоимости) КАК ТипЗаписи,
		|	ЛОЖЬ КАК Сторно,
		|	0 КАК Приоритет,
		|	0 КАК Знаменатель,
		|	0 КАК ЗнаменательДляИсточников,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.Организация В (&ОрганизацииСФИФОСкользящая)
		|			ТОГДА ДД.Партия
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ) КАК Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.КорВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|
		|	ДД.КорАналитикаУчетаПартий КАК АналитикаУчетаПартий,
		|	ДД.Регистратор КАК ДокументПоступления,
		|
		|	0 КАК Количество,
		|	0 КАК СтоимостьБезНДС,
		|	ДД.НДСРегл КАК НДС,
		|	(ВЫБОР
		|		КОГДА &УправленческийУчетОрганизаций ТОГДА ДД.НДСУпр
		|		ИНАЧЕ 0 КОНЕЦ) КАК НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.ВидДеятельностиНДС КАК КорВидДеятельностиНДС,
		|	ДД.РазделУчета КАК КорРазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ДД.Организация КАК КорОрганизация,
		|	ДД.Партия КАК КорПартия,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	ДД.ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
		|	ДД.КорНаправлениеДеятельности
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии22)
		|	И ДД.ВидДеятельностиНДС <> ДД.КорВидДеятельностиНДС
		|	И ДД.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И (ДД.НДСРегл <> 0 ИЛИ ДД.НДСУпр <> 0)
		|	И ДД.ТипЗаписи В (
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии))
		|";
КонецФункции

// Заполнение расчетной партии

Процедура ЗаполнитьРасчетнуюПартиюНДС(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход)
	
	СуммовыеРесурсы = Новый Структура("СтоимостьБезНДС, НДС, НДСУпр");
	
	// Заполняем расчетную партию по расходной партии-основании
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	
	//	Заполняем партионную идентификацию в расчетной партии
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход, "ДокументПоступления, АналитикаУчетаПартий, НалогообложениеПартии");
	РасчетнаяПартия.ДокументИсточник = Неопределено;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.Партия) Тогда
		РасчетнаяПартия.Партия = Приход.Партия;
	КонецЕсли;
	
	// Заменим старые аналитики учета партий на новые.
	Если ПараметрыРасчета.РаспределениеПартий.ДополнительныеСвойства.Свойство("АналитикиУчетаПартий") Тогда
		
		НоваяАналитикаУчетаПартий = ПараметрыРасчета.РаспределениеПартий.ДополнительныеСвойства.АналитикиУчетаПартий.Получить(РасчетнаяПартия.АналитикаУчетаПартий);
		
		Если ЗначениеЗаполнено(НоваяАналитикаУчетаПартий) Тогда
			РасчетнаяПартия.АналитикаУчетаПартий = НоваяАналитикаУчетаПартий;
		КонецЕсли;
		
	КонецЕсли;
	
	КорректироватьБазуВРасходе = Ложь;
	
	// Расчетная партия заполняется на наибольшее общее вычитаемое
	Если ((РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Перемещение
	 	  И ТипЗнч(РасчетнаяПартия.Регистратор) = Тип("ДокументСсылка.СборкаТоваров"))
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск) Тогда
		КоличествоСписания = Мин(Расход.Количество, Приход.Знаменатель);
		ЗнаменательСписания = КоличествоСписания;
		ПриходБазис = ?(Приход.Знаменатель <> 0, КоличествоСписания / Приход.Знаменатель, 0);
	ИначеЕсли РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Выпуск Тогда
		КоличествоСписания = Мин(Расход.Знаменатель, Приход.ЗнаменательДляИсточников);
		ЗнаменательСписания = КоличествоСписания;
		ПриходБазис = ?(Приход.ЗнаменательДляИсточников <> 0, КоличествоСписания / Приход.ЗнаменательДляИсточников, 0);
	ИначеЕсли РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПартияСгруппированная
	 И Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Перемещение
	 И ТипЗнч(Приход.Регистратор) = Тип("ДокументСсылка.СборкаТоваров") Тогда
		КоличествоСписания = Мин(Расход.Знаменатель, Приход.ЗнаменательДляИсточников);
		ЗнаменательСписания = КоличествоСписания;
		ПриходБазис = 1;
	ИначеЕсли РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПартияСгруппированная Тогда
		КоличествоСписания = Мин(Расход.Знаменатель, Приход.Знаменатель);
		ЗнаменательСписания = КоличествоСписания;
		ПриходБазис = 1;
	ИначеЕсли Приход.Количество <> 0 Тогда
		КорректироватьБазуВРасходе = Истина;
		КоличествоСписания = Мин(Расход.Количество, Приход.Количество);
		ПриходБазис = ?(Приход.Количество <> 0, КоличествоСписания / Приход.Количество, 0);
		ЗнаменательСписания = Мин(Расход.Знаменатель, ПриходБазис * Приход.Знаменатель);
	Иначе
		КоличествоСписания = Мин(Расход.Знаменатель, Приход.Знаменатель);
		ЗнаменательСписания = КоличествоСписания;
		ПриходБазис = ?(Приход.Знаменатель <> 0, КоличествоСписания / Приход.Знаменатель, 0);
	КонецЕсли;
	Если ПриходБазис = 0 Тогда
		Возврат;
	КонецЕсли;
	
	// Заполняем показатели расчетной партии
	Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Выпуск Тогда
		РасчетнаяПартия.Количество = 0;
	ИначеЕсли РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Перемещение
	 И ТипЗнч(РасчетнаяПартия.Регистратор) = Тип("ДокументСсылка.СборкаТоваров") Тогда
		РасчетнаяПартия.Количество = 0;
	ИначеЕсли РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск Тогда
		РасчетнаяПартия.Количество = Окр(ПриходБазис * Приход.Количество, 3);
	ИначеЕсли РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПартияСгруппированная Тогда
		РасчетнаяПартия.Количество = Приход.Количество;
	Иначе
		РасчетнаяПартия.Количество = Мин(Расход.Количество, Приход.Количество);
	КонецЕсли;
	РасчетнаяПартия.Знаменатель = 0;
	
	Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПартияСгруппированная
	 И Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Перемещение
	 И ТипЗнч(Приход.Регистратор) = Тип("ДокументСсылка.СборкаТоваров") Тогда
	 	РасчетнаяПартия.Знаменатель = Приход.ЗнаменательДляИсточников;
	ИначеЕсли РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПартияСгруппированная Тогда
		РасчетнаяПартия.Знаменатель = Приход.Знаменатель;
	Иначе
		РасчетнаяПартия.Знаменатель = 0;
	КонецЕсли;
	
	Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
		РасчетнаяПартия[ИмяРесурса.Ключ] = Окр(ПриходБазис * Приход[ИмяРесурса.Ключ], 2);
	КонецЦикла;
	
	// Корректируем базу расчета в приходе
	Если НЕ (Приход.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияКлиентуРеглУчет
		И Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Потребление)
	И НЕ (Приход.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства
		И Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Распределение) Тогда
	 
	 	Если НЕ Приход.Сторно И РасчетнаяПартия.Сторно
		 И РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Потребление Тогда
			Знак = -1;
		Иначе
			Знак = 1;
		КонецЕсли;
	 
	    Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Выпуск Тогда
			Приход.Знаменатель = Приход.Знаменатель - Знак * Окр(ПриходБазис * Приход.Знаменатель, 3);
			Приход.Количество = Приход.Количество - Знак * РасчетнаяПартия.Количество;
			Приход.ЗнаменательДляИсточников = Приход.ЗнаменательДляИсточников - Знак * ЗнаменательСписания;
		Иначе
			Приход.Знаменатель = Приход.Знаменатель - Знак * ЗнаменательСписания;
			Приход.Количество = Приход.Количество - Знак * РасчетнаяПартия.Количество;
		КонецЕсли;
		
		Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
			Приход[ИмяРесурса.Ключ] = Приход[ИмяРесурса.Ключ] - Знак * РасчетнаяПартия[ИмяРесурса.Ключ];
		КонецЦикла;
	 	
	КонецЕсли;
	
	// Корректируем базу расчета в расходе
	Если КорректироватьБазуВРасходе Тогда
		
		Расход.Количество = Расход.Количество - РасчетнаяПартия.Количество;
		
		Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
			Расход[ИмяРесурса.Ключ] = Расход[ИмяРесурса.Ключ] - РасчетнаяПартия[ИмяРесурса.Ключ];
		КонецЦикла;
		
	КонецЕсли;
	
	ЗаполнитьСтатьюИАналитикуСписанияНДС(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход);
	
	Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ОстатокДляРаспределения Тогда
		РасчетнаяПартия.Период = Приход.Период;
		РасчетнаяПартия.Регистратор = Приход.Регистратор;
	КонецЕсли; 
	
	// По результатам партионной идентификации определяем завершенность расчета
	Если РасчетнаяПартия.Количество = 0
	 И РасчетнаяПартия.СтоимостьБезНДС = 0
	 И РасчетнаяПартия.НДС = 0
	 И РасчетнаяПартия.НДСУпр = 0 Тогда
		РасчетнаяПартия.РасчетЗавершен = Ложь;
		
	ИначеЕсли ТипЗнч(Приход.Регистратор) = Тип("ДокументСсылка.ВводОстатков") Тогда
		// Для документов ВводОстатков с реквизитом ВводОстатков22 = Ложь в таблице Данные
		// установлен признак РасчетЗавершен = Ложь для того, чтобы движения этого документа не записывались в ИБ,
		// т.к. они уже сформированы самим документом.
		РасчетнаяПартия.РасчетЗавершен = Истина;
	Иначе
		РасчетнаяПартия.РасчетЗавершен = Приход.РасчетЗавершен;
	КонецЕсли;
	
	Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ОстатокДляРаспределения Тогда
		
		РасчетнаяПартияРасход = РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьРасчетнуюПартию(ПараметрыРасчета, РасчетнаяПартия, Ложь);
		РасчетнаяПартияРасход.ВидДвижения = ВидДвиженияНакопления.Расход;
		РасчетнаяПартияРасход.Партия = Неопределено;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьСтатьюИАналитикуСписанияНДС(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход)
	
	Период = НачалоМесяца(РасчетнаяПартия.Период);
	
	ПараметрыУчетнойПолитики = ЗначениеНастроекПовтИсп.ПараметрыУчетнойПолитики(РасчетнаяПартия.Организация, НачалоМесяца(Период));  
	
	Если ПараметрыУчетнойПолитики <> Неопределено
	 И ПараметрыУчетнойПолитики.ВариантУчетаНДСПриИзмененииВидаДеятельности = Перечисления.ВариантыУчетаНДСПриИзмененииВидаДеятельностиНаНеоблагаемую.ВключатьВСтоимость Тогда
		Возврат;
	КонецЕсли;
	
	Если УчетНДСУП.ВозможноСписаниеНДС(РасчетнаяПартия.ВидДеятельностиНДС, РасчетнаяПартия.КорВидДеятельностиНДС)
	 ИЛИ (РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Приход
	  И УчетНДСУП.ВозможноСписаниеНДС(Приход.ВидДеятельностиНДС, Приход.КорВидДеятельностиНДС)) Тогда
	
		Если ПараметрыУчетнойПолитики <> Неопределено
		 И ПараметрыУчетнойПолитики.ВариантУчетаНДСПриИзмененииВидаДеятельности = Перечисления.ВариантыУчетаНДСПриИзмененииВидаДеятельностиНаНеоблагаемую.ВключатьВСтоимостьИлиРасходыВЗависимостиОтПериода Тогда
			
			Если ЗначениеЗаполнено(РасчетнаяПартия.ДокументПоступления) Тогда
				ДатаПартии = НачалоМесяца(ОбщегоНазначения.ЗначениеРеквизитаОбъекта(РасчетнаяПартия.ДокументПоступления, "Дата"));
			Иначе
				ДатаПартии = Дата(1,1,1);
			КонецЕсли;
			
			Если ДатаПартии = Период Тогда
				Возврат;
			КонецЕсли;
			
		КонецЕсли;
		
		Если ПараметрыУчетнойПолитики <> Неопределено
		 И УчетНДСУП.ВозможноСписаниеНДС(РасчетнаяПартия.ВидДеятельностиНДС, РасчетнаяПартия.КорВидДеятельностиНДС) Тогда
			
			Если РасчетнаяПартия.КорВидДеятельностиНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС Тогда
				РасчетнаяПартия.СтатьяСписанияНДС 	 = ПараметрыУчетнойПолитики.СтатьяРасходовНеНДС;
				РасчетнаяПартия.АналитикаСписанияНДС = ПараметрыУчетнойПолитики.АналитикаРасходовНеНДС;
			Иначе
				РасчетнаяПартия.СтатьяСписанияНДС 	 = ПараметрыУчетнойПолитики.СтатьяРасходовЕНВД;
				РасчетнаяПартия.АналитикаСписанияНДС = ПараметрыУчетнойПолитики.АналитикаРасходовЕНВД;
			КонецЕсли;
			
		Иначе
			
			РасчетнаяПартия.НДС    = 0;
			РасчетнаяПартия.НДСУпр = 0;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ПроцедурыЭтапа_РасчетПартийНДС2_4

// Инициализация данных

Функция ПоляПотребленийПартииНДС2_4(ПараметрыРасчета)
	
	Возврат "Организация, ВидДеятельностиНДС, НаправлениеДеятельности, Партия, АналитикаУчетаПартий";
	
КонецФункции

Функция ОписаниеЦепочекПартийНДС2_4(ПараметрыРасчета, ОписаниеЦепочек = Неопределено) Экспорт
	
	Если ОписаниеЦепочек = Неопределено Тогда
		ОписаниеЦепочек = Новый Соответствие;
		РасчетПоПартиямПрочихРасходов = Ложь;
	Иначе
		РасчетПоПартиямПрочихРасходов = Истина;
	КонецЕсли;
	
	ПоляСвязи 							  = ПоляПотребленийПартииНДС2_4(ПараметрыРасчета);
	ПоляСвязиСРегистратором 			  = ПоляСвязи + ", Регистратор";
	ПоляСвязиСДокументомИсточником 		  = ПоляСвязи + ", ДокументИсточник";
	КорПоляСвязиСРегистратором 			  = "Организация,    КорВидДеятельностиНДС, КорНаправлениеДеятельности, КорПартия, КорАналитикаУчетаПартий, Регистратор"; // порядок как в ПоляПотребленийПартииНДС2_4()
	КорПоляСвязиСДокументомИсточником 	  = "Организация,    КорВидДеятельностиНДС, КорНаправлениеДеятельности, КорПартия, КорАналитикаУчетаПартий, ДокументИсточник"; // порядок как в ПоляПотребленийПартииНДС2_4()
	КорПоляСвязиОбособленноСРегистратором = "КорОрганизация, КорВидДеятельностиНДС, КорНаправлениеДеятельности, КорПартия, КорАналитикаУчетаПартий, Регистратор"; // порядок как в ПоляПотребленийПартииНДС2_4()
	ПоляСвязиСторно						  = "Организация, Партия, АналитикаУчетаПартий, ДокументИсточник";
	КорПоляСвязиСторно					  = "Организация, Партия, АналитикаУчетаПартий, Регистратор";
	
	#Область ОстатокСгруппированный
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.Остаток);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ДопРасходы);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ДопРасходыБезПартии);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ДопРасходыСПартией);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.КорректировкаСтоимости);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ОтклонениеВСтоимости);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный,
		ПоляСвязиСРегистратором,
		Источники,
		ПоляСвязиСДокументомИсточником);
	
	#КонецОбласти
	
	#Область ПартияСгруппированная
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.Партия);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ДопРасходы);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ДопРасходыБезПартии);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ДопРасходыСПартией);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.КорректировкаСтоимости);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ОтклонениеВСтоимости);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПартияСгруппированная,
		ПоляСвязиСРегистратором,
		Источники,
		ПоляСвязиСДокументомИсточником);
	
	#КонецОбласти
	
	#Область Потребление
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ПартияСгруппированная);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.Перемещение);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ПеремещениеАвто);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.Сторно);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ВозвратПрошлыхПериодов);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.Выпуск);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.БазаРегл);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.БазаУпр);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ВозвратБезДокументаИсточника);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Потребление,
		ПоляСвязи,
		Источники);
	
	#КонецОбласти
	
	#Область ПотреблениеАвто
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ПартияСгруппированная);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.Перемещение);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.Сторно);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.БазаРегл);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.БазаУпр);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПотреблениеАвто,
		ПоляСвязи,
		Источники);
		
	#КонецОбласти
	
	#Область КорректировкаПриобретения
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ПартияСгруппированная);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ВозвратПрошлыхПериодов);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.КорректировкаПриобретения,
		ПоляСвязи,
		Источники);
	
	#КонецОбласти
	
	#Область ВозвратНаДругойСклад
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.СторноВозвратНаДругойСклад);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ВозвратНаДругойСклад,
		ПоляСвязиСРегистратором,
		Источники);
	
	#КонецОбласти
	
	#Область Распределение
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.Перемещение);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ВозвратПрошлыхПериодов);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ПартияСгруппированная);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.Выпуск);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.БазаРегл);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.БазаУпр);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Распределение,
		ПоляСвязи,
		Источники);
	
	#КонецОбласти
	
	#Область Перемещение
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.Потребление);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ПотреблениеАвто);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ВозвратНаДругойСклад);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Перемещение,
		ПоляСвязиСРегистратором,
		Источники,
		КорПоляСвязиСРегистратором);
	
	#КонецОбласти
	
	#Область ПеремещениеОбособленно
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.Потребление);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно,
		ПоляСвязиСРегистратором,
		Источники,
		КорПоляСвязиОбособленноСРегистратором);
	
	#КонецОбласти
	
	#Область ПеремещениеАвто
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.Потребление);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ПотреблениеАвто);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.Распределение);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПеремещениеАвто,
		ПоляСвязиСРегистратором,
		Источники,
		КорПоляСвязиСРегистратором);
	
	#КонецОбласти
	
	#Область СписанияНаВыпуск
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.Перемещение);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ПеремещениеАвто);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ПартияСгруппированная);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.Выпуск);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск,
		ПоляСвязи,
		Источники);
	
	#КонецОбласти
	
	#Область СписанияНаВыпускПостатейные
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.БазаРегл);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.БазаУпр);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.СписанияНаВыпускПостатейные,
		ПоляСвязи + ", СтатьяРасходовАктивов",
		Источники);
	
	#КонецОбласти
	
	#Область Выпуск
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.СписанияНаВыпускПостатейные);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Выпуск,
		ПоляСвязиСРегистратором,
		Источники,
		КорПоляСвязиСРегистратором);
	
	#КонецОбласти
	
	#Область СписаниеНаРасходы
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ПартияСгруппированная);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.СписаниеНаРасходы,
		ПоляСвязиСРегистратором,
		Источники);
	
	#КонецОбласти
	
	#Область ПотреблениеПроизводство
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ПартияСгруппированная);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.Перемещение);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ПеремещениеОбособленно);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.БазаРегл);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.БазаУпр);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ПотреблениеПроизводство,
		ПоляСвязи,
		Источники);
	
	#КонецОбласти
	
	#Область ВозвратПрошлыхПериодов
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.Прошлое);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ВозвратПрошлыхПериодов,
		КорПоляСвязиСДокументомИсточником,
		Источники,
		ПоляСвязиСРегистратором);
	
	#КонецОбласти

	#Область Сторно
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.Потребление);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ПотреблениеАвто);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.Прошлое);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.Сторно,
		ПоляСвязиСторно,
		Источники,
		КорПоляСвязиСторно);
	
	#КонецОбласти
	
	#Область СторноВозвратНаДругойСклад
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.Потребление);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.ПотреблениеАвто);
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.Прошлое);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.СторноВозвратНаДругойСклад,
		ПоляСвязиСторно,
		Источники,
		КорПоляСвязиСторно);
	
	#КонецОбласти

	#Область ВозвратБезДокументаИсточника
	
	Источники = Новый Соответствие;
	Источники.Вставить(Перечисления.ТипыЗаписейПартий.Потребление);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеПриемника(
		ОписаниеЦепочек,
		Перечисления.ТипыЗаписейПартий.ВозвратБезДокументаИсточника,
		ПоляСвязи,
		Источники,
		ПоляСвязи);
	
	#КонецОбласти

	#Область Дополнение_ОтклонениеВСтоимости_РаспределениеПоВыбывшимТоварам_ПеремещениеУпр
	
	Если НЕ РасчетПоПартиямПрочихРасходов Тогда
		
		// Без источников - для формирования записей по данным запроса
		// Эти же типы записей указываются в отборе запроса ТекстДвиженияСебестоимостиТоваров2_4()
		РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеДополнения(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.Дополнение);
		РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеДополнения(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ВключениеИсключениеНДСВСтоимости);
		РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеДополнения(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ОтклонениеВСтоимости);
		РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеДополнения(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам);
		РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьОписаниеДополнения(ОписаниеЦепочек, Перечисления.ТипыЗаписейПартий.ПеремещениеУпр);
		
	КонецЕсли;
	
	#КонецОбласти
	
	Возврат ОписаниеЦепочек;
	
КонецФункции

Функция ОписаниеДвиженийПартийНДС2_4(ПараметрыРасчета)
	
	КолонкиТаблицыРаспределения = ТаблицаДляРаспределенияПартийНДС2_4(ПараметрыРасчета).Колонки;
	
	ОписаниеДвижений = РасчетСебестоимостиПрикладныеАлгоритмы.ОписаниеДвижений();
	ОписаниеДвижений.Вставить("Контекст", "ПодготовкаДанныхДляУчетаНДСиУСН2_4");
	ОписаниеДвижений.Вставить("ИмяРегистра", Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН2_4.Имя);
	ОписаниеДвижений.Вставить("ПоляРасчета", РасчетСебестоимостиПрикладныеАлгоритмы.ПереченьПолей(КолонкиТаблицыРаспределения));
	ОписаниеДвижений.Вставить("КлючиСравнения",	ПоляПотребленийПартииНДС2_4(ПараметрыРасчета));
	ОписаниеДвижений.Вставить("Показатели", "Знаменатель, ЗнаменательДляИсточников, СтоимостьБезНДС, НДС, СтоимостьБезНДСУпр, НДСУпр");
	ОписаниеДвижений.Вставить("БазисПрихода", "Знаменатель");
	ОписаниеДвижений.Вставить("БазисРасхода", "Знаменатель");
	ОписаниеДвижений.Вставить("КлючРасхода", "ДокументИсточник");
	ОписаниеДвижений.Вставить("ПолеПорядка", "ПериодПоступления");
	ОписаниеДвижений.Вставить("ПоляСортировки", "Партия");
	ОписаниеДвижений.Вставить("СортировкаПоУсловию", Истина);
	
	ОписаниеДвижений.Вставить("ПоляСуммирования", "СтоимостьБезНДС, НДС, СтоимостьБезНДСУпр, НДСУпр");
	ОписаниеДвижений.Вставить("ПоляГруппировки",  
		РасчетСебестоимостиПрикладныеАлгоритмы.ПереченьПолей(КолонкиТаблицыРаспределения, ОписаниеДвижений.ПоляСуммирования));
	ОписаниеДвижений.Вставить("ЕстьСторно", Истина);
	ОписаниеДвижений.Вставить("УменьшатьБазис", Истина);
	ОписаниеДвижений.Вставить("УдалятьСтрокиБезИсточников", Истина);
	
	ОписаниеДвижений.Вставить("ВременныеТаблицыДляСледующихЭтапов",
		"ВТНачальныеОстаткиПартийНДС, ПриходыТоваровНДС2_4, ДвиженияСебестоимостиНДС2_4, ЗнаменателиПриходов");
	
	Возврат ОписаниеДвижений;
	
КонецФункции

Функция ОписаниеНезаписываемыхПартийНДС2_4(ПараметрыРасчета, НезаписываемыеТипыЗаписей = Неопределено)
	
	Если НезаписываемыеТипыЗаписей = Неопределено Тогда
		НезаписываемыеТипыЗаписей = Новый Соответствие;
	КонецЕсли;
	
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.Остаток,   Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.Прошлое,   Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный, Истина);
	НезаписываемыеТипыЗаписей.Вставить(Перечисления.ТипыЗаписейПартий.ПартияСгруппированная, Истина);
	
	Возврат РасчетСебестоимостиПрикладныеАлгоритмы.ОписаниеНезаписываемыхДанных(Ложь, НезаписываемыеТипыЗаписей);
	
КонецФункции

Функция ТаблицаДляРаспределенияПартийНДС2_4(ПараметрыРасчета)
	
	Возврат РасчетСебестоимостиПрикладныеАлгоритмы.ТаблицаДляРаспределенияПартий(ПараметрыРасчета,	ТекстОписаниеДанныхДляПартийНДСиУСН2_4());
	
КонецФункции

// Выборка данных

Процедура ПолучитьДанныеДляПартийНДС2_4(ПараметрыРасчета)
	
	ДопПараметры = Новый Структура;
	ДопПараметры.Вставить("РасчетПоПартиямПрочихРасходов", Ложь);
	
	ПараметрыНумерации = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		"ДокументПоступления", // разделитель
		"Знаменатель, СтоимостьБезНДС, НДС, СтоимостьБезНДСУпр, НДСУпр", // ресурсы
		"Период, Приоритет ВОЗР, Организация, Партия, АналитикаУчетаПартий, Регистратор"); // порядок
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьДанныеЭтапаРасчета(
		ПараметрыРасчета,
		ТекстЗапросаДляПартийНДС2_4(ПараметрыРасчета),
		ПараметрыНумерации,
		ДопПараметры);
	
	СкорректироватьАналитикиУчетаПартийДляПартийНДС2_4(ПараметрыРасчета);
	
КонецПроцедуры

Процедура СкорректироватьАналитикиУчетаПартийДляПартийНДС2_4(ПараметрыРасчета)
	
	ТекстЗапроса = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.АналитикаУчетаДокументаПоступления КАК АналитикаУчетаПартий
	|ИЗ
	|	Данные КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий
	|ИЗ
	|	Данные КАК Т";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.СкорректироватьАналитикиУчетаПартийПриРасчете(ПараметрыРасчета, ТекстЗапроса);
	
КонецПроцедуры


// Тексты запросов

// ... общий

Функция ТекстЗапросаДляПартийНДС2_4(ПараметрыРасчета = Неопределено) Экспорт
	
	ТекстЗапроса = ""
		// подготовка временных таблиц
		+ ТекстИнициализацияПартийНДС2_4()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВПакете()
		// выборка данных
		+ ТекстОписаниеДанныхДляПартийНДСиУСН2_4() //вт Данные
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстДетальныеНачальныеОстаткиПартийНДС2_4()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстНачальныеОстаткиПартийНДС2_4()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстДетальныеПриходыСебестоимостиТоваров2_4() // использует ПриходыТоваровНДС2_4
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстПриходыСебестоимостиТоваров2_4()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстДвиженияСебестоимостиТоваров2_4()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстДвиженияСебестоимостиТоваровСборка2_4()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстВозвратыПрошлыхПериодов2_4()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстРеализацииПрошлыхМесяцевПартииНДС2_2()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстРеализацииПрошлыхМесяцевПартииНДС2_4()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстРеализацииПрошлыхМесяцевПартииНДС21_2_4()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстТаможенныеДекларацииИзменениеВидыДеятельностиНДС2_4()
		+ "";
		
	Возврат ТекстЗапроса;
	
КонецФункции

// ... описания данных

Функция ТекстОписаниеДанныхДляПартийНДСиУСН2_4() Экспорт
	Возврат
		"ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80)) 								 КАК ЗапросИсточник,
		|	ДД.ТипЗаписи 												 КАК ТипЗаписи,
		|	ЛОЖЬ														 КАК Сторно,
		|	0 															 КАК Приоритет,
		|	0 															 КАК Знаменатель,
		|	0 															 КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ 														 КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) 				 КАК Номенклатура,
		|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
		|	
		|	ДД.Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) 				      КАК ВидЗапасов,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаДокументаПоступления,
		|	ДД.НаправлениеДеятельности,
		|
		|
		|	ДД.СтоимостьБезНДС,
		|	ДД.НДС,
		|	ДД.СтоимостьБезНДСУпр,
		|	ДД.НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.Организация КАК КорОрганизация,
		|	ДД.Партия КАК КорПартия,
		|	ДД.АналитикаУчетаПартий КАК КорАналитикаУчетаПартий,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.Подразделение,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	ДД.ДокументИсточник,
		|	ДД.СтатьяСписанияНДС,
		|	ДД.АналитикаСписанияНДС
		|//ВоВременнуюТаблицу
		|ИЗ
		|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН2_4 КАК ДД
		|";
КонецФункции

// ... формирования временные таблиц

Функция ТекстИнициализацияПартийНДС2_4()
	Возврат
		"ВЫБРАТЬ
		|	ИСТИНА КАК ЕстьЗаписи
		|ПОМЕСТИТЬ ВыполнятьРаспределениеПартийНДС2_4
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	Цены.Цена КАК Цена
		|ПОМЕСТИТЬ ВТПлановыеЦены
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Ключи
		|		ПО ДД.АналитикаУчетаНоменклатуры = Ключи.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&КонецПериода, ВидЦены = &ВидПлановыхЦен) КАК Цены
		|		ПО Цены.Номенклатура   = Ключи.Номенклатура
		|		 И Цены.Характеристика = Ключи.Характеристика
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
		|	И ЕСТЬNULL(Цены.Цена, 0) <> 0
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.РазделУчета,
		|	ДД.СтоимостьРегл
		|ПОМЕСТИТЬ ВТРасчетныеЦены
		|ИЗ
		|	ВТСтоимостьПартийТоваров КАК ДД
		|ГДЕ
		|	ДД.СтоимостьРегл <> 0
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.РазделУчета,
		|	ВЫРАЗИТЬ(ДД.СтоимостьРегл / ДД.Количество КАК ЧИСЛО(31,2)) КАК СтоимостьРегл
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТСтоимостьПартийТоваров КАК Цены
		|		ПО Цены.Организация = ДД.Организация
		|		И Цены.Партия = ДД.Партия
		|		И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|		И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|		И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Цены.ВидЗапасов = ДД.ВидЗапасов
		|		И Цены.РазделУчета = ДД.РазделУчета
		|	
		|ГДЕ
		|	ДД.Регистратор = ДД.Партия
		|	И ДД.Количество <> 0
		|	И (Цены.Организация ЕСТЬ NULL
		|		ИЛИ Цены.СтоимостьРегл = 0)
		|	И ВЫРАЗИТЬ(ДД.СтоимостьРегл / ДД.Количество КАК ЧИСЛО(31,2)) <> 0
		|	И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ВЫРАЗИТЬ(ДД.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Номенклатура КАК Номенклатура,
		|	ВЫРАЗИТЬ(ДД.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Характеристика КАК Характеристика,
		|	СУММА(ДД.Знаменатель) КАК Знаменатель
		|ПОМЕСТИТЬ ВТЗнаменателиПоНоменклатуре
		|ИЗ
		|	(ВЫБРАТЬ
		|		ДД.РазделУчета,
		|		ДД.Организация,
		|		ДД.Партия,
		|		ДД.АналитикаУчетаПартий,
		|		ДД.АналитикаФинансовогоУчета,
		|		ДД.ВидДеятельностиНДС,
		|		ДД.АналитикаУчетаНоменклатуры,
		|		ДД.ВидЗапасов,
		|		ВЫРАЗИТЬ(ДД.Количество
		|			* ЕСТЬNULL(Цены.СтоимостьРегл, ЕСТЬNULL(ПлановыеЦены.Цена, 0)) КАК ЧИСЛО(31,2)) КАК Знаменатель
		|	ИЗ
		|		ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТРасчетныеЦены КАК Цены
		|			ПО Цены.Организация = ДД.Организация
		|			И Цены.Партия = ДД.Партия
		|			И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|			И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|			И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|			И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|			И Цены.ВидЗапасов = ДД.ВидЗапасов
		|			И Цены.РазделУчета = ДД.РазделУчета
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТПлановыеЦены КАК ПлановыеЦены
		|			ПО ПлановыеЦены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|	ГДЕ
		|		ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|		И ДД.СлужебноеВидДвиженияПриход
		|		И ДД.ТипЗаписи В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
		|		И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		|	ВЫБРАТЬ
		|		ДД.РазделУчета,
		|		ДД.Организация,
		|		ДД.Партия,
		|		ДД.АналитикаУчетаПартий,
		|		ДД.АналитикаФинансовогоУчета,
		|		ДД.ВидДеятельностиНДС,
		|		ДД.АналитикаУчетаНоменклатуры,
		|		ДД.ВидЗапасов,
		|		ВЫРАЗИТЬ(ДД.КоличествоОстаток
		|			* ЕСТЬNULL(Цены.СтоимостьРегл, ЕСТЬNULL(ПлановыеЦены.Цена, 0)) КАК ЧИСЛО(31,2)) КАК Знаменатель
		|	ИЗ
		|		РегистрНакопления.СебестоимостьТоваров.Остатки(&ГраницаКонецПредыдущегоПериода,
		|			Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|			И РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)) КАК ДД
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТРасчетныеЦены КАК Цены
		|			ПО Цены.Организация = ДД.Организация
		|			И Цены.Партия = ДД.Партия
		|			И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|			И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|			И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|			И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|			И Цены.ВидЗапасов = ДД.ВидЗапасов
		|			И Цены.РазделУчета = ДД.РазделУчета
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТПлановыеЦены КАК ПлановыеЦены
		|			ПО ПлановыеЦены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|	) КАК ДД
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ВЫРАЗИТЬ(ДД.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Номенклатура,
		|	ВЫРАЗИТЬ(ДД.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Характеристика
		|ИМЕЮЩИЕ
		|	СУММА(ДД.Знаменатель) > 0
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.Партия,
		|	ЕСТЬNULL(АналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)) КАК АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	ДД.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
		|	СУММА(ВЫБОР КОГДА ДД.СтоимостьРеглОстаток <> 0
		|			ТОГДА ДД.СтоимостьРеглОстаток
		|			ИНАЧЕ ВЫРАЗИТЬ(ДД.КоличествоОстаток * ЕСТЬNULL(ПлановыеЦены.Цена, 0) КАК ЧИСЛО(31,2))
		|		  КОНЕЦ) КАК Знаменатель
		|ПОМЕСТИТЬ ОстаткиСебестоимостиТоваровДетально2_4
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Остатки(&ГраницаКонецПредыдущегоПериода,
		|		Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|		И РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)) КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОтборАналитикиУчетаПартийНДС2_4 КАК АналитикиУчетаПартий
		|		ПО ДД.АналитикаУчетаПартий = АналитикиУчетаПартий.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТПлановыеЦены КАК ПлановыеЦены
		|		ПО ПлановыеЦены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|ГДЕ
		|	ДД.КоличествоОстаток > 0
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.Партия,
		|	ЕСТЬNULL(АналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)),
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура,
		|	ДД.АналитикаУчетаНоменклатуры.Характеристика
		|	
		|ИМЕЮЩИЕ
		|	СУММА(ВЫБОР КОГДА ДД.СтоимостьРеглОстаток <> 0
		|			ТОГДА ДД.СтоимостьРеглОстаток
		|			ИНАЧЕ ВЫРАЗИТЬ(ДД.КоличествоОстаток * ЕСТЬNULL(ПлановыеЦены.Цена, 0) КАК ЧИСЛО(31,2))
		|		  КОНЕЦ) <> 0
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	СУММА(ДД.Знаменатель) КАК Знаменатель
		|ПОМЕСТИТЬ ОстаткиСебестоимостиТоваров2_4
		|ИЗ
		|	ОстаткиСебестоимостиТоваровДетально2_4 КАК ДД
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС
		|
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Регистратор КАК Регистратор,
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	ДД.РазделУчета КАК РазделУчета,
		|	ДД.ВидЗапасов КАК ВидЗапасов,
		|	ДД.Организация КАК Организация,
		|	ДД.Партия КАК Партия,
		|	ДД.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
		|	ДД.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ДД.ЭтоДопРасходы КАК ЭтоДопРасходы,
		|	СУММА(ДД.ЗнаменательПриход) КАК Знаменатель,
		|	СУММА(ДД.ЗнаменательРасход) КАК ЗнаменательДляИсточников
		|ПОМЕСТИТЬ ЗнаменателиПриходов
		|ИЗ
		|	(ВЫБРАТЬ
		|		ДД.Регистратор КАК Регистратор,
		|		ЛОЖЬ КАК ЭтоДопРасходы,
		|		ИСТИНА КАК ЕстьПриход,
		|		ЛОЖЬ КАК ЕстьРасход,
		|		ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|		ДД.РазделУчета КАК РазделУчета,
		|		ДД.ВидЗапасов КАК ВидЗапасов,
		|		ДД.Организация КАК Организация,
		|		ДД.Партия КАК Партия,
		|		ДД.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
		|		ДД.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
		|		ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|		СУММА(ВЫРАЗИТЬ(ДД.Количество
		|			* ЕСТЬNULL(Цены.СтоимостьРегл, ЕСТЬNULL(ПлановыеЦены.Цена, 0)) КАК ЧИСЛО(31,2))) КАК ЗнаменательПриход,
		|		0 КАК ЗнаменательРасход
		|	ИЗ
		|		ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТРасчетныеЦены КАК Цены
		|			ПО Цены.Организация = ДД.Организация
		|			И Цены.Партия = ДД.Партия
		|			И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|			И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|			И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|			И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|			И Цены.ВидЗапасов = ДД.ВидЗапасов
		|			И Цены.РазделУчета = ДД.РазделУчета
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТПлановыеЦены КАК ПлановыеЦены
		|			ПО ПлановыеЦены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|	ГДЕ
		|		ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|		И ДД.СлужебноеВидДвиженияПриход
		|		И НЕ ДД.ТипЗаписи В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией))
		|		И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
		|	СГРУППИРОВАТЬ ПО
		|		ДД.Регистратор,
		|		ДД.АналитикаУчетаНоменклатуры,
		|		ДД.РазделУчета,
		|		ДД.ВидЗапасов,
		|		ДД.Организация,
		|		ДД.Партия,
		|		ДД.АналитикаУчетаПартий,
		|		ДД.АналитикаФинансовогоУчета,
		|		ДД.ВидДеятельностиНДС
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		ДД.Регистратор КАК Регистратор,
		|		ИСТИНА КАК ЭтоДопРасходы,
		|		ИСТИНА КАК ЕстьПриход,
		|		ЛОЖЬ КАК ЕстьРасход,
		|		ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|		ДД.РазделУчета КАК РазделУчета,
		|		ДД.ВидЗапасов КАК ВидЗапасов,
		|		ДД.Организация КАК Организация,
		|		ДД.Партия КАК Партия,
		|		ДД.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
		|		ДД.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
		|		ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|		МАКСИМУМ(ЕСТЬNULL(Знаменатели.Знаменатель, 0)) КАК ЗнаменательПриход,
		|		0 КАК ЗнаменательРасход
		|	ИЗ
		|		ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТЗнаменателиПоНоменклатуре КАК Знаменатели
		|			ПО Знаменатели.Организация = ДД.Организация
		|			И Знаменатели.Партия = ДД.Партия
		|			И Знаменатели.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|			И Знаменатели.Номенклатура = ДД.АналитикаУчетаНоменклатуры.Номенклатура
		|			И Знаменатели.Характеристика = ДД.АналитикаУчетаНоменклатуры.Характеристика
		|	ГДЕ
		|		ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|		И ДД.СлужебноеВидДвиженияПриход
		|		И ДД.ТипЗаписи В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией))
		|		И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
		|	СГРУППИРОВАТЬ ПО
		|		ДД.Регистратор,
		|		ДД.АналитикаУчетаНоменклатуры,
		|		ДД.РазделУчета,
		|		ДД.ВидЗапасов,
		|		ДД.Организация,
		|		ДД.Партия,
		|		ДД.АналитикаУчетаПартий,
		|		ДД.АналитикаФинансовогоУчета,
		|		ДД.ВидДеятельностиНДС
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		ДД.Регистратор,
		|		ЛОЖЬ,
		|		ЛОЖЬ,
		|		ИСТИНА,
		|		ДД.КорАналитикаУчетаНоменклатуры,
		|		ДД.КорРазделУчета,
		|		ДД.КорВидЗапасов,
		|		ДД.Организация,
		|		ДД.КорПартия,
		|		ДД.КорАналитикаУчетаПартий,
		|		ДД.КорАналитикаФинансовогоУчета,
		|		ДД.КорВидДеятельностиНДС,
		|		0,
		|		ВЫРАЗИТЬ(ДД.Количество * ЕСТЬNULL(Цены.СтоимостьРегл, ЕСТЬNULL(ПлановыеЦены.Цена, 0)) КАК ЧИСЛО(31,2))
		|	ИЗ
		|		ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТРасчетныеЦены КАК Цены
		|			ПО Цены.Организация = ДД.Организация
		|			И Цены.Партия = ДД.Партия
		|			И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|			И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|			И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|			И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|			И Цены.ВидЗапасов = ДД.ВидЗапасов
		|			И Цены.РазделУчета = ДД.РазделУчета
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТПлановыеЦены КАК ПлановыеЦены
		|			ПО ПлановыеЦены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|	ГДЕ
		|		ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|		И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
		|		И НЕ ДД.СлужебноеВидДвиженияПриход
		|		И (ДД.КорОрганизация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
		|			ИЛИ ДД.КорОрганизация = ДД.Организация)
		|	) КАК ДД
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Регистратор,
		|	ДД.ЭтоДопРасходы,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.РазделУчета,
		|	ДД.ВидЗапасов,
		|	ДД.Организация,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС
		|
		|ИМЕЮЩИЕ
		|	МАКСИМУМ(ДД.ЕстьПриход) = ИСТИНА
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
		|	СУММА(ДД.ДопРасходыРегл)	КАК ДопРасходыРегл,
		|	СУММА(ДД.ДопРасходыУпр)		КАК ДопРасходыУпр,
		|	СУММА(ДД.НДСРегл)			КАК НДСРегл,
		|	СУММА(ДД.НДСУпр)			КАК НДСУпр
		|ПОМЕСТИТЬ СписаниеОтклоненийВСтоимости2_4
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
		|	И НЕ ДД.СлужебноеВидДвиженияПриход
		|	И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.ДокументИсточник,
		|	ДД.Организация,
		|	ВЫБОР
		|		КОГДА ДД.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		|			ТОГДА ДД.РазделУчета
		|		ИНАЧЕ ДД.КорРазделУчета
		|	КОНЕЦ КАК РазделУчета,
		|	ВЫБОР
		|		КОГДА ДД.КорАналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ ДД.КорАналитикаУчетаНоменклатуры
		|	КОНЕЦ КАК АналитикаУчетаНоменклатуры,
		|	ВЫБОР
		|		КОГДА ДД.КорВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|			ТОГДА ДД.ВидЗапасов
		|		ИНАЧЕ ДД.КорВидЗапасов
		|	КОНЕЦ КАК ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.АналитикаФинансовогоУчета,
		|	ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС
		|	КОНЕЦ КАК ВидДеятельностиНДС,
		|	СУММА(ВЫБОР
		|			КОГДА ЕСТЬNULL(Знаменатели.Знаменатель, 0) <> 0
		|				ТОГДА Знаменатели.Знаменатель
		|				ИНАЧЕ ВЫРАЗИТЬ(ДД.Количество * ЕСТЬNULL(Цены.СтоимостьРегл, ЕСТЬNULL(ПлановыеЦены.Цена, 0)) КАК ЧИСЛО(31,2))
		|		  КОНЕЦ) КАК Знаменатель,
		|	СУММА(ЕСТЬNULL(Знаменатели.ЗнаменательДляИсточников, 0)) КАК ЗнаменательДляИсточников,
		|	СУММА(ДД.Количество) КАК Количество
		|ПОМЕСТИТЬ ПрошлыеРеализацииПартийНДС2_2
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ЗнаменателиПриходов КАК Знаменатели
		|		ПО Знаменатели.Регистратор = ДД.Регистратор
		|		И Знаменатели.Организация = ДД.Организация
		|		И Знаменатели.Партия = ДД.Партия
		|		И Знаменатели.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|		И Знаменатели.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Знаменатели.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|		И Знаменатели.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Знаменатели.ВидЗапасов = ДД.ВидЗапасов
		|		И Знаменатели.РазделУчета = ДД.РазделУчета
		|		И ДД.СлужебноеВидДвиженияПриход
		|		И ВЫБОР КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией))
		|			ТОГДА ИСТИНА
		|			ИНАЧЕ ЛОЖЬ
		|		  КОНЕЦ = Знаменатели.ЭтоДопРасходы
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРасчетныеЦены КАК Цены
		|		ПО Цены.Организация = ДД.Организация
		|		И Цены.Партия = ДД.Партия
		|		И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|		И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|		И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Цены.ВидЗапасов = ДД.ВидЗапасов
		|		И Цены.РазделУчета = ДД.РазделУчета
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТПлановыеЦены КАК ПлановыеЦены
		|		ПО ПлановыеЦены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов)
		|	И ДД.Количество <> 0
		|СГРУППИРОВАТЬ ПО
		|	ДД.ДокументИсточник,
		|	ДД.Организация,
		|	ВЫБОР
		|		КОГДА ДД.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		|			ТОГДА ДД.РазделУчета
		|		ИНАЧЕ ДД.КорРазделУчета
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ДД.КорАналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ ДД.КорАналитикаУчетаНоменклатуры
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ДД.КорВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|			ТОГДА ДД.ВидЗапасов
		|		ИНАЧЕ ДД.КорВидЗапасов
		|	КОНЕЦ,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.АналитикаФинансовогоУчета,
		|	ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС
		|	КОНЕЦ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС,
		|	СУММА(ДД.Количество) КАК Количество
		|ПОМЕСТИТЬ КоличествоПрошлыеРеализацииПартийНДС2_2
		|ИЗ
		|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрошлыеРеализацииПартийНДС2_2 КАК Прошлые
		|		ПО ДД.Регистратор = Прошлые.ДокументИсточник
		|		И ДД.Организация = Прошлые.Организация
		|		И ДД.РазделУчета = Прошлые.РазделУчета
		|		И ДД.АналитикаУчетаНоменклатуры = Прошлые.АналитикаУчетаНоменклатуры
		|		И ДД.ВидЗапасов = Прошлые.ВидЗапасов
		|		И ДД.АналитикаФинансовогоУчета = Прошлые.АналитикаФинансовогоУчета
		|		И ДД.КорВидДеятельностиНДС = Прошлые.ВидДеятельностиНДС
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И ДД.Количество <> 0
		|СГРУППИРОВАТЬ ПО
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.РазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.ДокументИсточник,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ЕСТЬNULL(АналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)) КАК АналитикаУчетаВнешнихПартий,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
		|	ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС
		|	КОНЕЦ КАК ВидДеятельностиНДС,
		|	СУММА(
		|	  ВЫБОР
		|		КОГДА ЕСТЬNULL(Знаменатели.Знаменатель, 0) <> 0
		|			ТОГДА Знаменатели.Знаменатель
		|		КОГДА ДД.СтоимостьРегл <> 0
		|			ТОГДА ДД.СтоимостьРегл
		|			ИНАЧЕ ВЫРАЗИТЬ(ДД.Количество * ЕСТЬNULL(Цены.СтоимостьРегл, ЕСТЬNULL(ПлановыеЦены.Цена, 0)) КАК ЧИСЛО(31,2))
		|	  КОНЕЦ) КАК Знаменатель,
		|	СУММА(ЕСТЬNULL(Знаменатели.ЗнаменательДляИсточников, 0)) КАК ЗнаменательДляИсточников
		|ПОМЕСТИТЬ ПрошлыеРеализацииПартийНДС2_4
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ЗнаменателиПриходов КАК Знаменатели
		|		ПО Знаменатели.Регистратор = ДД.Регистратор
		|		И Знаменатели.Организация = ДД.Организация
		|		И Знаменатели.Партия = ДД.Партия
		|		И Знаменатели.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|		И Знаменатели.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Знаменатели.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|		И Знаменатели.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Знаменатели.ВидЗапасов = ДД.ВидЗапасов
		|		И Знаменатели.РазделУчета = ДД.РазделУчета
		|		И ДД.СлужебноеВидДвиженияПриход
		|		И НЕ Знаменатели.ЭтоДопРасходы
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРасчетныеЦены КАК Цены
		|		ПО Цены.Организация = ДД.Организация
		|		И Цены.Партия = ДД.Партия
		|		И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|		И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|		И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Цены.ВидЗапасов = ДД.ВидЗапасов
		|		И Цены.РазделУчета = ДД.РазделУчета
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТПлановыеЦены КАК ПлановыеЦены
		|		ПО ПлановыеЦены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОтборАналитикиУчетаПартийНДС2_4 КАК АналитикиУчетаПартий
		|		ПО ДД.АналитикаУчетаПартий = АналитикиУчетаПартий.Ссылка
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.ДокументИсточник,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ЕСТЬNULL(АналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)),
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|	ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС
		|	КОНЕЦ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход
		|			И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|		ИНАЧЕ ДД.ТипЗаписи КОНЕЦ) КАК ТипЗаписи,
		|	ЛОЖЬ КАК Сторно,
		|	СУММА(ВЫБОР
		|			КОГДА ЕСТЬNULL(Знаменатели.Знаменатель, 0) <> 0
		|				ТОГДА Знаменатели.Знаменатель
		|			КОГДА ДД.СтоимостьРегл <> 0
		|				ТОГДА ДД.СтоимостьРегл
		|				ИНАЧЕ ВЫРАЗИТЬ(ДД.Количество * ЕСТЬNULL(Цены.СтоимостьРегл, ЕСТЬNULL(ПлановыеЦены.Цена, 0)) КАК ЧИСЛО(31,2))
		|		  КОНЕЦ) КАК Знаменатель,
		|	СУММА(ЕСТЬNULL(Знаменатели.ЗнаменательДляИсточников, 0)) КАК ЗнаменательДляИсточников,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	ДД.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|		 ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.Организация В (&ОрганизацииСФИФОСкользящая)
		|			ТОГДА ДД.Партия
		|		КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|			ТОГДА ДД.ДокументИсточник
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ) КАК Партия,
		|	ЕСТЬNULL(АналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)) КАК АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	(ВЫБОР
		|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ ДД.КорАналитикаУчетаНоменклатуры КОНЕЦ) КАК КорАналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
		|			ТОГДА ДД.ВидЗапасов
		|		ИНАЧЕ ДД.КорВидЗапасов КОНЕЦ) КАК КорВидЗапасов,
		|
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам))
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		КОГДА ДД.ТипЗаписи В (ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости), ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
		|		 И ДД.Количество = 0
		|		 И ДД.КорАналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		КОГДА ДД.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия) И ДД.Количество = 0
		|		 И ДД.КорАналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		ИНАЧЕ ДД.АналитикаУчетаПартий КОНЕЦ) КАК АналитикаУчетаДокументаПоступления,
		|	(ВЫБОР
		|		КОГДА НЕ Корректировка.ВидКорректировки ЕСТЬ NULL
		|		 И Корректировка.ВидКорректировки <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон)
		|			ТОГДА Корректировка.ДокументОснование
		|		КОГДА НЕ СчетФактура.Исправление ЕСТЬ NULL И СчетФактура.Исправление
		|			ТОГДА СчетФактура.СчетФактураОснование
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ) КАК ДокументПоступления,
		|
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.СтоимостьРегл + ДД.ДопРасходыРегл
		|		+ ВЫБОР
		|			КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|				ТОГДА -ДД.НДСРегл
		|			КОГДА ДД.Регистратор ССЫЛКА Документ.ТаможеннаяДекларацияИмпорт
		|			 И ДД.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|				ТОГДА -ДД.НДСРегл
		|			ИНАЧЕ 0
		|	КОНЕЦ - ЕСТЬNULL(СписаниеОтклонений.ДопРасходыРегл, 0)) КАК СтоимостьБезНДС,
		|	СУММА(ДД.НДСРегл - ЕСТЬNULL(СписаниеОтклонений.НДСРегл, 0)) КАК НДС,
		|	СУММА(ВЫБОР КОГДА &УправленческийУчетОрганизаций
		|		ТОГДА ДД.СтоимостьУпр + ДД.ДопРасходыУпр
		|		+ ВЫБОР
		|			КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|				ТОГДА -ДД.НДСУпр
		|			КОГДА ДД.Регистратор ССЫЛКА Документ.ТаможеннаяДекларацияИмпорт
		|			 И ДД.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|				ТОГДА -ДД.НДСРегл
		|			ИНАЧЕ 0
		|			КОНЕЦ - ЕСТЬNULL(СписаниеОтклонений.ДопРасходыУпр, 0)
		|		ИНАЧЕ 0
		|	КОНЕЦ) КАК СтоимостьБезНДСУпр,
		|	СУММА(ВЫБОР
		|		КОГДА &УправленческийУчетОрганизаций
		|			ТОГДА ДД.НДСУпр - ЕСТЬNULL(СписаниеОтклонений.НДСУпр, 0)
		|		ИНАЧЕ 0
		|	КОНЕЦ) КАК НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ЕСТЬNULL(КорАналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)) КАК КорАналитикаУчетаПартий,
		|	ЕСТЬNULL(ДД.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК КорНаправлениеДеятельности,
		|	ДД.Подразделение,
		|	(ВЫБОР
		|		КОГДА ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|		 И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.СтатьяРасходовСписания
		|		КОГДА ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
		|			ТОГДА ДД.СтатьяАктивовПассивов
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов КАК АналитикаАктивов,
		|	(ВЫБОР
		|		КОГДА НЕ ДД.Организация В (&ОрганизацииСФИФОСкользящая)
		|		 И Реестр.ДатаДокументаИБ < &НачалоПериода
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		КОГДА ДД.Партия <> НЕОПРЕДЕЛЕНО
		|		 И ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|			ТОГДА ДД.Партия
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ) КАК ДокументИсточник
		|ПОМЕСТИТЬ ПриходыТоваровНДС2_4
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПоПартнерам КАК АналитикаРасчетов
		|		ПО АналитикаРасчетов.Ссылка = ДД.АналитикаУчетаПоПартнерам
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК Договоры
		|		ПО Договоры.Ссылка = АналитикаРасчетов.Договор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК Корректировка
		|		ПО Корректировка.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученныйНалоговыйАгент КАК СчетФактура
		|		ПО СчетФактура.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ СписаниеОтклоненийВСтоимости2_4 КАК СписаниеОтклонений
		|		ПО СписаниеОтклонений.Организация = ДД.Организация
		|		И СписаниеОтклонений.Партия = ДД.Партия
		|		И СписаниеОтклонений.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|		И СписаниеОтклонений.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|		И СписаниеОтклонений.НаправлениеДеятельности = ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|		И ДД.СлужебноеВидДвиженияПриход
		|		И ДД.ТипЗаписи <> ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
		|	ЛЕВОЕ СОЕДИНЕНИЕ ЗнаменателиПриходов КАК Знаменатели
		|		ПО Знаменатели.Регистратор = ДД.Регистратор
		|		И Знаменатели.Организация = ДД.Организация
		|		И Знаменатели.Партия = ДД.Партия
		|		И Знаменатели.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|		И Знаменатели.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Знаменатели.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|		И Знаменатели.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Знаменатели.ВидЗапасов = ДД.ВидЗапасов
		|		И Знаменатели.РазделУчета = ДД.РазделУчета
		|		И ДД.СлужебноеВидДвиженияПриход
		|		И ВЫБОР КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией))
		|			ТОГДА ИСТИНА
		|			ИНАЧЕ ЛОЖЬ
		|		  КОНЕЦ = Знаменатели.ЭтоДопРасходы
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРасчетныеЦены КАК Цены
		|		ПО Цены.Организация = ДД.Организация
		|		И Цены.Партия = ДД.Партия
		|		И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|		И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|		И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Цены.ВидЗапасов = ДД.ВидЗапасов
		|		И Цены.РазделУчета = ДД.РазделУчета
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТПлановыеЦены КАК ПлановыеЦены
		|		ПО ПлановыеЦены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РеестрДокументов КАК Реестр
		|		ПО Реестр.Ссылка = ДД.ДокументИсточник
		|		И НЕ Реестр.ДополнительнаяЗапись
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОтборАналитикиУчетаПартийНДС2_4 КАК АналитикиУчетаПартий
		|		ПО ДД.АналитикаУчетаПартий = АналитикиУчетаПартий.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОтборАналитикиУчетаПартийНДС2_4 КАК КорАналитикиУчетаПартий
		|		ПО ДД.КорАналитикаУчетаПартий = КорАналитикиУчетаПартий.Ссылка
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И ДД.Партия <> НЕОПРЕДЕЛЕНО
		|	И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
		|   И (ДД.СлужебноеВидДвиженияПриход
		|		ИЛИ ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
		|		ИЛИ ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
		|		ИЛИ ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
		// Исключаем суммовую корректировку приобретения, если корректируемый документ относится к периоду с выключенным партионным учетом.
		|	И НЕ (
		|		ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода)
		|		И ДД.СлужебноеВидДвиженияПриход
		|		И ДД.Количество = 0
		|		И Реестр.ДатаДокументаИБ < &ДатаПереходаНаПартионныйУчетВерсии22
		|		И &ИспользовалсяПартионныйУчетДоПереходаНаВерсию22 = ЛОЖЬ)
		|	И (ДД.НДСРегл <> 0
		|		ИЛИ ДД.НДСУпр <> 0
		|		ИЛИ ДД.Организация В (&ОрганизацииНаУСН)
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.СборкаТоваров
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ТаможеннаяДекларацияИмпорт
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПорчаТоваров
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПересортицаТоваров
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ОприходованиеИзлишковТоваров
		|		ИЛИ ЕСТЬNULL(Договоры.УчетАгентскогоНДС, ЛОЖЬ)
		|		ИЛИ ДД.ХозяйственнаяОперация В (
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭС),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСНеотфактурованнаяПоставка),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСТоварыВПути),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаПоИмпорту),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаПоИмпортуТоварыВПути))
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПоступлениеТоваровНаСклад
		|		)
		|	И (ДД.ТипЗаписи В (
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение))
		|		)
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И (ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
		|		)
		|	И НЕ ДД.РазделУчета В (
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажи),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажиПереданныеПартнерам),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажиКОформлениюСписания),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки))
		|	И (ВЫБОР
		|		КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам))
		|		И ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		КОГДА ДД.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия) И ДД.Количество = 0
		|		 И ДД.КорАналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		ИНАЧЕ ДД.АналитикаУчетаПартий КОНЕЦ) <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ОтчетКомитентуОСписании
		|	И НЕ (ДД.Регистратор ССЫЛКА Документ.ВводОстатков
		|			И НЕ ВЫРАЗИТЬ(ДД.Регистратор КАК Документ.ВводОстатков).ВводОстатков22)
		|	И НЕ (НЕ Корректировка.ВидКорректировки ЕСТЬ NULL
		|			И Корректировка.ВидКорректировки = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон)
		|			И ДД.Количество = 0
		|			И (ДД.СтоимостьРегл < 0 ИЛИ ДД.ДопРасходыРегл < 0))
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход
		|			И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|		ИНАЧЕ ДД.ТипЗаписи КОНЕЦ),
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура,
		|	ДД.АналитикаУчетаНоменклатуры.Характеристика,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|		 ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.Организация В (&ОрганизацииСФИФОСкользящая)
		|			ТОГДА ДД.Партия
		|		КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|			ТОГДА ДД.ДокументИсточник
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ),
		|	ЕСТЬNULL(АналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)),
		|	ДД.ВидДеятельностиНДС,
		|	(ВЫБОР
		|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ ДД.КорАналитикаУчетаНоменклатуры КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
		|			ТОГДА ДД.ВидЗапасов
		|		ИНАЧЕ ДД.КорВидЗапасов КОНЕЦ),
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам))
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		КОГДА ДД.ТипЗаписи В (ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости), ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
		|		 И ДД.Количество = 0
		|		 И ДД.КорАналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		КОГДА ДД.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия) И ДД.Количество = 0
		|		 И ДД.КорАналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		ИНАЧЕ ДД.АналитикаУчетаПартий КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА НЕ Корректировка.ВидКорректировки ЕСТЬ NULL
		|		 И Корректировка.ВидКорректировки <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон)
		|			ТОГДА Корректировка.ДокументОснование
		|		КОГДА НЕ СчетФактура.Исправление ЕСТЬ NULL И СчетФактура.Исправление
		|			ТОГДА СчетФактура.СчетФактураОснование
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ),
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ЕСТЬNULL(КорАналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)),
		|	ЕСТЬNULL(ДД.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|	ДД.Подразделение,
		|	(ВЫБОР
		|		КОГДА ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|		 И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.СтатьяРасходовСписания
		|		КОГДА ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
		|			ТОГДА ДД.СтатьяАктивовПассивов
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	(ВЫБОР
		|		КОГДА НЕ ДД.Организация В (&ОрганизацииСФИФОСкользящая)
		|		 И Реестр.ДатаДокументаИБ < &НачалоПериода
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		КОГДА ДД.Партия <> НЕОПРЕДЕЛЕНО
		|		 И ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|			ТОГДА ДД.Партия
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) КАК ТипЗаписи,
		|	ЛОЖЬ КАК Сторно,
		|	СУММА(ДД.СтоимостьРегл) КАК Знаменатель,
		|	СУММА(ДД.СтоимостьРегл) КАК ЗнаменательДляИсточников,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	ДД.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ЕСТЬNULL(АналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)) КАК АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов КАК КорВидЗапасов,
		|
		|	(ВЫБОР
		|		КОГДА ДД.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		ИНАЧЕ ДД.АналитикаУчетаПартий КОНЕЦ) КАК АналитикаУчетаДокументаПоступления,
		|	ДД.Регистратор КАК ДокументПоступления,
		|
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(СписаниеОтклонений.ДопРасходыРегл
		|		+ ВЫБОР
		|			КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|				ТОГДА -СписаниеОтклонений.НДСРегл
		|			ИНАЧЕ 0
		|	КОНЕЦ) КАК СтоимостьБезНДС,
		|	СУММА(СписаниеОтклонений.НДСРегл) КАК НДС,
		|	СУММА(ВЫБОР КОГДА &УправленческийУчетОрганизаций
		|		ТОГДА СписаниеОтклонений.ДопРасходыУпр
		|			+ ВЫБОР
		|				КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|				ТОГДА -СписаниеОтклонений.НДСУпр
		|				ИНАЧЕ 0
		|			  КОНЕЦ
		|		ИНАЧЕ 0
		|	КОНЕЦ) КАК СтоимостьБезНДСУпр,
		|	СУММА(ВЫБОР
		|		КОГДА &УправленческийУчетОрганизаций
		|			ТОГДА СписаниеОтклонений.НДСУпр
		|		ИНАЧЕ 0
		|	КОНЕЦ) КАК НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ЕСТЬNULL(КорАналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)) КАК КорАналитикаУчетаПартий,
		|	ЕСТЬNULL(ДД.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК КорНаправлениеДеятельности,
		|	ДД.Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов КАК АналитикаАктивов,
		|	(ВЫБОР
		|		КОГДА ДД.Партия <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Партия
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ) КАК ДокументИсточник
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ СписаниеОтклоненийВСтоимости2_4 КАК СписаниеОтклонений
		|		ПО СписаниеОтклонений.Организация = ДД.Организация
		|		И СписаниеОтклонений.Партия = ДД.Партия
		|		И СписаниеОтклонений.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|		И СписаниеОтклонений.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|		И СписаниеОтклонений.НаправлениеДеятельности = ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|		И ДД.СлужебноеВидДвиженияПриход
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОтборАналитикиУчетаПартийНДС2_4 КАК АналитикиУчетаПартий
		|		ПО ДД.АналитикаУчетаПартий = АналитикиУчетаПартий.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОтборАналитикиУчетаПартийНДС2_4 КАК КорАналитикиУчетаПартий
		|		ПО ДД.КорАналитикаУчетаПартий = КорАналитикиУчетаПартий.Ссылка
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И ДД.Партия <> НЕОПРЕДЕЛЕНО
		|	И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
		|	И ДД.СлужебноеВидДвиженияПриход
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
		|	И (ВЫБОР
		|		КОГДА ДД.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		ИНАЧЕ ДД.АналитикаУчетаПартий КОНЕЦ) <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|СГРУППИРОВАТЬ ПО
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура,
		|	ДД.АналитикаУчетаНоменклатуры.Характеристика,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Партия,
		|	ЕСТЬNULL(АналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)),
		|	ДД.ВидДеятельностиНДС,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|	(ВЫБОР
		|		КОГДА ДД.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаПартий
		|		ИНАЧЕ ДД.АналитикаУчетаПартий КОНЕЦ),
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ЕСТЬNULL(КорАналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)),
		|	ЕСТЬNULL(ДД.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|	ДД.Подразделение,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	(ВЫБОР
		|		КОГДА ДД.Партия <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Партия
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОстатокСгруппированный) КАК ТипЗаписи,
		|	ЛОЖЬ КАК Сторно,
		|	СУММА(ДД.СтоимостьБезНДС
		|			+ ВЫБОР КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|				ТОГДА ДД.НДС
		|				ИНАЧЕ 0
		|			  КОНЕЦ) КАК Знаменатель,
		|	0 КАК ЗнаменательДляИсточников,
		|	ДД.Номенклатура КАК Номенклатура,
		|	ДД.Характеристика КАК Характеристика,
		|	ДД.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|		 ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ КАК ВидДвижения,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов КАК КорВидЗапасов,
		|
		|	ДД.АналитикаУчетаДокументаПоступления КАК АналитикаУчетаДокументаПоступления,
		|	ДД.ДокументПоступления,
		|
		|	0 КАК Количество,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.НДС) КАК НДС,
		|	СУММА(ДД.СтоимостьБезНДСУпр) КАК СтоимостьБезНДСУпр,
		|	СУММА(ДД.НДСУпр) КАК НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов КАК АналитикаАктивов,
		|	ДД.Регистратор КАК ДокументИсточник
		|ИЗ
		|	ВТКэшРасчетныеОборотыДетализацияПартийТоваровДляНДСиУСН2_4 КАК ДД
		|ГДЕ
		|	ДД.Регистратор ССЫЛКА Документ.ВводОстатков
		|	И ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И НЕ ВЫРАЗИТЬ(Регистратор КАК Документ.ВводОстатков).ВводОстатков22
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.ТипЗаписи,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.НаправлениеДеятельности,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|		 ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ,
		|	ДД.Организация,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.АналитикаУчетаДокументаПоступления,
		|	ДД.ДокументПоступления,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.Подразделение,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщика)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПеремещениеАвто)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|
		|		ИНАЧЕ ДД.ТипЗаписи
		|	КОНЕЦ КАК ТипЗаписи,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения) ТОГДА ЛОЖЬ
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК Сторно,
		|	МАКСИМУМ(ЕСТЬNULL(Знаменатели.Знаменатель, 0))
		|		+ СУММА(ВЫБОР
		|			КОГДА ЕСТЬNULL(Знаменатели.Знаменатель, 0) <> 0
		|				ТОГДА 0
		|				ИНАЧЕ ВЫРАЗИТЬ(ДД.Количество * ЕСТЬNULL(Цены.СтоимостьРегл, ЕСТЬNULL(ПлановыеЦены.Цена, 0)) КАК ЧИСЛО(31,2))
		|		  КОНЕЦ) КАК Знаменатель,
		|	МАКСИМУМ(ЕСТЬNULL(Знаменатели.ЗнаменательДляИсточников, 0)) КАК ЗнаменательДляИсточников,
		|	СУММА(ДД.Количество) КАК Количество,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	ДД.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
		|	(ВЫБОР
		|		КОГДА НЕ ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности ЕСТЬ NULL
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КОНЕЦ) КАК НаправлениеДеятельности,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|		 ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ КАК ВидДвижения,
		|	ДД.Организация КАК Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ВЫБОР
		|		КОГДА ИСТИНА
		|			ТОГДА ДД.Партия
		|	КОНЕЦ КАК Партия,
		|	ЕСТЬNULL(АналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)) КАК АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|
		|	ДД.ХозяйственнаяОперация,
		|	(ВЫБОР
		|		КОГДА НЕ ПередачаВидыЗапасов.Ссылка ЕСТЬ NULL И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ПередачаВидыЗапасов.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
		|		 И Передача.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
		|		КОГДА НЕ Передача.Ссылка ЕСТЬ NULL И НЕ ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА Передача.НалогообложениеНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС КОНЕЦ) КАК КорВидДеятельностиНДС,
		|	ДД.КорОрганизация,
		|	ВЫБОР
		|		КОГДА ИСТИНА
		|			ТОГДА ДД.КорПартия
		|	КОНЕЦ КАК КорПартия,
		|	ЕСТЬNULL(КорАналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)) КАК КорАналитикаУчетаПартий,
		|	(ВЫБОР
		|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.КорНаправлениеДеятельности <> ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|			ТОГДА ДД.КорНаправлениеДеятельности
		|		КОГДА НЕ ДД.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности ЕСТЬ NULL
		|			ТОГДА ДД.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КОНЕЦ) КАК КорНаправлениеДеятельности,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов КАК КорВидЗапасов,
		|	ДД.Подразделение,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	(ВЫБОР
		|		КОГДА ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|		 И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.СтатьяРасходовСписания
		|		КОГДА ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
		|			ТОГДА ДД.СтатьяАктивовПассивов
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов КАК АналитикаАктивов,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика)
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение))
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ) КАК ДокументИсточник,
		|		ДД.РазделУчета КАК РазделУчета,
		|		ДД.КорРазделУчета КАК КорРазделУчета
		|ПОМЕСТИТЬ ДвиженияСебестоимостиНДС2_4
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями КАК Передача
		|		ПО Передача.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями.ВидыЗапасов КАК ПередачаВидыЗапасов
		|		ПО ПередачаВидыЗапасов.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ ЗнаменателиПриходов КАК Знаменатели
		|		ПО Знаменатели.Регистратор = ДД.Регистратор
		|		И Знаменатели.Организация = ДД.Организация
		|		И Знаменатели.Партия = ДД.Партия
		|		И Знаменатели.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|		И Знаменатели.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Знаменатели.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|		И Знаменатели.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Знаменатели.ВидЗапасов = ДД.ВидЗапасов
		|		И Знаменатели.РазделУчета = ДД.РазделУчета
		|		И ДД.СлужебноеВидДвиженияПриход
		|		И ВЫБОР КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией))
		|			ТОГДА ИСТИНА
		|			ИНАЧЕ ЛОЖЬ
		|		  КОНЕЦ = Знаменатели.ЭтоДопРасходы
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРасчетныеЦены КАК Цены
		|		ПО Цены.Организация = ДД.Организация
		|		И Цены.Партия = ДД.Партия
		|		И Цены.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|		И Цены.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Цены.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|		И Цены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Цены.ВидЗапасов = ДД.ВидЗапасов
		|		И Цены.РазделУчета = ДД.РазделУчета
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТПлановыеЦены КАК ПлановыеЦены
		|		ПО ПлановыеЦены.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОтборАналитикиУчетаПартийНДС2_4 КАК АналитикиУчетаПартий
		|		ПО ДД.АналитикаУчетаПартий = АналитикиУчетаПартий.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОтборАналитикиУчетаПартийНДС2_4 КАК КорАналитикиУчетаПартий
		|		ПО ДД.КорАналитикаУчетаПартий = КорАналитикиУчетаПартий.Ссылка
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И ДД.Партия <> НЕОПРЕДЕЛЕНО
		|	И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
		|	И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииФиксированнаяСтоимость)
		|	И ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|			ТОГДА ЛОЖЬ
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск) И НЕ ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА ЛОЖЬ
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЛОЖЬ
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация В
		|		 	(ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
		|		 	 ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства),
		|		 	 ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщика))
		|			ТОГДА ЛОЖЬ
		|		
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск) И НЕ ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА ЛОЖЬ
		|
		|		КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПотреблениеАвто),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПотреблениеПроизводство),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Распределение),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратНаДругойСклад))
		|			И ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|				= ЕСТЬNULL(ДД.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|			И ДД.ВидДеятельностиНДС         = ДД.КорВидДеятельностиНДС
		|			И ДД.Партия         			= ДД.КорПартия
		|			И (ДД.КорОрганизация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
		|				ИЛИ ДД.Организация = ДД.КорОрганизация)
		|			И ДД.КорРазделУчета	<> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		|			ТОГДА ЛОЖЬ
		|			
		|		КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПеремещениеОбособленно),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПеремещениеАвто),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Сторно),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СторноВозвратНаДругойСклад))
		|			И ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|				= ЕСТЬNULL(ДД.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|			И ДД.ВидДеятельностиНДС         = ДД.КорВидДеятельностиНДС
		|			И ДД.Партия         			= ДД.КорПартия
		|			И (ДД.КорОрганизация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
		|				ИЛИ ДД.Организация = ДД.КорОрганизация)
		|			ТОГДА ЛОЖЬ
		|			
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости)
		|			ТОГДА ЛОЖЬ
		|			
		|		ИНАЧЕ ИСТИНА
		|	КОНЕЦ = ИСТИНА
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И НЕ ДД.РазделУчета В (
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажи),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажиПереданныеПартнерам),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажиКОформлениюСписания),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки))
		|	И (НЕ ДД.ТипЗаписи В (
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов))
		|	  )
		|	И НЕ (ДД.Регистратор ССЫЛКА Документ.ПересортицаТоваров И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение))
		|	И НЕ (ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение) И ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением))
		|
		|СГРУППИРОВАТЬ ПО
		|	ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщика)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПеремещениеАвто)
		|
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|
		|		ИНАЧЕ ДД.ТипЗаписи
		|	КОНЕЦ,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения) ТОГДА ЛОЖЬ
		|		КОГДА ДД.Количество < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ),
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура,
		|	ДД.АналитикаУчетаНоменклатуры.Характеристика,
		|	(ВЫБОР
		|		КОГДА НЕ ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности ЕСТЬ NULL
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КОНЕЦ), // НаправлениеДеятельности
		|	(ВЫБОР
		|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.КорНаправлениеДеятельности <> ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|			ТОГДА ДД.КорНаправлениеДеятельности
		|		КОГДА НЕ ДД.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности ЕСТЬ NULL
		|			ТОГДА ДД.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КОНЕЦ), // КорНаправлениеДеятельности
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход
		|		 ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ВЫБОР
		|		КОГДА ИСТИНА
		|			ТОГДА ДД.Партия
		|	КОНЕЦ,
		|	ЕСТЬNULL(АналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)),
		|	ДД.ВидДеятельностиНДС,
		|
		|	ДД.ХозяйственнаяОперация,
		|	(ВЫБОР
		|		КОГДА НЕ ПередачаВидыЗапасов.Ссылка ЕСТЬ NULL И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ПередачаВидыЗапасов.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
		|		 И Передача.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
		|		КОГДА НЕ Передача.Ссылка ЕСТЬ NULL И НЕ ДД.СлужебноеВидДвиженияПриход
		|			ТОГДА Передача.НалогообложениеНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС КОНЕЦ),
		|	ДД.КорОрганизация,
		|	ВЫБОР
		|		КОГДА ИСТИНА
		|			ТОГДА ДД.КорПартия
		|	КОНЕЦ,
		|	ЕСТЬNULL(ДД.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|	ДД.Подразделение,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	(ВЫБОР
		|		КОГДА ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|		 И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.СтатьяРасходовСписания
		|		КОГДА ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
		|			ТОГДА ДД.СтатьяАктивовПассивов
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		 И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика)
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) И НЕ ДД.СлужебноеВидДвиженияПриход
		|		 И ДД.ХозяйственнаяОперация В (
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад),
		|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение))
		|		 И ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ),
		|		ДД.РазделУчета,
		|		ДД.КорРазделУчета,
		|	ЕСТЬNULL(КорАналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка))
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА ДД.СтоимостьБезНДСОстаток < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК Сторно,
		|	ЕСТЬNULL(ОстаткиДетально.Знаменатель, ЕСТЬNULL(Остатки.Знаменатель,
		|		ДД.СтоимостьБезНДСОстаток
		|		  + ВЫБОР КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|				ТОГДА ДД.НДСОстаток
		|				ИНАЧЕ 0
		|			КОНЕЦ)) КАК Знаменатель,
		|	ДД.Номенклатура   КАК Номенклатура,
		|	ДД.Характеристика КАК Характеристика,
		|	
		| ЕСТЬNULL(ПериодикаПартии.ДатаРегистратора, &КонецПредыдущегоПериода) КАК Период,
		|	(ВЫБОР
		|		КОГДА ЕСТЬNULL(ОстаткиДетально.Партия, Остатки.Партия) ЕСТЬ NULL
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ЕСТЬNULL(ОстаткиДетально.Партия, Остатки.Партия) КОНЕЦ) КАК Регистратор,
		|	ДД.Организация,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаДокументаПоступления,
		|	ДД.НаправлениеДеятельности,
		|
		|	ДД.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
		|	ДД.НДСОстаток КАК НДС,
		|	ДД.СтоимостьБезНДСУпрОстаток КАК СтоимостьБезНДСУпр,
		|	ДД.НДСУпрОстаток КАК НДСУпр
		|ПОМЕСТИТЬ ВТНачальныеОстаткиПартийНДС
		|ИЗ
		|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН2_4.Остатки(&ГраницаКонецПредыдущегоПериода,
		|		Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)) КАК ДД
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиСебестоимостиТоваров2_4 КАК Остатки
		|		ПО Остатки.Организация = ДД.Организация
		|		И Остатки.Партия = ДД.Партия
		|		И Остатки.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|		И Остатки.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиСебестоимостиТоваровДетально2_4 КАК ОстаткиДетально
		|		ПО ОстаткиДетально.Организация = ДД.Организация
		|		И ОстаткиДетально.Партия = ДД.Партия
		|		И ОстаткиДетально.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|		И ОстаткиДетально.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|		И ОстаткиДетально.Номенклатура = ДД.Номенклатура
		|		И ОстаткиДетально.Характеристика = ДД.Характеристика
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ПериодикаПартии
		|		ПО ПериодикаПартии.Организация = ДД.Организация
		|		И ПериодикаПартии.Документ = ДД.Партия
		|";
КонецФункции

// ... выборки данных

Функция ТекстДетальныеНачальныеОстаткиПартийНДС2_4() // использует ОстаткиТоваров
	Возврат
		"ВЫБРАТЬ
		|	""ТекстДетальныеНачальныеОстаткиПартийНДС2_4"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Остаток) КАК ТипЗаписи,
		|	ВЫБОР
		|		КОГДА ДД.Знаменатель < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК Сторно,
		|	0 КАК Приоритет,
		|	ДД.Знаменатель,
		|	0 КАК ЗнаменательДляИсточников,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.Номенклатура   КАК Номенклатура,
		|	ДД.Характеристика КАК Характеристика,
		|	
		|	ДД.Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК ВидДвижения,
		|	ДД.Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) 				      КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) 				      КАК КорВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаДокументаПоступления,
		|	ДД.НаправлениеДеятельности,
		|
		|
		|	ДД.СтоимостьБезНДС,
		|	ДД.НДС,
		|	ДД.СтоимостьБезНДСУпр,
		|	ДД.НДСУпр,
		|
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК КорВидДеятельностиНДС,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	ДД.Партия КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	ВТНачальныеОстаткиПартийНДС КАК ДД
		|";
КонецФункции

Функция ТекстНачальныеОстаткиПартийНДС2_4() // использует ОстаткиТоваров
	Возврат
		"ВЫБРАТЬ
		|	""ТекстНачальныеОстаткиПартийНДС2_4"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОстатокСгруппированный) КАК ТипЗаписи,
		|	ВЫБОР
		|		КОГДА МАКСИМУМ(ДД.Знаменатель) < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК Сторно,
		|	0 КАК Приоритет,
		|	МАКСИМУМ(ДД.Знаменатель) КАК Знаменатель,
		|	СУММА(ДД.Знаменатель) КАК ЗнаменательДляИсточников,
		|	ВЫБОР КОГДА &РасчетПоПартиямПрочихРасходов
		|			ТОГДА ИСТИНА
		|			ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК РасчетЗавершен,
		|	НЕОПРЕДЕЛЕНО КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК Характеристика,
		|	
		|	ДД.Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) 				      КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) 				      КАК КорВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаДокументаПоступления,
		|	ДД.НаправлениеДеятельности,
		|
		|
		|	0,
		|	0,
		|	0,
		|	0,
		|
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК КорВидДеятельностиНДС,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	ВТНачальныеОстаткиПартийНДС КАК ДД
		|ГДЕ
		|	ИСТИНА В (ВЫБРАТЬ Т.ЕстьЗаписи ИЗ ВыполнятьРаспределениеПартийНДС2_4 КАК Т)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Сторно,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.НаправлениеДеятельности
		|";
КонецФункции

Функция ТекстДетальныеПриходыСебестоимостиТоваров2_4() // использует ПриходыТоваровНДС2_4
	Возврат
		"ВЫБРАТЬ
		|	""ТекстДетальныеПриходыСебестоимостиТоваров2_4"" КАК ЗапросИсточник,
		|	ДД.ТипЗаписи,
		|	ВЫБОР
		|		КОГДА СУММА(ДД.Знаменатель) < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК Сторно,
		|	0 КАК Приоритет,
		|	СУММА(ДД.Знаменатель) КАК Знаменатель,
		|	СУММА(ДД.ЗнаменательДляИсточников) КАК ЗнаменательДляИсточников,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ВЫБОР КОГДА ДД.ТипЗаписи В (
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|			ТОГДА ДД.Номенклатура
		|			ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ КАК Номенклатура,
		|	ВЫБОР КОГДА ДД.ТипЗаписи В (
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|			ТОГДА ДД.Характеристика
		|			ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ КАК Характеристика,
		|	
		|	ДД.Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ТОГДА 
		|			ВЫБОР КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|					ТОГДА ДД.АналитикаУчетаНоменклатуры
		|					ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			КОНЕЦ
		|		ИНАЧЕ ДД.АналитикаУчетаНоменклатуры
		|	КОНЕЦ КАК АналитикаУчетаНоменклатуры,
		|	ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ТОГДА
		|			ВЫБОР КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|					ТОГДА ДД.ВидЗапасов
		|					ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|			КОНЕЦ
		|		ИНАЧЕ ДД.ВидЗапасов
		|	КОНЕЦ КАК ВидЗапасов,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов КАК КорВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаДокументаПоступления КАК АналитикаУчетаДокументаПоступления,
		|	ДД.НаправлениеДеятельности,
		|
		|
		|	СУММА(ВЫБОР КОГДА &РасчетПоПартиямПрочихРасходов ТОГДА 0 ИНАЧЕ ДД.СтоимостьБезНДС КОНЕЦ),
		|	СУММА(ВЫБОР КОГДА &РасчетПоПартиямПрочихРасходов ТОГДА 0 ИНАЧЕ ДД.НДС КОНЕЦ),
		|	СУММА(ВЫБОР КОГДА &РасчетПоПартиямПрочихРасходов ТОГДА 0 ИНАЧЕ ДД.СтоимостьБезНДСУпр КОНЕЦ),
		|	СУММА(ВЫБОР КОГДА &РасчетПоПартиямПрочихРасходов ТОГДА 0 ИНАЧЕ ДД.НДСУпр КОНЕЦ),
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаУчетаПартий,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	ДД.ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	ПриходыТоваровНДС2_4 КАК ДД
		|ГДЕ
		|	НЕ (ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|		И ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости)))
		|	И (ДД.СтоимостьБезНДС <> 0 ИЛИ ДД.НДС <> 0 ИЛИ ДД.СтоимостьБезНДСУпр <> 0 ИЛИ ДД.НДСУпр <> 0)
		|	И НЕ (&РасчетПоПартиямПрочихРасходов И ДД.ТипЗаписи <> ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия))
		|	И ИСТИНА В (ВЫБРАТЬ Т.ЕстьЗаписи ИЗ ВыполнятьРаспределениеПартийНДС2_4 КАК Т)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.ТипЗаписи,
		|	ВЫБОР
		|		КОГДА ДД.СтоимостьБезНДС < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ,
		|	ВЫБОР КОГДА ДД.ТипЗаписи В (
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|			ТОГДА ДД.Номенклатура
		|			ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ,
		|	ВЫБОР КОГДА ДД.ТипЗаписи В (
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|			ТОГДА ДД.Характеристика
		|			ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ТОГДА 
		|			ВЫБОР КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|					ТОГДА ДД.АналитикаУчетаНоменклатуры
		|					ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			КОНЕЦ
		|		ИНАЧЕ ДД.АналитикаУчетаНоменклатуры
		|	КОНЕЦ,
		|	ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ТОГДА
		|			ВЫБОР КОГДА ДД.ТипЗаписи В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости))
		|					ТОГДА ДД.ВидЗапасов
		|					ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|			КОНЕЦ
		|		ИНАЧЕ ДД.ВидЗапасов
		|	КОНЕЦ,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаДокументаПоступления,
		|	ДД.НаправлениеДеятельности,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорОрганизация,
		|	ДД.КорПартия,
		|	ДД.КорАналитикаУчетаПартий,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	ДД.ДокументИсточник
		|";
КонецФункции

Функция ТекстПриходыСебестоимостиТоваров2_4() // использует ПриходыТоваровНДС2_4
	Возврат
		"ВЫБРАТЬ
		|	""ТекстПриходыСебестоимостиТоваров2_4"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейпартий.ПартияСгруппированная) КАК ТипЗаписи,
		|	ВЫБОР
		|		КОГДА СУММА(ДД.Знаменатель) < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК Сторно,
		|	0 КАК Приоритет,
		|	СУММА(ДД.Знаменатель) КАК Знаменатель,
		|	СУММА(ДД.ЗнаменательДляИсточников) КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	НЕОПРЕДЕЛЕНО КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК Характеристика,
		|	
		|	ЕСТЬNULL(ПериодикаПартии.ДатаРегистратора, &КонецПредыдущегоПериода) КАК Период,
		|	ЕСТЬNULL(ПериодикаПартии.ДатаРегистратора, &КонецПредыдущегоПериода) КАК ПериодПоступления,
		|	ДД.Партия КАК Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК ВидДвижения,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО  КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО  КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаДокументаПоступления,
		|	ДД.НаправлениеДеятельности,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДС,
		|	0 КАК СтоимостьБезНДСУпр,
		|	0 КАК НДСУпр,
		|
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	ДД.Партия КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	ПриходыТоваровНДС2_4 КАК ДД
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ПериодикаПартии
		|	ПО ПериодикаПартии.Организация = ДД.Организация
		|		И ПериодикаПартии.Документ = ДД.Партия
		|ГДЕ
		|	ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|	И (ДД.СтоимостьБезНДС <> 0 ИЛИ ДД.НДС <> 0 ИЛИ ДД.СтоимостьБезНДСУпр <> 0 ИЛИ ДД.НДСУпр <> 0)
		|	И ИСТИНА В (ВЫБРАТЬ Т.ЕстьЗаписи ИЗ ВыполнятьРаспределениеПартийНДС2_4 КАК Т)
		|
		|СГРУППИРОВАТЬ ПО
		|	ВЫБОР
		|		КОГДА ДД.СтоимостьБезНДС < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ,
		|	ЕСТЬNULL(ПериодикаПартии.ДатаРегистратора, &КонецПредыдущегоПериода),
		|	ДД.Организация,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.НаправлениеДеятельности
		|";
КонецФункции

Функция ТекстДвиженияСебестоимостиТоваров2_4()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстДвиженияСебестоимостиТоваров2_4"" КАК ЗапросИсточник,
		|	ДД.ТипЗаписи,
		|	ВЫБОР
		|		КОГДА СУММА(ДД.Знаменатель) < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК Сторно,
		|	0 КАК Приоритет,
		|	СУММА(ВЫБОР КОГДА &РасчетПоПартиямПрочихРасходов И ДД.Знаменатель = 0 ТОГДА ДД.Количество ИНАЧЕ ДД.Знаменатель КОНЕЦ) КАК Знаменатель,
		|	СУММА(ДД.ЗнаменательДляИсточников) КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ВЫБОР КОГДА НЕ &РасчетПоПартиямПрочихРасходов И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|			ТОГДА ДД.Номенклатура
		|			ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ КАК Номенклатура,
		|	ВЫБОР КОГДА НЕ &РасчетПоПартиямПрочихРасходов И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|			ТОГДА ДД.Характеристика
		|			ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ КАК Характеристика,
		|
		|	ДД.Период,
		|	ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения)
		|			ТОГДА &НачалоПериода
		|		ИНАЧЕ ДД.Период
		|	КОНЕЦ КАК ПериодПоступления,
		|	ДД.Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ВЫБОР КОГДА &РасчетПоПартиямПрочихРасходов ИЛИ ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ТОГДА ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|		ИНАЧЕ ДД.АналитикаУчетаНоменклатуры
		|	КОНЕЦ КАК АналитикаУчетаНоменклатуры,
		|	ВЫБОР КОГДА &РасчетПоПартиямПрочихРасходов ИЛИ ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ТОГДА ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|		ИНАЧЕ ДД.ВидЗапасов
		|	КОНЕЦ КАК ВидЗапасов,
		|	ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|			И ДД.КорАналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|		ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ ДД.КорАналитикаУчетаНоменклатуры
		|	КОНЕЦ КАК КорАналитикаУчетаНоменклатуры,
		|	ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|			И ДД.КорВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|		ТОГДА ДД.ВидЗапасов
		|		ИНАЧЕ ДД.КорВидЗапасов
		|	КОНЕЦ КАК КорВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|		 И ДД.Партия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути)
		|		 И ДД.Партия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.Партия КОНЕЦ) КАК Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаДокументаПоступления,
		|	ДД.НаправлениеДеятельности,
		|
		|
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДС,
		|	0 КАК СтоимостьБезНДСУпр,
		|	0 КАК НДСУпр,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорОрганизация,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|		 И ДД.КорПартия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути)
		|		 И ДД.КорПартия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.КорПартия КОНЕЦ) КАК КорПартия,
		|	ДД.КорАналитикаУчетаПартий КАК КорАналитикаУчетаПартий,
		|	ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|		 И ДД.КорНаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|		 И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
		|			ТОГДА ДД.НаправлениеДеятельности
		|		ИНАЧЕ ДД.КорНаправлениеДеятельности
		|	КОНЕЦ КАК КорНаправлениеДеятельности,
		|	ДД.Подразделение,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	ВЫБОР КОГДА ДД.ТипЗаписи В (ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Сторно), ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СторноВозвратНаДругойСклад))
		|		ТОГДА ДД.ДокументИсточник
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	ДвиженияСебестоимостиНДС2_4 КАК ДД
		|ГДЕ
		|	(ДД.Знаменатель <> 0
		|	  ИЛИ &РасчетПоПартиямПрочихРасходов)
		|	И ДД.ТипЗаписи <> ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВключениеИсключениеНДСвСтоимости)
		|	И НЕ (&РасчетПоПартиямПрочихРасходов
		|		И ДД.ТипЗаписи В
		|			(ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПеремещениеУпр)))
		|	И ИСТИНА В (ВЫБРАТЬ Т.ЕстьЗаписи ИЗ ВыполнятьРаспределениеПартийНДС2_4 КАК Т)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.ТипЗаписи,
		|	ДД.Сторно,
		|	ВЫБОР КОГДА НЕ &РасчетПоПартиямПрочихРасходов И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|			ТОГДА ДД.Номенклатура
		|			ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ,
		|	ВЫБОР КОГДА НЕ &РасчетПоПартиямПрочихРасходов И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|			ТОГДА ДД.Характеристика
		|			ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ВидДвижения,
		|	ДД.Организация,
		|	ВЫБОР КОГДА &РасчетПоПартиямПрочихРасходов ИЛИ ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ТОГДА ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|		ИНАЧЕ ДД.АналитикаУчетаНоменклатуры
		|	КОНЕЦ,
		|	ВЫБОР КОГДА &РасчетПоПартиямПрочихРасходов ИЛИ ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ТОГДА ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|		ИНАЧЕ ДД.ВидЗапасов
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|			И ДД.КорАналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|		ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ ДД.КорАналитикаУчетаНоменклатуры
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|			И ДД.КорВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|		ТОГДА ДД.ВидЗапасов
		|		ИНАЧЕ ДД.КорВидЗапасов
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|			И ДД.КорАналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|		ТОГДА ДД.НаправлениеДеятельности
		|		ИНАЧЕ ДД.КорНаправлениеДеятельности
		|	КОНЕЦ,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск)
		|		 И ДД.Партия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути)
		|		 И ДД.Партия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.Партия КОНЕЦ),
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.НаправлениеДеятельности,
		|	ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|		 И ДД.КорНаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|		 И ДД.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
		|			ТОГДА ДД.НаправлениеДеятельности
		|		ИНАЧЕ ДД.КорНаправлениеДеятельности
		|	КОНЕЦ,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.КорОрганизация,
		|	(ВЫБОР
		|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
		|		 И ДД.КорПартия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути)
		|		 И ДД.КорПартия = НЕОПРЕДЕЛЕНО
		|			ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.КорПартия КОНЕЦ),
		|	ДД.Подразделение,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.КорАналитикаУчетаПартий,
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	ВЫБОР КОГДА ДД.ТипЗаписи В (ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Сторно), ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СторноВозвратНаДругойСклад))
		|		ТОГДА ДД.ДокументИсточник
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ";
КонецФункции

Функция ТекстДвиженияСебестоимостиТоваровСборка2_4()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстДвиженияСебестоимостиТоваровСборка2_4"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение) КАК ТипЗаписи,
		|	ВЫБОР
		|		КОГДА МАКСИМУМ(ЕСТЬNULL(Знаменатели.Знаменатель, 0)) < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК Сторно,
		|	0 КАК Приоритет,
		|	МАКСИМУМ(ЕСТЬNULL(Знаменатели.Знаменатель, 0)) КАК Знаменатель,
		|	МАКСИМУМ(ЕСТЬNULL(Знаменатели.ЗнаменательДляИсточников, 0)) КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	НЕОПРЕДЕЛЕНО КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК Характеристика,
		|	
		|	ДД.Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ДД.КорПартия КАК Партия,
		|	ЕСТЬNULL(АналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)) КАК АналитикаУчетаПартий,
		|	ДД.КорВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаДокументаПоступления,
		|	ЕСТЬNULL(ДД.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
		|
		|
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДС,
		|	0 КАК СтоимостьБезНДСУпр,
		|	0 КАК НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ЗнаменателиПриходов КАК Знаменатели
		|		ПО Знаменатели.Регистратор = ДД.Регистратор
		|		И Знаменатели.Организация = ДД.Организация
		|		И Знаменатели.Партия = ДД.КорПартия
		|		И Знаменатели.АналитикаУчетаПартий = ДД.КорАналитикаУчетаПартий
		|		И Знаменатели.АналитикаФинансовогоУчета = ДД.КорАналитикаФинансовогоУчета
		|		И Знаменатели.ВидДеятельностиНДС = ДД.КорВидДеятельностиНДС
		|		И Знаменатели.АналитикаУчетаНоменклатуры = ДД.КорАналитикаУчетаНоменклатуры
		|		И Знаменатели.ВидЗапасов = ДД.КорВидЗапасов
		|		И Знаменатели.РазделУчета = ДД.КорРазделУчета
		|		И НЕ ДД.СлужебноеВидДвиженияПриход
		|		И НЕ Знаменатели.ЭтоДопРасходы
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОтборАналитикиУчетаПартийНДС2_4 КАК АналитикиУчетаПартий
		|		ПО ДД.КорАналитикаУчетаПартий = АналитикиУчетаПартий.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОтборАналитикиУчетаПартийНДС2_4 КАК КорАналитикиУчетаПартий
		|		ПО ДД.КорАналитикаУчетаПартий = КорАналитикиУчетаПартий.Ссылка
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И ДД.Количество <> 0
		|	И ДД.Регистратор ССЫЛКА Документ.СборкаТоваров
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА ДД.СтоимостьРегл < 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ),
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.КорПартия,
		|	ЕСТЬNULL(АналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)),
		|	ДД.КорВидДеятельностиНДС,
		|	ЕСТЬNULL(ДД.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|	ДД.ХозяйственнаяОперация
		|";
КонецФункции

Функция ТекстВозвратыПрошлыхПериодов2_4()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстВозвратыПрошлыхПериодов2_4"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов) КАК ТипЗаписи,
		|	ИСТИНА КАК Сторно,
		|	0 КАК Приоритет,
		|	-Знаменатели.Знаменатель КАК Знаменатель,
		|	-Знаменатели.Знаменатель КАК ЗнаменательДляИсточников,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	ДД.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
		|	
		|	ДД.Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ДД.Партия,
		|	ЕСТЬNULL(АналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)) КАК АналитикаУчетаПартий,
		|	ДД.ВидДеятельностиНДС,
		|
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаДокументаПоступления,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
		|
		|
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДС,
		|	0 КАК СтоимостьБезНДСУпр,
		|	0 КАК НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидДеятельностиНДС,
		|	ДД.Организация КАК КорОрганизация,
		|	ДД.Партия КАК КорПартия,
		|	ЕСТЬNULL(КорАналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)) КАК КорАналитикаУчетаПартий,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК КорНаправлениеДеятельности,
		|	ДД.Подразделение,
		|	ДД.КорАналитикаФинансовогоУчета,
		|	ДД.СтатьяРасходовСписания КАК СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	ДД.ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ЗнаменателиПриходов КАК Знаменатели
		|		ПО Знаменатели.Регистратор = ДД.Регистратор
		|		И Знаменатели.Организация = ДД.Организация
		|		И Знаменатели.Партия = ДД.Партия
		|		И Знаменатели.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|		И Знаменатели.АналитикаФинансовогоУчета = ДД.АналитикаФинансовогоУчета
		|		И Знаменатели.ВидДеятельностиНДС = ДД.ВидДеятельностиНДС
		|		И Знаменатели.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Знаменатели.ВидЗапасов = ДД.ВидЗапасов
		|		И Знаменатели.РазделУчета = ДД.РазделУчета
		|		И ДД.СлужебноеВидДвиженияПриход
		|		И НЕ Знаменатели.ЭтоДопРасходы
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОтборАналитикиУчетаПартийНДС2_4 КАК АналитикиУчетаПартий
		|		ПО ДД.АналитикаУчетаПартий = АналитикиУчетаПартий.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОтборАналитикиУчетаПартийНДС2_4 КАК КорАналитикиУчетаПартий
		|		ПО ДД.КорАналитикаУчетаПартий = КорАналитикиУчетаПартий.Ссылка
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И ЕСТЬNULL(Знаменатели.Знаменатель, 0) <> 0
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов)
		|";
КонецФункции

Функция ТекстРеализацииПрошлыхМесяцевПартииНДС2_2() // использует ПрошлыеРеализации 
	Возврат
		"ВЫБРАТЬ
		|	""ТекстРеализацииПрошлыхМесяцевПартииНДС2_2"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Прошлое) КАК ТипЗаписи,
		|	ЛОЖЬ КАК Сторно,
		|	0 КАК Приоритет,
		|	Прошлые.Знаменатель * КоличествоРеализации.Количество / Прошлые.Количество КАК Знаменатель,
		|	0 КАК ЗнаменательДляИсточников,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ВЫБОР КОГДА ДД.Количество = 0
		|		ТОГДА ДД.АналитикаУчетаНоменклатуры.Номенклатура
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ КАК Номенклатура,
		|	ВЫБОР КОГДА ДД.Количество = 0
		|		ТОГДА ДД.АналитикаУчетаНоменклатуры.Характеристика
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ КАК Характеристика,
		|	
		|	ДД.Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО,
		|	Прошлые.АналитикаУчетаПартий,
		|	ДД.КорВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ДД.ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка),
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|
		|
		|	ДД.СтоимостьБезНДС,
		|	ДД.НДС,
		|	0,
		|	ДД.НДСУпр,
		|
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ КоличествоПрошлыеРеализацииПартийНДС2_2 КАК КоличествоРеализации
		|		ПО ДД.Регистратор = КоличествоРеализации.Регистратор
		|		И ДД.Организация = КоличествоРеализации.Организация
		|		И ДД.РазделУчета = КоличествоРеализации.РазделУчета
		|		И ДД.АналитикаУчетаНоменклатуры = КоличествоРеализации.АналитикаУчетаНоменклатуры
		|		И ДД.ВидЗапасов = КоличествоРеализации.ВидЗапасов
		|		И ДД.Партия = КоличествоРеализации.Партия
		|		И ДД.АналитикаФинансовогоУчета = КоличествоРеализации.АналитикаФинансовогоУчета
		|		И ДД.ВидДеятельностиНДС = КоличествоРеализации.ВидДеятельностиНДС
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрошлыеРеализацииПартийНДС2_2 КАК Прошлые
		|		ПО ДД.Регистратор = Прошлые.ДокументИсточник
		|		И ДД.Организация = Прошлые.Организация
		|		И ДД.РазделУчета = Прошлые.РазделУчета
		|		И ДД.АналитикаУчетаНоменклатуры = Прошлые.АналитикаУчетаНоменклатуры
		|		И ДД.ВидЗапасов = Прошлые.ВидЗапасов
		|		И ДД.АналитикаФинансовогоУчета = Прошлые.АналитикаФинансовогоУчета
		|		И ДД.КорВидДеятельностиНДС = Прошлые.ВидДеятельностиНДС
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И ДД.Активность
		|	И НЕ (ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|		И ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением))
		|";
КонецФункции

Функция ТекстРеализацииПрошлыхМесяцевПартииНДС2_4() // использует ПрошлыеРеализации 
	Возврат
		"ВЫБРАТЬ
		|	""ТекстРеализацииПрошлыхМесяцевПартииНДС2_4"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Прошлое) КАК ТипЗаписи,
		|	ЛОЖЬ КАК Сторно,
		|	0 КАК Приоритет,
		|	ДД.СтоимостьБезНДС
		|		+ ВЫБОР КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
		|			ТОГДА ДД.НДС
		|			ИНАЧЕ 0
		|		КОНЕЦ 									КАК Знаменатель,
		|	0											КАК ЗнаменательДляИсточников,
		|	ИСТИНА КАК 									РасчетЗавершен,
		|	ДД.Номенклатура   							КАК Номенклатура,
		|	ДД.Характеристика 							КАК Характеристика,
		|	
		|	ДД.Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.КорВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаДокументаПоступления,
		|	ДД.НаправлениеДеятельности,
		|
		|
		|	ДД.СтоимостьБезНДС,
		|	ДД.НДС,
		|	ДД.СтоимостьБезНДСУпр,
		|	ДД.НДСУпр,
		|
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН2_4 КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрошлыеРеализацииПартийНДС2_4 КАК Прошлые
		|		ПО ДД.Регистратор = Прошлые.ДокументИсточник
		|		И ДД.Организация = Прошлые.Организация
		|		И ДД.Партия = Прошлые.Партия
		|		И ДД.АналитикаУчетаПартий = Прошлые.АналитикаУчетаВнешнихПартий
		|		И ДД.КорВидДеятельностиНДС = Прошлые.ВидДеятельностиНДС
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И ДД.Активность
		|	И НЕ (ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение)
		|		И ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением))
		|	И Прошлые.Знаменатель <> 0
		|";
КонецФункции

Функция ТекстРеализацииПрошлыхМесяцевПартииНДС21_2_4() // использует ПрошлыеРеализации 
	Возврат
		"ВЫБРАТЬ
		|	""ТекстРеализацииПрошлыхМесяцевПартииНДС21_2_4"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Прошлое) КАК ТипЗаписи,
		|	ЛОЖЬ 											 КАК Сторно,
		|	0 												 КАК Приоритет,
		|	ВЫБОР КОГДА ДД.СтоимостьРегл = 0
		|		ТОГДА ДД.СтоимостьБезНДС
		|		ИНАЧЕ ДД.СтоимостьРегл
		|	КОНЕЦ											 КАК Знаменатель,
		|	0								 				 КАК ЗнаменательДляИсточников,
		|	ИСТИНА 											 КАК РасчетЗавершен,
		|	НЕОПРЕДЕЛЕНО									 КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО 									 КАК Характеристика,
		|	
		|	ДД.Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	Прошлые.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	Прошлые.Партия,
		|	Прошлые.АналитикаУчетаВнешнихПартий КАК АналитикаУчетаПартий,
		|	ДД.НалогообложениеНДС КАК ВидДеятельностиНДС,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартий КАК АналитикаУчетаДокументаПоступления,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
		|
		|
		|	ДД.СтоимостьБезНДС,
		|	ДД.НДСРегл,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК НДСУпр,
		|
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	НЕОПРЕДЕЛЕНО КАК КорПартия,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрошлыеРеализацииПартийНДС2_4 КАК Прошлые
		|		ПО ДД.Регистратор = Прошлые.ДокументИсточник
		|		И ДД.Организация = Прошлые.Организация
		|		И (ДД.ДокументПоступления = Прошлые.Партия
		|			ИЛИ Прошлые.Партия = НЕОПРЕДЕЛЕНО)
		|		И (ДД.АналитикаУчетаПартий = Прошлые.АналитикаУчетаПартий
		|			ИЛИ Прошлые.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка))
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И ДД.Активность
		|	И Прошлые.Знаменатель <> 0
		|";
КонецФункции

Функция ТекстТаможенныеДекларацииИзменениеВидыДеятельностиНДС2_4()
	Возврат
		"ВЫБРАТЬ
		|	""ТекстТаможенныеДекларацииИзменениеВидыДеятельностиНДС2_4"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВключениеИсключениеНДСВСтоимости) КАК ТипЗаписи,
		|	ЛОЖЬ КАК Сторно,
		|	0 КАК Приоритет,
		|	0 КАК Знаменатель,
		|	0 КАК ЗнаменательДляИсточников,
		|	ИСТИНА КАК РасчетЗавершен,
		|	НЕОПРЕДЕЛЕНО КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК Характеристика,
		|	
		|	ДД.Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.КорВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|
		|	ДД.Регистратор КАК ДокументПоступления,
		|	ДД.КорАналитикаУчетаПартий КАК АналитикаУчетаДокументаПоступления,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
		|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
		|
		|
		|	0 КАК СтоимостьБезНДС,
		|	ДД.НДСРегл КАК НДС,
		|	0 КАК СтоимостьБезНДСУпр,
		|	(ВЫБОР
		|		КОГДА &УправленческийУчетОрганизаций ТОГДА ДД.НДСУпр
		|		ИНАЧЕ 0 КОНЕЦ) КАК НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
		|	ДД.Организация КАК КорОрганизация,
		|	ДД.Партия КАК КорПартия,
		|	ДД.АналитикаУчетаПартий КАК КорАналитикаУчетаПартий,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, 
		|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК КорНаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	ДД.ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И ДД.ВидДеятельностиНДС <> ДД.КорВидДеятельностиНДС
		|	И ДД.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И (ДД.НДСРегл <> 0 ИЛИ ДД.НДСУпр <> 0)
		|	И ДД.ТипЗаписи В (
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии))
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	""ТекстТаможенныеДекларацииИзменениеВидыДеятельностиНДС2_4"" КАК ЗапросИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВключениеИсключениеНДСВСтоимости) КАК ТипЗаписи,
		|	ЛОЖЬ КАК Сторно,
		|	0 КАК Приоритет,
		|	0 КАК Знаменатель,
		|	0 КАК ЗнаменательДляИсточников,
		|	ИСТИНА КАК РасчетЗавершен,
		|	НЕОПРЕДЕЛЕНО КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК Характеристика,
		|	
		|	ДД.Период,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ДД.Партия,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.КорВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|
		|	ДД.Регистратор КАК ДокументПоступления,
		|	ДД.КорАналитикаУчетаПартий КАК АналитикаУчетаДокументаПоступления,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
		|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
		|
		|
		|	0 КАК СтоимостьБезНДС,
		|	ДД.НДСРегл КАК НДС,
		|	0 КАК СтоимостьБезНДСУпр,
		|	(ВЫБОР
		|		КОГДА &УправленческийУчетОрганизаций ТОГДА ДД.НДСУпр
		|		ИНАЧЕ 0 КОНЕЦ) КАК НДСУпр,
		|
		|	ДД.ХозяйственнаяОперация,
		|	ДД.ВидДеятельностиНДС КАК КорВидДеятельностиНДС,
		|	ДД.Организация КАК КорОрганизация,
		|	ДД.Партия КАК КорПартия,
		|	ДД.АналитикаУчетаПартий КАК КорАналитикаУчетаПартий,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, 
		|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК КорНаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовАктивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивов,
		|	ДД.ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Организация В (&ОрганизацииСУчетомПартийНДСВерсии24)
		|	И ДД.ВидДеятельностиНДС <> ДД.КорВидДеятельностиНДС
		|	И ДД.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И (ДД.НДСРегл <> 0 ИЛИ ДД.НДСУпр <> 0)
		|	И ДД.ТипЗаписи В (
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии))
		|";
КонецФункции

// Заполнение расчетной партии

Процедура ЗаполнитьРасчетнуюПартиюНДС2_4(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход)
	
	Если Расход.ВидДвижения = ВидДвиженияНакопления.Расход
	 И ЗначениеЗаполнено(Приход.Номенклатура)
	 И (Приход.Номенклатура <> Расход.Номенклатура
		 ИЛИ Приход.Характеристика <> Расход.Характеристика) Тогда
		Возврат;
		
	// Для корректировки приобретения источником может быть только корректируемая партия.
	// Дополнительные расходы по товарам не могут списываться при такой корректировке.
	ИначеЕсли Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.КорректировкаПриобретения
	 И (Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный
		ИЛИ Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПартияСгруппированная)
	 И Приход.Партия <> Приход.ДокументПоступления Тогда
		Приход.Знаменатель = Приход.Знаменатель - Мин(Расход.Знаменатель, Приход.Знаменатель);
	 	Возврат;
	КонецЕсли;
	
	СуммовыеРесурсы = Новый Структура("СтоимостьБезНДС, НДС, СтоимостьБезНДСУпр, НДСУпр");
	
	// Заполняем расчетную партию по расходной партии-основании
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	
	// Заполняем партионную идентификацию в расчетной партии
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход, "ДокументПоступления, АналитикаУчетаДокументаПоступления, Номенклатура, Характеристика
		|");
	
	
	Если РасчетнаяПартия.ТипЗаписи <> Перечисления.ТипыЗаписейПартий.ВозвратПрошлыхПериодов Тогда
		РасчетнаяПартия.ДокументИсточник = Неопределено;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.Партия) Тогда
		РасчетнаяПартия.Партия = Приход.Партия;
		РасчетнаяПартия.АналитикаУчетаПартий = Приход.АналитикаУчетаПартий;
	КонецЕсли;
	
	Если Приход.Партия <> РасчетнаяПартия.Партия Тогда
		// Доп. расходы "обезличиваются"
		РасчетнаяПартия.Номенклатура   = Неопределено;
		РасчетнаяПартия.Характеристика = Неопределено;
	КонецЕсли;
	
	// Заменим старые аналитики учета партий на новые.
	Если ПараметрыРасчета.РаспределениеПартий.ДополнительныеСвойства.Свойство("АналитикиУчетаПартий") Тогда
		
		НоваяАналитикаУчетаПартий = ПараметрыРасчета.РаспределениеПартий.ДополнительныеСвойства.АналитикиУчетаПартий.Получить(РасчетнаяПартия.АналитикаУчетаДокументаПоступления);
		
		Если ЗначениеЗаполнено(НоваяАналитикаУчетаПартий) Тогда
			РасчетнаяПартия.АналитикаУчетаДокументаПоступления = НоваяАналитикаУчетаПартий;
		КонецЕсли;
		
		НоваяАналитикаУчетаПартий = ПараметрыРасчета.РаспределениеПартий.ДополнительныеСвойства.АналитикиУчетаПартий.Получить(РасчетнаяПартия.АналитикаУчетаПартий);
		
		Если ЗначениеЗаполнено(НоваяАналитикаУчетаПартий) Тогда
			РасчетнаяПартия.АналитикаУчетаПартий = НоваяАналитикаУчетаПартий;
		КонецЕсли;
		
	КонецЕсли;
	
	// Очистим не используемые в дальнейшем поля.
	Если РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Приход Тогда
		РасчетнаяПартия.КорАналитикаУчетаНоменклатуры = Неопределено;
		РасчетнаяПартия.КорВидЗапасов = Неопределено;
	КонецЕсли;
	
	// Расчетная партия заполняется на наибольшее общее вычитаемое
	ПриходБазис = 0;
	
	Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.БазаРегл
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.БазаУпр Тогда
	 
		КоличествоСписания = Мин(Расход.Знаменатель, Приход.Знаменатель);
		ЗнаменательСписания = КоличествоСписания;
		ПриходБазис = ?(Приход.Знаменатель <> 0, КоличествоСписания / Приход.Знаменатель, 0);
		
		ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход, "ХозяйственнаяОперация, АналитикаСписанияНДС, Подразделение");
		ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход, "Партия, АналитикаУчетаПартий, ВидДеятельностиНДС, Период, Регистратор");
		
		РасчетнаяПартия.КорВидДеятельностиНДС = Приход.ВидДеятельностиНДС;
		РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ДопРасходы;
		
	ИначеЕсли ((РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Перемещение
	 	  И ТипЗнч(РасчетнаяПартия.Регистратор) = Тип("ДокументСсылка.СборкаТоваров"))
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Выпуск
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.СписанияНаВыпуск) Тогда
		КоличествоСписания = Мин(Расход.Знаменатель, Приход.Знаменатель);
		ЗнаменательСписания = КоличествоСписания;
		ПриходБазис = ?(Приход.Знаменатель <> 0, КоличествоСписания / Приход.Знаменатель, 0);
	Иначе
		
		Если Расход.ВидДвижения = ВидДвиженияНакопления.Приход И Расход.ЗнаменательДляИсточников <> 0 Тогда
			ИмяПоляЗнаменательРасхода = "ЗнаменательДляИсточников";
		Иначе
			ИмяПоляЗнаменательРасхода = "Знаменатель";
		КонецЕсли;
		
		Если Приход.Знаменатель <> 0 Тогда
			КоличествоСписания = Мин(Расход[ИмяПоляЗнаменательРасхода], Приход.Знаменатель);
			ЗнаменательСписания = КоличествоСписания;
			ПриходБазис = ?(Приход.Знаменатель <> 0, КоличествоСписания / Приход.Знаменатель, 0);
		КонецЕсли;
		
	КонецЕсли;
	
	Если ПриходБазис = 0 Тогда
		Возврат;
	КонецЕсли;
	
	// Заполняем показатели расчетной партии
	Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
		РасчетнаяПартия[ИмяРесурса.Ключ] = Окр(ПриходБазис * Приход[ИмяРесурса.Ключ], 2);
	КонецЦикла;
	
	Если РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ОстатокСгруппированный
	 ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.ПартияСгруппированная Тогда
		РасчетнаяПартия.Знаменатель = Приход.Знаменатель;
	ИначеЕсли Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.БазаРегл
	 ИЛИ Расход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.БазаУпр Тогда
		РасчетнаяПартия.Знаменатель = Расход.ЗнаменательДляИсточников;
	Иначе
		РасчетнаяПартия.Знаменатель = 0;
	КонецЕсли;
	
	// Корректируем базу расчета в приходе
	Если НЕ (Приход.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияКлиентуРеглУчет
		И Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Потребление)
	И НЕ (Приход.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства
		И Приход.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Распределение) Тогда
	 
	 	Если НЕ Приход.Сторно И РасчетнаяПартия.Сторно
		 И (РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Потребление
		 	ИЛИ РасчетнаяПартия.ТипЗаписи = Перечисления.ТипыЗаписейПартий.Сторно) Тогда
			Знак = -1;
		Иначе
			Знак = 1;
		КонецЕсли;
	 	
	    Приход.Знаменатель = Приход.Знаменатель - Знак * ЗнаменательСписания;
		
		Для Каждого ИмяРесурса Из СуммовыеРесурсы Цикл
			Приход[ИмяРесурса.Ключ] = Приход[ИмяРесурса.Ключ] - Знак * РасчетнаяПартия[ИмяРесурса.Ключ];
		КонецЦикла;
	 	
	КонецЕсли;
	
	ЗаполнитьСтатьюИАналитикуСписанияНДС(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход);
	
	// По результатам партионной идентификации определяем завершенность расчета
	Если ТипЗнч(Приход.Регистратор) = Тип("ДокументСсылка.ВводОстатков") Тогда
		// Для документов ВводОстатков с реквизитом ВводОстатков22 = Ложь в таблице Данные
		// установлен признак РасчетЗавершен = Ложь для того, чтобы движения этого документа не записывались в ИБ,
		// т.к. они уже сформированы самим документом.
		РасчетнаяПартия.РасчетЗавершен = Истина;
	ИначеЕсли РасчетнаяПартия.СтоимостьБезНДС = 0
	 И РасчетнаяПартия.НДС = 0
	 И РасчетнаяПартия.СтоимостьБезНДСУпр = 0
	 И РасчетнаяПартия.НДСУпр = 0 Тогда
		// Сформирована пустая расчетная запись. Такая запись не нужна в результатах расчета.
		РасчетнаяПартия.РасчетЗавершен = Ложь;
	Иначе
		РасчетнаяПартия.РасчетЗавершен = Приход.РасчетЗавершен;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти


#Область ПроцедурыЭтапа_ПодготовкаДанныхДляПартийНДСКРаспределению

// Выборка данных

Процедура ПолучитьДанныеДляПартийНДСКРаспределению(ПараметрыРасчета)
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьДанныеЭтапаРасчета(
		ПараметрыРасчета,
		ТекстЗапросаДляПартийНДСКРаспределению(ПараметрыРасчета));
	
КонецПроцедуры

// Тексты запросов

// ... общий

Функция ТекстЗапросаДляПартийНДСКРаспределению(ПараметрыРасчета = Неопределено) Экспорт
	
	ТекстЗапроса = ""
		// выборка данных
		+ ТекстОписаниеДанныхДляПартийНДСКРаспределению() //вт Данные
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстПоступленияПартийНДСКРаспределениюИзПартийНДС()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстПоступленияПартийНДСКРаспределениюИзПриходовСебестоимости() // использует ПриходыТоваровНДС
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстПоступленияПартийНДСКРаспределениюИзПартийНДС2_4()
		+ ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении() + ТекстПоступленияПартийНДСКРаспределениюИзПриходовСебестоимости2_4() // использует ПриходыТоваровНДС2_4
		+ "";
	
	Возврат ТекстЗапроса;
	
КонецФункции

// ... описания данных

Функция ТекстОписаниеДанныхДляПартийНДСКРаспределению()
	Возврат "
		|ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80)) КАК ЗапросИсточник,
		|	0 КАК Приоритет,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.НаправлениеДеятельности,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.Поставщик,
		|	ДД.ДокументПоступленияРасходов,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.ВидЦенности,
		|	ДД.СтавкаНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК НДСУпр
		|//ВоВременнуюТаблицу
		|ИЗ
		|	РегистрНакопления.ПартииНДСКРаспределению КАК ДД
		|";
КонецФункции

// ... выборки данных

Функция ТекстПоступленияПартийНДСКРаспределениюИзПартийНДС()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПоступленияПартийНДСКРаспределениюИзПартийНДС"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ВЫБОР
		|		КОГДА НЕ Потребление.Подразделение ЕСТЬ NULL
		|			ТОГДА Потребление.Подразделение
		|		КОГДА НЕ Сторно.Подразделение ЕСТЬ NULL
		|			ТОГДА Сторно.Подразделение
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
		|			ТОГДА Аналитика.Подразделение
		|		ИНАЧЕ ЕСТЬNULL(Склады.Подразделение, ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
		|	КОНЕЦ КАК Подразделение,
		|	ЕСТЬNULL(Потребление.НаправлениеДеятельности,
		|		ЕСТЬNULL(Назначения.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))) КАК НаправлениеДеятельности,
		|	ДД.СтатьяРасходовАктивов КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов КАК АналитикаАктивовПассивов,
		|	ДД.АналитикаУчетаПартий.Контрагент КАК Поставщик,
		|	ДД.ДокументПоступления КАК ДокументПоступленияРасходов,
		|	(ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|			ТОГДА ДД.КорВидДеятельностиНДС
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС) ТОГДА
		|			(ВЫБОР
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.КорВидДеятельностиНДС
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.ВидДеятельностиНДС
		|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию) КОНЕЦ)
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НМА)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС КОНЕЦ) КАК ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий.ВидЦенности КАК ВидЦенности,
		|	ДД.АналитикаУчетаПартий.СтавкаНДС КАК СтавкаНДС,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьРегл,
		|	СУММА(ДД.НДС) КАК НДСРегл,
		|	СУММА(ДД.НДСУпр) КАК НДСУпр
		|ИЗ
		|	ВТКэшРасчетныеОборотыДетализацияПартийТоваровДляНДСиУСН КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Склады КАК Склады
		|		ПО Аналитика.МестоХранения = Склады.Ссылка
		|			ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
		|		ПО Назначения.Ссылка = Аналитика.Назначение
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВнутреннееПотреблениеТоваров КАК Потребление
		|		ПО Потребление.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПрочееОприходованиеТоваров КАК Сторно
		|		ПО Сторно.Ссылка = ДД.Регистратор
		
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
		|		ПО Статья.Ссылка = ДД.СтатьяРасходовАктивов
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиАктивовПассивов КАК СтатьяАктивов
		|		ПО СтатьяАктивов.Ссылка = ДД.СтатьяРасходовАктивов
		|ГДЕ
		|	НЕ ДД.СлужебноеВидДвиженияПриход
		|	И (Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
		|		ИЛИ Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|			И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС)
		|		ИЛИ ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|		ИЛИ НЕ СтатьяАктивов.Ссылка ЕСТЬ NULL
		|			И ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|		ИЛИ НЕ СтатьяАктивов.Ссылка ЕСТЬ NULL
		|			И ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортСырьевыхТоваровУслуг)
		|		ИЛИ НЕ Статья.Ссылка ЕСТЬ NULL
		|			И ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортСырьевыхТоваровУслуг)
		|	)
		|	И (ДД.НДС <> 0 ИЛИ ДД.НДСУпр <> 0)
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВозвратТоваровМеждуОрганизациями
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.КорректировкаПриобретения
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ВЫБОР
		|		КОГДА НЕ Потребление.Подразделение ЕСТЬ NULL
		|			ТОГДА Потребление.Подразделение
		|		КОГДА НЕ Сторно.Подразделение ЕСТЬ NULL
		|			ТОГДА Сторно.Подразделение
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
		|			ТОГДА Аналитика.Подразделение
		|		ИНАЧЕ ЕСТЬNULL(Склады.Подразделение, ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
		|	КОНЕЦ,
		|	ЕСТЬNULL(Потребление.НаправлениеДеятельности,
		|		ЕСТЬNULL(Назначения.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))),
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	ДД.АналитикаУчетаПартий.Контрагент,
		|	ДД.ДокументПоступления,
		|	(ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|			ТОГДА ДД.КорВидДеятельностиНДС
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС) ТОГДА
		|			(ВЫБОР
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.КорВидДеятельностиНДС
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.ВидДеятельностиНДС
		|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию) КОНЕЦ)
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НМА)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС КОНЕЦ),
		|	ДД.АналитикаУчетаПартий.ВидЦенности,
		|	ДД.АналитикаУчетаПартий.СтавкаНДС
		|";
КонецФункции

Функция ТекстПоступленияПартийНДСКРаспределениюИзПриходовСебестоимости()// использует ПриходыТоваровНДС
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПоступленияПартийНДСКРаспределениюИзПриходовСебестоимости"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ВЫБОР
		|		КОГДА НЕ Потребление.Подразделение ЕСТЬ NULL
		|			ТОГДА Потребление.Подразделение
		|		КОГДА НЕ СторноТоваров.Подразделение ЕСТЬ NULL
		|			ТОГДА СторноТоваров.Подразделение
		|		КОГДА ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
		|			ТОГДА Аналитика.Подразделение
		|		ИНАЧЕ ЕСТЬNULL(Склады.Подразделение, ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
		|	КОНЕЦ КАК Подразделение,
		|	ЕСТЬNULL(Потребление.НаправлениеДеятельности,
		|		ЕСТЬNULL(Назначения.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))) КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.АналитикаУчетаПартий.Контрагент КАК Поставщик,
		|	ДД.ДокументПоступления КАК ДокументПоступленияРасходов,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаПартий.ВидЦенности КАК ВидЦенности,
		|	ДД.АналитикаУчетаПартий.СтавкаНДС КАК СтавкаНДС,
		|	ДД.СтоимостьБезНДС КАК СтоимостьРегл,
		|	ДД.НДС КАК НДСРегл,
		|	ДД.НДСУпр КАК НДСУпр
		|ИЗ
		|	ПриходыТоваровНДС КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Склады КАК Склады
		|		ПО Аналитика.МестоХранения = Склады.Ссылка
		|			ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
		|		ПО Назначения.Ссылка = Аналитика.Назначение
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВнутреннееПотреблениеТоваров КАК Потребление
		|		ПО Потребление.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПрочееОприходованиеТоваров КАК СторноТоваров
		|		ПО СторноТоваров.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
		|		ПО Статья.Ссылка = ДД.СтатьяРасходовАктивов
		|
		|ГДЕ
		|	ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|	И ДД.ТипЗаписи В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы))
		|";
КонецФункции

Функция ТекстПоступленияПартийНДСКРаспределениюИзПартийНДС2_4()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПоступленияПартийНДСКРаспределениюИзПартийНДС2_4"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ВЫБОР
		|		КОГДА НЕ Потребление.Подразделение ЕСТЬ NULL
		|			ТОГДА Потребление.Подразделение
		|		КОГДА НЕ Сторно.Подразделение ЕСТЬ NULL
		|			ТОГДА Сторно.Подразделение
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
		|			ТОГДА Аналитика.Подразделение
		|		ИНАЧЕ ЕСТЬNULL(Склады.Подразделение, ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
		|	КОНЕЦ КАК Подразделение,
		|	ЕСТЬNULL(Потребление.НаправлениеДеятельности, ДД.НаправлениеДеятельности) КАК НаправлениеДеятельности,
		|	ДД.СтатьяРасходовАктивов КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов КАК АналитикаАктивовПассивов,
		|	ДД.АналитикаУчетаДокументаПоступления.Контрагент КАК Поставщик,
		|	ДД.ДокументПоступления КАК ДокументПоступленияРасходов,
		|	(ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|			ТОГДА ДД.КорВидДеятельностиНДС
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС) ТОГДА
		|			(ВЫБОР
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.КорВидДеятельностиНДС
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.ВидДеятельностиНДС
		|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию) КОНЕЦ)
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НМА)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС КОНЕЦ) КАК ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаДокументаПоступления.ВидЦенности КАК ВидЦенности,
		|	ДД.АналитикаУчетаДокументаПоступления.СтавкаНДС КАК СтавкаНДС,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьРегл,
		|	СУММА(ДД.НДС) КАК НДСРегл,
		|	СУММА(ДД.НДСУпр) КАК НДСУпр
		|ИЗ
		|	ВТКэшРасчетныеОборотыДетализацияПартийТоваровДляНДСиУСН2_4 КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВнутреннееПотреблениеТоваров КАК Потребление
		|		ПО Потребление.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПрочееОприходованиеТоваров КАК Сторно
		|		ПО Сторно.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
		|		ПО Статья.Ссылка = ДД.СтатьяРасходовАктивов
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиАктивовПассивов КАК СтатьяАктивов
		|		ПО СтатьяАктивов.Ссылка = ДД.СтатьяРасходовАктивов
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Склады КАК Склады
		|		ПО Аналитика.МестоХранения = Склады.Ссылка
		|			ПО Аналитика.Ссылка = ДД.КорАналитикаУчетаНоменклатуры
		|ГДЕ
		|	НЕ ДД.СлужебноеВидДвиженияПриход
		|	И (Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
		|		ИЛИ Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|			И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС)
		|		ИЛИ ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|		ИЛИ НЕ СтатьяАктивов.Ссылка ЕСТЬ NULL
		|			И ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|		ИЛИ НЕ СтатьяАктивов.Ссылка ЕСТЬ NULL
		|			И ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортСырьевыхТоваровУслуг)
		|		ИЛИ НЕ Статья.Ссылка ЕСТЬ NULL
		|			И ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортСырьевыхТоваровУслуг)
		|	)
		|	И (ДД.НДС <> 0 ИЛИ ДД.НДСУпр <> 0)
		|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВозвратТоваровМеждуОрганизациями
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.КорректировкаПриобретения
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ВЫБОР
		|		КОГДА НЕ Потребление.Подразделение ЕСТЬ NULL
		|			ТОГДА Потребление.Подразделение
		|		КОГДА НЕ Сторно.Подразделение ЕСТЬ NULL
		|			ТОГДА Сторно.Подразделение
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
		|			ТОГДА Аналитика.Подразделение
		|		ИНАЧЕ ЕСТЬNULL(Склады.Подразделение, ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
		|	КОНЕЦ,
		|	ЕСТЬNULL(Потребление.НаправлениеДеятельности, ДД.НаправлениеДеятельности),
		|	ДД.СтатьяРасходовАктивов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивов,
		|	ДД.АналитикаУчетаДокументаПоступления.Контрагент,
		|	ДД.ДокументПоступления,
		|	(ВЫБОР
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|			ТОГДА ДД.КорВидДеятельностиНДС
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС) ТОГДА
		|			(ВЫБОР
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.КорВидДеятельностиНДС
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.ВидДеятельностиНДС
		|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию) КОНЕЦ)
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НМА)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|		КОГДА ДД.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.ВидДеятельностиНДС
		|		ИНАЧЕ ДД.КорВидДеятельностиНДС КОНЕЦ),
		|	ДД.АналитикаУчетаДокументаПоступления.ВидЦенности,
		|	ДД.АналитикаУчетаДокументаПоступления.СтавкаНДС
		|";
КонецФункции

Функция ТекстПоступленияПартийНДСКРаспределениюИзПриходовСебестоимости2_4()// использует ПриходыТоваровНДС
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПоступленияПартийНДСКРаспределениюИзПриходовСебестоимости2_4"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ВЫБОР
		|		КОГДА НЕ Потребление.Подразделение ЕСТЬ NULL
		|			ТОГДА Потребление.Подразделение
		|		КОГДА НЕ СторноТоваров.Подразделение ЕСТЬ NULL
		|			ТОГДА СторноТоваров.Подразделение
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
		|	КОНЕЦ КАК Подразделение,
		|	ЕСТЬNULL(Потребление.НаправлениеДеятельности, ДД.НаправлениеДеятельности) КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.АналитикаУчетаДокументаПоступления.Контрагент КАК Поставщик,
		|	ДД.ДокументПоступления КАК ДокументПоступленияРасходов,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.АналитикаУчетаДокументаПоступления.ВидЦенности КАК ВидЦенности,
		|	ДД.АналитикаУчетаДокументаПоступления.СтавкаНДС КАК СтавкаНДС,
		|	ДД.СтоимостьБезНДС КАК СтоимостьРегл,
		|	ДД.НДС КАК НДСРегл,
		|	ДД.НДСУпр КАК НДСУпр
		|ИЗ
		|	ПриходыТоваровНДС2_4 КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВнутреннееПотреблениеТоваров КАК Потребление
		|		ПО Потребление.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПрочееОприходованиеТоваров КАК СторноТоваров
		|		ПО СторноТоваров.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
		|		ПО Статья.Ссылка = ДД.СтатьяРасходовАктивов
		|
		|ГДЕ
		|	ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|	И ДД.ТипЗаписи В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы))
		|";
КонецФункции

#КонецОбласти

#Область ПроцедурыЭтапов_Контекстные

// Используется для всех вызовов заполнения расчетной партии.
//
Процедура ЗаполнитьРасчетнуюПартию(ПараметрыРасчета, Контекст, РасчетнаяПартия, Расход, Приход, ПартияЗаполнена) Экспорт
	
	Если Контекст = "ПодготовкаДанныхДляУчетаНДСиУСН" Тогда
		// Этап 11
		ЗаполнитьРасчетнуюПартиюНДС(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход);
		ПартияЗаполнена = Истина;
	ИначеЕсли Контекст = "ПодготовкаДанныхДляУчетаНДСиУСН2_4"
	Тогда
		// Этап 11.2 или 11.3
		ЗаполнитьРасчетнуюПартиюНДС2_4(ПараметрыРасчета, РасчетнаяПартия, Расход, Приход);
		ПартияЗаполнена = Истина;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ВключитьИсключитьНДСВСтоимость

// Этап 3.1
Процедура ВключитьИсключитьНДСВСтоимость(ПараметрыРасчета) Экспорт

	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "ВключитьИсключитьНДСВСтоимость");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиКорректировкаСтоимости.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Партии.Регистратор,
	|	Партии.Организация,
	|	Партии.АналитикаУчетаНоменклатуры,
	|	Партии.ДокументПоступления,
	|	Партии.ВидЗапасов,
	|	Партии.СтатьяРасходовСписания,
	|	Партии.АналитикаРасходов
	|ПОМЕСТИТЬ РасходыПартий
	|ИЗ
	|	РегистрНакопления.ПартииТоваровОрганизаций КАК Партии
	|ГДЕ
	|	НЕ &ПартионныйУчетВерсии22
	|	И Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Партии.Активность
	|	И Партии.Организация В(&МассивОрганизаций)
	|	И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И Партии.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)
	|ИНДЕКСИРОВАТЬ ПО
	|	Партии.Регистратор
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	УчетСебестоимости.Период,
	|	УчетСебестоимости.Регистратор,
	|	УчетСебестоимости.Организация,
	|	УчетСебестоимости.АналитикаУчетаНоменклатуры,
	|	УчетСебестоимости.Партия,
	|	УчетСебестоимости.АналитикаФинансовогоУчета,
	|	УчетСебестоимости.ВидДеятельностиНДС
	|ПОМЕСТИТЬ ДвиженияСебестоимости
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК УчетСебестоимости
	|ГДЕ
	|	&ПартионныйУчетВерсии22
	|	И НЕ УчетСебестоимости.СлужебноеВидДвиженияПриход
	|	И УчетСебестоимости.Организация В(&ОрганизацииСУчетомПартийНДСВерсии22)
	|	И (УчетСебестоимости.КорРазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|		ИЛИ УчетСебестоимости.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			И УчетСебестоимости.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО)
	|	И УчетСебестоимости.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|	И УчетСебестоимости.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию)
	|	И УчетСебестоимости.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
	|ИНДЕКСИРОВАТЬ ПО
	|	Период,
	|	Регистратор,
	|	Организация,
	|	АналитикаУчетаНоменклатуры,
	|	Партия,
	|	АналитикаФинансовогоУчета,
	|	ВидДеятельностиНДС
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Партии.Период КАК Период,
	|	Партии.Регистратор КАК Регистратор,
	|	Партии.Организация КАК Организация,
	|	Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Партии.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов КАК ВидЗапасов,
	|	Партии.Партия КАК Партия,
	|	Партии.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Партии.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	Партии.АналитикаРасходов КАК АналитикаРасходов,
	|	Партии.СтатьяСписанияНДС,
	|	Партии.АналитикаСписанияНДС,
	|	СУММА(Партии.Количество) КАК Количество,
	|	СУММА(
	|		ВЫБОР КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА 0
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		ТОГДА
	|			Партии.НДСРегл
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) < &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			Партии.НДСРегл
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		ТОГДА
	|			-Партии.НДСРегл
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) >= &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			-Партии.НДСРегл
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ
	|	) КАК НДСРегл,
	|	СУММА(
	|		ВЫБОР КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА 0
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		ТОГДА
	|			Партии.НДСУпр
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) < &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			Партии.НДСУпр
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		ТОГДА
	|			-Партии.НДСУпр
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) >= &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			-Партии.НДСУпр
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ
	|	) КАК НДСУпр
	|
	|ПОМЕСТИТЬ ВтПартии
	|ИЗ (
	|	ВЫБРАТЬ
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Партии.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|		Партии.ВидЗапасов КАК ВидЗапасов,
	|		НЕОПРЕДЕЛЕНО КАК Партия,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
	|		Партии.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|		Партии.АналитикаРасходов КАК АналитикаРасходов,
	|		Партии.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
	|		Партии.НалогообложениеНДС,
	|		Партии.ДокументПоступления,
	|		Партии.Количество КАК Количество,
	|		Партии.НДСРегл КАК НДСРегл,
	|		0 КАК НДСУпр,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровОрганизаций КАК Партии
	|	ГДЕ
	|		НЕ &ПартионныйУчетВерсии22
	|		И Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Партии.Активность
	|		И Партии.Организация В(&МассивОрганизаций)
	|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Партии.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.АналитикаУчетаПродукции КАК АналитикаУчетаНоменклатуры,
	|		Партии.КорАналитикаУчетаПродукции КАК КорАналитикаУчетаНоменклатуры,
	|		РасходыПартий.ВидЗапасов КАК ВидЗапасов,
	|		НЕОПРЕДЕЛЕНО КАК Партия,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
	|		Партии.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|		Партии.АналитикаРасходов КАК АналитикаРасходов,
	|		Партии.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
	|		Партии.НалогообложениеНДС,
	|		Партии.ДокументПоступления,
	|		0 КАК Количество,
	|		Партии.НДСРегл КАК НДСРегл,
	|		0 КАК НДСУпр,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС
	|	ИЗ
	|		РегистрНакопления.ПартииЗатратНаВыпуск КАК Партии
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РасходыПартий КАК РасходыПартий
	|			ПО РасходыПартий.Регистратор = Партии.Регистратор
	|			И РасходыПартий.Организация = Партии.Организация
	|			И РасходыПартий.АналитикаУчетаНоменклатуры = Партии.АналитикаУчетаПродукции
	|			И РасходыПартий.ДокументПоступления = Партии.ДокументВыпуска
	|			И РасходыПартий.СтатьяРасходовСписания = Партии.СтатьяРасходовСписания
	|			И РасходыПартий.АналитикаРасходов = Партии.АналитикаРасходов 
	|	ГДЕ
	|		НЕ &ПартионныйУчетВерсии22
	|		И Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Партии.Активность
	|		И Партии.Организация В(&МассивОрганизаций)
	|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Партии.НДСРегл <> 0
	|		И Партии.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Партии.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|		Партии.ВидЗапасов КАК ВидЗапасов,
	|		НЕОПРЕДЕЛЕНО КАК Партия,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
	|		Партии.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|		Партии.АналитикаРасходов КАК АналитикаРасходов,
	|		Партии.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
	|		Партии.НалогообложениеНДС,
	|		Партии.ДокументПоступления,
	|		0 КАК Количество,
	|		Партии.НДСРегл КАК НДСРегл,
	|		0 КАК НДСУпр,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС
	|	ИЗ
	|		РегистрНакопления.ПартииРасходовНаСебестоимостьТоваров КАК Партии
	|	ГДЕ
	|		НЕ &ПартионныйУчетВерсии22
	|		И Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Партии.Активность
	|		И Партии.Организация В(&МассивОрганизаций)
	|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Партии.НДСРегл <> 0
	|		И Партии.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Партии.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|		Партии.ВидЗапасов КАК ВидЗапасов,
	|		(ВЫБОР
	|			КОГДА ДвиженияСебестоимости.Регистратор ЕСТЬ NULL ТОГДА НЕОПРЕДЕЛЕНО
	|			ИНАЧЕ Партии.Партия КОНЕЦ) КАК Партия,
	|		Партии.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|		Партии.СтатьяРасходовАктивов КАК СтатьяРасходовСписания,
	|		Партии.АналитикаРасходов КАК АналитикаРасходов,
	|		Партии.ВидДеятельностиНДС КАК НалогообложениеПартии,
	|		Партии.КорВидДеятельностиНДС КАК НалогообложениеНДС,
	|		Партии.ДокументПоступления,
	|		(ВЫБОР
	|			КОГДА Партии.ТипЗаписи В (
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
	|				ТОГДА (ВЫБОР
	|					КОГДА Партии.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|						ТОГДА Партии.СтоимостьБезНДС + Партии.НДС
	|					КОГДА Партии.СтоимостьБезНДС = 0 ТОГДА Партии.НДС
	|					ИНАЧЕ Партии.СтоимостьБезНДС КОНЕЦ)
	|			ИНАЧЕ Партии.Количество КОНЕЦ) КАК Количество,
	|		Партии.НДС КАК НДСРегл,
	|		Партии.НДСУпр КАК НДСУпр,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС
	|	ИЗ
	|		ВТКэшРасчетныеОборотыДетализацияПартийТоваровДляНДСиУСН КАК Партии
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДвиженияСебестоимости КАК ДвиженияСебестоимости
	|		 ПО ДвиженияСебестоимости.Период = Партии.Период
	|		 И ДвиженияСебестоимости.Регистратор = Партии.Регистратор
	|		 И ДвиженияСебестоимости.Организация = Партии.Организация
	|		 И ДвиженияСебестоимости.АналитикаУчетаНоменклатуры = Партии.АналитикаУчетаНоменклатуры
	|		 И ДвиженияСебестоимости.Партия = Партии.Партия
	|		 И ДвиженияСебестоимости.АналитикаФинансовогоУчета = Партии.АналитикаФинансовогоУчета
	|		 И ДвиженияСебестоимости.ВидДеятельностиНДС = Партии.ВидДеятельностиНДС
	|	ГДЕ
	|		&ПартионныйУчетВерсии22
	|		И Партии.Организация В(&ОрганизацииСУчетомПартийНДСВерсии22)
	|		И НЕ Партии.СлужебноеВидДвиженияПриход
	|
	|	) КАК Партии
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|	ПО
	|		ДанныеПервичныхДокументов.Организация = Партии.Организация
	|		И ДанныеПервичныхДокументов.Документ = Партии.ДокументПоступления
	|	
	|ГДЕ
	|	НЕ Партии.НалогообложениеПартии ЕСТЬ NULL
	|	И Партии.НалогообложениеПартии <> Партии.НалогообложениеНДС
	|	И Партии.НалогообложениеНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|
	|СГРУППИРОВАТЬ ПО
	|	Партии.Период,
	|	Партии.Регистратор,
	|	Партии.Организация,
	|	Партии.АналитикаУчетаНоменклатуры,
	|	Партии.КорАналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов,
	|	Партии.Партия,
	|	Партии.АналитикаФинансовогоУчета,
	|	Партии.СтатьяРасходовСписания,
	|	Партии.АналитикаРасходов,
	|	Партии.СтатьяСписанияНДС,
	|	Партии.АналитикаСписанияНДС
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Партии.Регистратор КАК Регистратор
	|ПОМЕСТИТЬ ВтРегистраторы
	|ИЗ
	|	ВтПартии КАК Партии
	|ГДЕ
	|	Партии.НДСРегл <> 0
	|	ИЛИ Партии.НДСУпр <> 0
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	2 КАК Порядок,
	|	УчетСебестоимости.Период КАК Период,
	|	УчетСебестоимости.Регистратор КАК Регистратор,
	|	УчетСебестоимости.Организация КАК Организация,
	|	УчетСебестоимости.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	УчетСебестоимости.ВидЗапасов КАК ВидЗапасов,
	|	УчетСебестоимости.Партия КАК Партия,
	|	УчетСебестоимости.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	ВЫБОР КОГДА УчетСебестоимости.СтатьяРасходовСписания = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ УчетСебестоимости.СтатьяРасходовСписания
	|	КОНЕЦ КАК СтатьяРасходовСписания,
	|	УчетСебестоимости.АналитикаРасходов КАК АналитикаРасходов,
	|
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	УчетСебестоимости.РазделУчета КАК РазделУчета,
	|	УчетСебестоимости.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	УчетСебестоимости.ЗаказКлиента КАК ЗаказКлиента,
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ УчетСебестоимости.ХозяйственнаяОперация КОНЕЦ) КАК ХозяйственнаяОперация,
	|	УчетСебестоимости.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровОтКлиентаПрошлыхПериодов)
	|			ТОГДА УчетСебестоимости.РазделУчета
	|		ИНАЧЕ УчетСебестоимости.КорРазделУчета КОНЕЦ) КАК КорРазделУчета,
	|	УчетСебестоимости.КорВидЗапасов КАК КорВидЗапасов,
	|	УчетСебестоимости.КорОрганизация КАК КорОрганизация,
	|	УчетСебестоимости.Подразделение КАК Подразделение,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовУпр КАК ВариантРаспределенияРасходовУпр,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовРегл КАК ВариантРаспределенияРасходовРегл,
	|	ЕСТЬNULL(УчетСебестоимости.СтатьяРасходовСписания.ПринятиеКНалоговомуУчету, ЛОЖЬ) КАК ПринятиеКНалоговомуУчету,
	|	УчетСебестоимости.ГруппаПродукции КАК ГруппаПродукции,
	|	ЕСТЬNULL(СпрНазначения.НаправлениеДеятельности,
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
	|	УчетСебестоимости.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	УчетСебестоимости.КорПартия,
	|	УчетСебестоимости.КорАналитикаУчетаПартий,
	|	УчетСебестоимости.КорАналитикаФинансовогоУчета,
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровОтКлиентаПрошлыхПериодов)
	|			ТОГДА УчетСебестоимости.ВидДеятельностиНДС
	|		ИНАЧЕ УчетСебестоимости.КорВидДеятельностиНДС КОНЕЦ) КАК КорВидДеятельностиНДС,
	|	УчетСебестоимости.Регистратор КАК ДокументДвижения,
	|	ЛОЖЬ КАК ЭтоПередачаМеждуОрганизациями,
	|
	|	СУММА(ВЫБОР
	|		КОГДА УчетСебестоимости.ТипЗаписи В (
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам),
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
	|			ТОГДА (ВЫБОР
	|				КОГДА УчетСебестоимости.ДопРасходыРегл = 0 ТОГДА УчетСебестоимости.НДСРегл
	|				ИНАЧЕ УчетСебестоимости.ДопРасходыРегл КОНЕЦ)
	|		ИНАЧЕ УчетСебестоимости.Количество КОНЕЦ) КАК Количество,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК ДопРасходы,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК СтоимостьЗабалансовая,
	|	0 КАК СтоимостьЗабалансоваяРегл,
	|	0 КАК СтоимостьРегл,
	|	0 КАК СтоимостьУпр,
	|	0 КАК ДопРасходыРегл,
	|	0 КАК ДопРасходыУпр,
	|	0 КАК НДСРегл,
	|	0 КАК НДСУпр,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	СУММА(УчетСебестоимости.Количество) КАК ИсходноеКоличество
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК УчетСебестоимости
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтРегистраторы КАК Регистраторы
	|		ПО Регистраторы.Регистратор = УчетСебестоимости.Регистратор
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаНоменклатуры
	|		ПО УчетСебестоимости.АналитикаУчетаНоменклатуры = АналитикаНоменклатуры.Ссылка
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК СпрНазначения
	|		ПО СпрНазначения.Ссылка = АналитикаНоменклатуры.Назначение
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КорАналитикаНоменклатуры
	|		ПО УчетСебестоимости.КорАналитикаУчетаНоменклатуры = КорАналитикаНоменклатуры.Ссылка
	|ГДЕ
	|	(НЕ УчетСебестоимости.СлужебноеВидДвиженияПриход
	|		ИЛИ УчетСебестоимости.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов))
	|	И (УчетСебестоимости.КорРазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|		ИЛИ УчетСебестоимости.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			И УчетСебестоимости.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО)
	|	И УчетСебестоимости.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|	И УчетСебестоимости.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию)
	|	И УчетСебестоимости.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
	|	
	|СГРУППИРОВАТЬ ПО
	|	УчетСебестоимости.Период,
	|	УчетСебестоимости.Регистратор,
	|	УчетСебестоимости.Организация,
	|	УчетСебестоимости.АналитикаУчетаНоменклатуры,
	|	УчетСебестоимости.ВидЗапасов,
	|	УчетСебестоимости.Партия,
	|	УчетСебестоимости.АналитикаФинансовогоУчета,
	|	ВЫБОР КОГДА УчетСебестоимости.СтатьяРасходовСписания = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ УчетСебестоимости.СтатьяРасходовСписания
	|	КОНЕЦ,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовУпр,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовРегл,
	|	ЕСТЬNULL(УчетСебестоимости.СтатьяРасходовСписания.ПринятиеКНалоговомуУчету, ЛОЖЬ),
	|	УчетСебестоимости.АналитикаРасходов,
	|
	|	УчетСебестоимости.РазделУчета,
	|	УчетСебестоимости.АналитикаУчетаПоПартнерам,
	|	УчетСебестоимости.ЗаказКлиента,
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ УчетСебестоимости.ХозяйственнаяОперация КОНЕЦ),
	|	УчетСебестоимости.КорАналитикаУчетаНоменклатуры,
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровОтКлиентаПрошлыхПериодов)
	|			ТОГДА УчетСебестоимости.РазделУчета
	|		ИНАЧЕ УчетСебестоимости.КорРазделУчета КОНЕЦ), // КорРазделУчета
	|	УчетСебестоимости.КорВидЗапасов,
	|	УчетСебестоимости.КорОрганизация,
	|	УчетСебестоимости.Подразделение,
	|	УчетСебестоимости.ГруппаПродукции,
	|	ЕСТЬNULL(СпрНазначения.НаправлениеДеятельности,
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
	|	УчетСебестоимости.КорНаправлениеДеятельности,
	|	УчетСебестоимости.КорПартия,
	|	УчетСебестоимости.КорАналитикаУчетаПартий,
	|	УчетСебестоимости.КорАналитикаФинансовогоУчета,
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровОтКлиентаПрошлыхПериодов)
	|			ТОГДА УчетСебестоимости.ВидДеятельностиНДС
	|		ИНАЧЕ УчетСебестоимости.КорВидДеятельностиНДС КОНЕЦ) // КорВидДеятельностиНДС
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	1 КАК Порядок,
	|	Партии.Период КАК Период,
	|	Партии.Регистратор КАК Регистратор,
	|	Партии.Организация КАК Организация,
	|	Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов КАК ВидЗапасов,
	|	Партии.Партия КАК Партия,
	|	Партии.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Партии.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	Партии.АналитикаРасходов КАК АналитикаРасходов,
	|
	|	НЕОПРЕДЕЛЕНО КАК ВидДвижения,
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
	|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
	|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
	|	Партии.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
	|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
	|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
	|	НЕОПРЕДЕЛЕНО КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовУпр,
	|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовРегл,
	|	НЕОПРЕДЕЛЕНО КАК ПринятиеКНалоговомуУчету,
	|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК КорПартия,
	|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
	|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
	|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
	|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
	|	ЛОЖЬ 		 КАК ЭтоПередачаМеждуОрганизациями,
	|
	|	СУММА(ВЫБОР
	|		КОГДА Партии.Количество < 0
	|			ТОГДА -Партии.Количество
	|		ИНАЧЕ Партии.Количество КОНЕЦ) КАК Количество,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК ДопРасходы,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК СтоимостьЗабалансовая,
	|	0 КАК СтоимостьЗабалансоваяРегл,
	|	СУММА(Партии.НДСРегл) КАК СтоимостьРегл,
	|	СУММА(Партии.НДСУпр) КАК СтоимостьУпр,
	|	0 КАК ДопРасходыРегл,
	|	0 КАК ДопРасходыУпр,
	|	0 КАК НДСРегл,
	|	0 КАК НДСУпр,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	0 КАК ИсходноеКоличество
	|ИЗ
	|	ВтПартии КАК Партии
	|
	|СГРУППИРОВАТЬ ПО
	|	Партии.Период,
	|	Партии.Регистратор,
	|	Партии.Организация,
	|	Партии.АналитикаУчетаНоменклатуры,
	|	Партии.КорАналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов,
	|	Партии.Партия,
	|	Партии.АналитикаФинансовогоУчета,
	|	Партии.СтатьяРасходовСписания,
	|	Партии.АналитикаРасходов
	|
	|ИМЕЮЩИЕ
	|	(СУММА(Партии.НДСРегл) <> 0
	|	ИЛИ СУММА(Партии.НДСУпр) <> 0)
	|	И СУММА(ВЫБОР
	|		КОГДА Партии.Количество < 0
	|			ТОГДА -Партии.Количество
	|		ИНАЧЕ Партии.Количество КОНЕЦ) <> 0
	|
	|УПОРЯДОЧИТЬ ПО
	|	Регистратор,
	|	Организация,
	|	АналитикаУчетаНоменклатуры,
	|	ВидЗапасов,
	|	Партия,
	|	АналитикаФинансовогоУчета,
	|	СтатьяРасходовСписания,
	|	АналитикаРасходов,
	|	КорАналитикаУчетаНоменклатуры,
	|	Порядок
	|";
	
	ЗаписьРаспределения = Новый Структура("
	|Период, АналитикаУчетаНоменклатуры, РазделУчета, ВидЗапасов, Организация, Склад, Партия, АналитикаФинансовогоУчета,
	|ХозяйственнаяОперация, ЗаказКлиента, ТипЗапасов, АналитикаУчетаПоПартнерам, ЭтоПередачаМеждуОрганизациями,
	|КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорТипЗапасов, КорОрганизация,
	|АналитикаУчетаНоменклатурыВО, АналитикаФинансовогоУчетаВО, АналитикаАктивовПассивов, КорСклад,
	|СтатьяАктивовПассивов, Подразделение, АналитикаРасходов, СтатьяРасходовСписания, СтатьяДоходов, АналитикаДоходов,
	|ВариантРаспределенияРасходовУпр, ВариантРаспределенияРасходовРегл,
	|ДокументДвижения, ИдентификаторСтроки, ПринятиеКНалоговомуУчету, ГруппаПродукции, СписаниеПриПередачеНУ,
	|ИсточникГФУНоменклатуры, КорИсточникГФУНоменклатуры, НаправлениеДеятельности, КорНаправлениеДеятельности,
	|Стоимость, СтоимостьБезНДС, Количество, КорСтоимость, ПостояннаяРазница, ВременнаяРазница,
	|ДопРасходы, ДопРасходыБезНДС, СтоимостьРегл, НДСРегл,
	|КорПартия, КорАналитикаУчетаПартий, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС,
	|СтатьяКалькуляции, ТипЗаписи, ДокументИсточник,
	|СтоимостьЗабалансовая, Трудозатраты, ПостатейныеПостоянныеСНДС, ПостатейныеПостоянныеБезНДС,
	|СтоимостьЗабалансоваяРегл, ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеПостоянныеРегл,
	|ПостатейныеПеременныеСНДС, ПостатейныеПеременныеБезНДС, ПостатейныеПеременныеРегл,
	|СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр, НДСУпр
	|");
	
	СуммыРаспределения = Новый Структура("
	|Количество, Стоимость, СтоимостьБезНДС, СтоимостьЗабалансовая, СтоимостьРегл, СтоимостьУпр, СтоимостьЗабалансоваяРегл, НДСРегл, НДСУпр,
	|ДопРасходы, ДопРасходыБезНДС, ДопРасходыРегл, ДопРасходыУпр, ПостояннаяРазница, ВременнаяРазница
	|");
	
	СтрокаОстатка = Новый Структура("
	|Регистратор, Организация, АналитикаУчетаНоменклатуры, ВидЗапасов, Партия, АналитикаФинансовогоУчета, СтатьяРасходовСписания, АналитикаРасходов,
	|КорАналитикаУчетаНоменклатуры,
	|Количество, Стоимость, СтоимостьБезНДС, СтоимостьЗабалансовая, СтоимостьРегл, СтоимостьУпр, СтоимостьЗабалансоваяРегл, НДСРегл, НДСУпр,
	|ДопРасходы, ДопРасходыБезНДС, ДопРасходыРегл, ДопРасходыУпр, ПостояннаяРазница, ВременнаяРазница
	|");
	
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина,,,
		Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя);
	
	// Формируются движения по регистрам:
	// - СебестоимостьТоваров
	// - ПрочиеРасходы
	Пока Выборка.Следующий() Цикл
		
		Если Выборка.Порядок = 1 Тогда
			
			ЗаполнитьЗначенияСвойств(СтрокаОстатка, Выборка);
			
		ИначеЕсли СтрокаОстатка.Регистратор = Выборка.Регистратор
			И СтрокаОстатка.Организация = Выборка.Организация
			И СтрокаОстатка.АналитикаУчетаНоменклатуры = Выборка.АналитикаУчетаНоменклатуры
			И (СтрокаОстатка.КорАналитикаУчетаНоменклатуры = Выборка.КорАналитикаУчетаНоменклатуры
				ИЛИ НЕ ЗначениеЗаполнено(Выборка.КорРазделУчета))
			И СтрокаОстатка.ВидЗапасов = Выборка.ВидЗапасов
			И СтрокаОстатка.Партия = Выборка.Партия
			И СтрокаОстатка.АналитикаФинансовогоУчета = Выборка.АналитикаФинансовогоУчета
			И СтрокаОстатка.СтатьяРасходовСписания = Выборка.СтатьяРасходовСписания
			И СтрокаОстатка.АналитикаРасходов = Выборка.АналитикаРасходов Тогда
			
			ЗаполнитьЗначенияСвойств(ЗаписьРаспределения, Выборка);
			
			РасчетСебестоимостиКорректировкаСтоимости.РаспределитьСтоимость(СуммыРаспределения, СтрокаОстатка, Выборка, Выборка.Количество);
			РасчетСебестоимостиКорректировкаСтоимости.ДополнитьСуммыРаспределения(ЗаписьРаспределения, СуммыРаспределения);
			
			Если ЗаписьРаспределения.СтоимостьРегл <> 0 ИЛИ ЗаписьРаспределения.СтоимостьУпр <> 0 Тогда
					
				// Если есть кор. раздел - необходимо скорректировать стоимость в кор. части.
				Если ЗначениеЗаполнено(ЗаписьРаспределения.КорРазделУчета) Тогда
					
					РасчетСебестоимостиКорректировкаСтоимости.СформироватьКорДвиженияСебестоимостьТоваров(ПараметрыРасчета, ЗаписьРаспределения, ПараметрыРасчета.ПредварительныйРасчет);
							
				КонецЕсли;
				
				Если ПараметрыРасчета.ПредварительныйРасчет Тогда
					Продолжить;
				КонецЕсли;
				
				// Корректировка списания товаров на затраты в регистре учет прочих расходов.
				Если Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СписаниеТоваров
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СписаниеТоваровПоТребованию
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СторноСписанияНаРасходы
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПересортицаТоваровСПереоценкой
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПорчаТоваровСПереоценкой
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратТоваровПоставщику
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаНаПрочиеЦели
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаВЭксплуатацию
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ОтчетКомиссионераОСписании Тогда
				 	
				 	СуммовыеПоказатели = Новый Структура;
					СуммовыеПоказатели.Вставить("СуммаСНДС", 0);
					СуммовыеПоказатели.Вставить("СуммаБезНДС", 0);
					СуммовыеПоказатели.Вставить("СуммаРегл", ЗаписьРаспределения.СтоимостьРегл);
					СуммовыеПоказатели.Вставить("СуммаУпр", ЗаписьРаспределения.СтоимостьУпр);
					СуммовыеПоказатели.Вставить("ПостояннаяРазница", 0);
					СуммовыеПоказатели.Вставить("ВременнаяРазница", 0);
				 
				 	РасчетСебестоимостиКорректировкаСтоимости.СформироватьДвиженияПрочиеРасходы(
				 		ПараметрыРасчета,
						ЗаписьРаспределения,
						СуммовыеПоказатели);
					
				КонецЕсли;

			КонецЕсли;
			
		КонецЕсли;

	КонецЦикла;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, "РасходыПартий, ДвиженияСебестоимости, ВтПартии, ВтРегистраторы");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвижения(ПараметрыРасчета);
	
КонецПроцедуры

// Этап 3.1.2
Процедура ВключитьИсключитьНДСВСтоимость24(ПараметрыРасчета) Экспорт

	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "ВключитьИсключитьНДСВСтоимость24");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиКорректировкаСтоимости.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	ВыполненРасчетПартийНДС = РасчетСебестоимостиПрикладныеАлгоритмы.ВременнаяТаблицаСуществует(ПараметрыРасчета, "ЗнаменателиРасходов");
	
	Если НЕ ВыполненРасчетПартийНДС Тогда
		
		Запрос.Текст =
		"ВЫБРАТЬ ПЕРВЫЕ 0
		|	ДД.Регистратор КАК Регистратор,
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	ДД.РазделУчета КАК РазделУчета,
		|	ДД.ВидЗапасов КАК ВидЗапасов,
		|	ДД.Организация КАК Организация,
		|	ДД.Партия КАК Партия,
		|	ДД.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
		|	ДД.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
		|	ДД.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
		|	0 КАК Знаменатель
		|ПОМЕСТИТЬ ЗнаменателиРасходов
		|ИЗ
		|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|";
		
	КонецЕсли;
	
	Запрос.Текст = Запрос.Текст  + "
	|ВЫБРАТЬ
	|	Партии.Период КАК Период,
	|	Партии.Регистратор КАК Регистратор,
	|	Партии.Организация КАК Организация,
	|	Партии.АналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов,
	|	Партии.Партия КАК Партия,
	|	Партии.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Партии.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	Партии.АналитикаРасходов КАК АналитикаРасходов,
	|	Партии.АналитикаУчетаНоменклатурыДляСвязи,
	|	Партии.ВидЗапасовДляСвязи,
	|	Партии.КорВидДеятельностиНДС,
	|	Партии.ВидДеятельностиНДС,
	|
	|	СУММА(Партии.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	СУММА(Партии.СтоимостьБезНДСУпр) КАК СтоимостьБезНДСУпр,
	|	СУММА(
	|		ВЫБОР КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА 0
	|		КОГДА Партии.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		ТОГДА
	|			Партии.НДСРегл
	|
	|		КОГДА Партии.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) < &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			Партии.НДСРегл
	|
	|		КОГДА Партии.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		ТОГДА
	|			-Партии.НДСРегл
	|		КОГДА Партии.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) >= &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			-Партии.НДСРегл
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ
	|	) КАК НДСРегл,
	|	СУММА(
	|		ВЫБОР КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА 0
	|		КОГДА Партии.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		ТОГДА
	|			Партии.НДСУпр
	|
	|		КОГДА Партии.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) < &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			Партии.НДСУпр
	|
	|		КОГДА Партии.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		ТОГДА
	|			-Партии.НДСУпр
	|		КОГДА Партии.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) >= &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			-Партии.НДСУпр
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ
	|	) КАК НДСУпр,
	|	СУММА(ВЫБОР
	|		КОГДА Партии.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|			ТОГДА Партии.СтоимостьБезНДС + Партии.НДСРегл
	|		КОГДА Партии.СтоимостьБезНДС = 0
	|			ТОГДА Партии.НДСРегл
	|		ИНАЧЕ Партии.СтоимостьБезНДС КОНЕЦ) КАК Знаменатель
	|
	|ПОМЕСТИТЬ ВтПартии
	|ИЗ (
	|	ВЫБРАТЬ
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|		ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
	|		Партии.Партия КАК Партия,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
	|		Партии.СтатьяРасходовАктивов КАК СтатьяРасходовСписания,
	|		Партии.АналитикаРасходов КАК АналитикаРасходов,
	|		Партии.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|		Партии.КорВидДеятельностиНДС КАК КорВидДеятельностиНДС,
	|		Партии.ДокументПоступления КАК ДокументПоступления,
	|		Партии.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|		Партии.СтоимостьБезНДСУпр КАК СтоимостьБезНДСУпр,
	|		Партии.НДС КАК НДСРегл,
	|		Партии.НДСУпр КАК НДСУпр,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатурыДляСвязи,
	|		Партии.КорВидЗапасов КАК ВидЗапасовДляСвязи
	|	ИЗ
	|		ВТКэшРасчетныеОборотыДетализацияПартийТоваровДляНДСиУСН2_4 КАК Партии
	|	ГДЕ
	|		&ПартионныйУчетВерсии22
	|		И Партии.Организация В(&ОрганизацииСУчетомПартийНДСВерсии24)
	|		И НЕ Партии.СлужебноеВидДвиженияПриход
	|
	|	) КАК Партии
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|	ПО
	|		ДанныеПервичныхДокументов.Организация = Партии.Организация
	|		И ДанныеПервичныхДокументов.Документ = Партии.ДокументПоступления
	|ГДЕ
	|	НЕ Партии.ВидДеятельностиНДС ЕСТЬ NULL
	|	И Партии.ВидДеятельностиНДС <> Партии.КорВидДеятельностиНДС
	|	И Партии.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|
	|СГРУППИРОВАТЬ ПО
	|	Партии.Период,
	|	Партии.Регистратор,
	|	Партии.Организация,
	|	Партии.АналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов,
	|	Партии.КорВидДеятельностиНДС,
	|	Партии.ВидДеятельностиНДС,
	|	Партии.Партия,
	|	Партии.АналитикаФинансовогоУчета,
	|	Партии.СтатьяРасходовСписания,
	|	Партии.АналитикаРасходов,
	|	Партии.АналитикаУчетаНоменклатурыДляСвязи,
	|	Партии.ВидЗапасовДляСвязи
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Партии.Регистратор КАК Регистратор
	|ПОМЕСТИТЬ ВтРегистраторы
	|ИЗ
	|	ВтПартии КАК Партии
	|ГДЕ
	|	Партии.НДСРегл <> 0
	|	ИЛИ Партии.НДСУпр <> 0
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	УчетСебестоимости.Период КАК Период,
	|	УчетСебестоимости.Регистратор КАК Регистратор,
	|	УчетСебестоимости.Организация КАК Организация,
	|	УчетСебестоимости.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	УчетСебестоимости.ВидЗапасов КАК ВидЗапасов,
	|	УчетСебестоимости.Партия КАК Партия,
	|	УчетСебестоимости.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	УчетСебестоимости.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	ВЫБОР КОГДА УчетСебестоимости.СтатьяРасходовСписания = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ УчетСебестоимости.СтатьяРасходовСписания
	|	КОНЕЦ КАК СтатьяРасходовСписания,
	|	УчетСебестоимости.АналитикаРасходов КАК АналитикаРасходов,
	|
	|	УчетСебестоимости.РазделУчета КАК РазделУчета,
	|	УчетСебестоимости.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	УчетСебестоимости.ЗаказКлиента КАК ЗаказКлиента,
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ УчетСебестоимости.ХозяйственнаяОперация КОНЕЦ) КАК ХозяйственнаяОперация,
	|	УчетСебестоимости.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|	УчетСебестоимости.КорРазделУчета КАК КорРазделУчета,
	|	УчетСебестоимости.КорВидЗапасов КАК КорВидЗапасов,
	|	УчетСебестоимости.КорОрганизация КАК КорОрганизация,
	|	УчетСебестоимости.Подразделение КАК Подразделение,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовУпр КАК ВариантРаспределенияРасходовУпр,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовРегл КАК ВариантРаспределенияРасходовРегл,
	|	ЕСТЬNULL(УчетСебестоимости.СтатьяРасходовСписания.ПринятиеКНалоговомуУчету, ЛОЖЬ) КАК ПринятиеКНалоговомуУчету,
	|	УчетСебестоимости.ГруппаПродукции КАК ГруппаПродукции,
	|	ЕСТЬNULL(СпрНазначения.НаправлениеДеятельности,
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
	|	УчетСебестоимости.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	ВЫБОР КОГДА УчетСебестоимости.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
	|		ТОГДА УчетСебестоимости.Партия
	|		ИНАЧЕ УчетСебестоимости.КорПартия
	|	КОНЕЦ КАК КорПартия,
	|	ВЫБОР КОГДА УчетСебестоимости.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
	|		ТОГДА УчетСебестоимости.АналитикаУчетаПартий
	|		ИНАЧЕ УчетСебестоимости.КорАналитикаУчетаПартий
	|	КОНЕЦ КАК КорАналитикаУчетаПартий,
	|	УчетСебестоимости.КорАналитикаФинансовогоУчета,
	|	УчетСебестоимости.ВидДеятельностиНДС,
	|	УчетСебестоимости.КорВидДеятельностиНДС,
	|	УчетСебестоимости.Регистратор КАК ДокументДвижения,
	|	ВЫБОР
	|		КОГДА УчетСебестоимости.КорАналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|		ТОГДА УчетСебестоимости.АналитикаУчетаНоменклатуры
	|		ИНАЧЕ УчетСебестоимости.КорАналитикаУчетаНоменклатуры
	|	КОНЕЦ КАК АналитикаУчетаНоменклатурыДляСвязи,
	|	ВЫБОР
	|		КОГДА УчетСебестоимости.КорВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
	|		ТОГДА УчетСебестоимости.ВидЗапасов
	|		ИНАЧЕ УчетСебестоимости.КорВидЗапасов
	|	КОНЕЦ КАК ВидЗапасовДляСвязи,
	|
	|	СУММА(ВЫБОР
	|		КОГДА УчетСебестоимости.ТипЗаписи В (
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам),
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
	|		 И УчетСебестоимости.ДопРасходыРегл	<> 0
	|			ТОГДА УчетСебестоимости.ДопРасходыРегл
	|		КОГДА НЕ ЗнаменателиРасходов.Знаменатель ЕСТЬ NULL
	|			ТОГДА ЗнаменателиРасходов.Знаменатель
	|		КОГДА ЕСТЬNULL(Цены.СтоимостьРегл + Цены.ДопРасходыРегл + Цены.ТрудозатратыРегл, 0) = 0
	|			ТОГДА УчетСебестоимости.НДСРегл
	|		ИНАЧЕ ВЫРАЗИТЬ(УчетСебестоимости.Количество * ЕСТЬNULL(Цены.СтоимостьРегл + Цены.ДопРасходыРегл + Цены.ТрудозатратыРегл, 0) КАК ЧИСЛО(31,2)) КОНЕЦ) КАК Знаменатель
	|ПОМЕСТИТЬ ВТСебестоимость
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК УчетСебестоимости
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтРегистраторы КАК Регистраторы
	|		ПО Регистраторы.Регистратор = УчетСебестоимости.Регистратор
	|	ЛЕВОЕ СОЕДИНЕНИЕ ЗнаменателиРасходов КАК ЗнаменателиРасходов
	|		ПО ЗнаменателиРасходов.Регистратор = УчетСебестоимости.Регистратор
	|		И ЗнаменателиРасходов.Партия = УчетСебестоимости.Партия
	|		И ЗнаменателиРасходов.АналитикаУчетаПартий = УчетСебестоимости.АналитикаУчетаПартий
	|		И ЗнаменателиРасходов.ВидДеятельностиНДС = УчетСебестоимости.ВидДеятельностиНДС
	|		И ЗнаменателиРасходов.АналитикаФинансовогоУчета = УчетСебестоимости.АналитикаФинансовогоУчета
	|		И ЗнаменателиРасходов.АналитикаУчетаНоменклатуры = УчетСебестоимости.АналитикаУчетаНоменклатуры
	|		И ЗнаменателиРасходов.ВидЗапасов = УчетСебестоимости.ВидЗапасов
	|		И ЗнаменателиРасходов.РазделУчета = УчетСебестоимости.РазделУчета
	|		И ЗнаменателиРасходов.Организация = УчетСебестоимости.Организация
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТСтоимостьПартийТоваровПредыдущая КАК Цены
	|		ПО Цены.Организация = УчетСебестоимости.Организация
	|		И Цены.Партия = УчетСебестоимости.Партия
	|		И Цены.АналитикаУчетаПартий = УчетСебестоимости.АналитикаУчетаПартий
	|		И Цены.АналитикаФинансовогоУчета = УчетСебестоимости.АналитикаФинансовогоУчета
	|		И Цены.ВидДеятельностиНДС = УчетСебестоимости.ВидДеятельностиНДС
	|		И Цены.АналитикаУчетаНоменклатуры = УчетСебестоимости.АналитикаУчетаНоменклатуры
	|		И Цены.ВидЗапасов = УчетСебестоимости.ВидЗапасов
	|		И Цены.РазделУчета = УчетСебестоимости.РазделУчета
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаНоменклатуры
	|		ПО УчетСебестоимости.АналитикаУчетаНоменклатуры = АналитикаНоменклатуры.Ссылка
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК СпрНазначения
	|		ПО СпрНазначения.Ссылка = АналитикаНоменклатуры.Назначение
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КорАналитикаНоменклатуры
	|		ПО УчетСебестоимости.КорАналитикаУчетаНоменклатуры = КорАналитикаНоменклатуры.Ссылка
	|ГДЕ
	|	(НЕ УчетСебестоимости.СлужебноеВидДвиженияПриход
	|		ИЛИ УчетСебестоимости.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов))
	|	И УчетСебестоимости.Организация В(&ОрганизацииСУчетомПартийНДСВерсии24)
	|	И (УчетСебестоимости.КорРазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|		ИЛИ УчетСебестоимости.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			И УчетСебестоимости.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО)
	|	И УчетСебестоимости.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|	И УчетСебестоимости.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию)
	|	И УчетСебестоимости.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
	|	
	|СГРУППИРОВАТЬ ПО
	|	УчетСебестоимости.Период,
	|	УчетСебестоимости.Регистратор,
	|	УчетСебестоимости.Организация,
	|	УчетСебестоимости.АналитикаУчетаНоменклатуры,
	|	УчетСебестоимости.ВидЗапасов,
	|	УчетСебестоимости.Партия,
	|	УчетСебестоимости.АналитикаУчетаПартий,
	|	УчетСебестоимости.АналитикаФинансовогоУчета,
	|	ВЫБОР КОГДА УчетСебестоимости.СтатьяРасходовСписания = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ УчетСебестоимости.СтатьяРасходовСписания
	|	КОНЕЦ,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовУпр,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовРегл,
	|	ЕСТЬNULL(УчетСебестоимости.СтатьяРасходовСписания.ПринятиеКНалоговомуУчету, ЛОЖЬ),
	|	УчетСебестоимости.АналитикаРасходов,
	|
	|	УчетСебестоимости.РазделУчета,
	|	УчетСебестоимости.АналитикаУчетаПоПартнерам,
	|	УчетСебестоимости.ЗаказКлиента,
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ УчетСебестоимости.ХозяйственнаяОперация КОНЕЦ),
	|	УчетСебестоимости.КорАналитикаУчетаНоменклатуры,
	|	УчетСебестоимости.КорРазделУчета,
	|	УчетСебестоимости.КорВидЗапасов,
	|	УчетСебестоимости.КорОрганизация,
	|	УчетСебестоимости.Подразделение,
	|	УчетСебестоимости.ГруппаПродукции,
	|	ЕСТЬNULL(СпрНазначения.НаправлениеДеятельности,
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
	|	УчетСебестоимости.КорНаправлениеДеятельности,
	|	ВЫБОР КОГДА УчетСебестоимости.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
	|		ТОГДА УчетСебестоимости.Партия
	|		ИНАЧЕ УчетСебестоимости.КорПартия
	|	КОНЕЦ,
	|	ВЫБОР КОГДА УчетСебестоимости.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)
	|		ТОГДА УчетСебестоимости.АналитикаУчетаПартий
	|		ИНАЧЕ УчетСебестоимости.КорАналитикаУчетаПартий
	|	КОНЕЦ,
	|	УчетСебестоимости.КорАналитикаФинансовогоУчета,
	|	УчетСебестоимости.ВидДеятельностиНДС,
	|	УчетСебестоимости.КорВидДеятельностиНДС,
	|	ВЫБОР
	|		КОГДА УчетСебестоимости.КорАналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|		ТОГДА УчетСебестоимости.АналитикаУчетаНоменклатуры
	|		ИНАЧЕ УчетСебестоимости.КорАналитикаУчетаНоменклатуры
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА УчетСебестоимости.КорВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
	|		ТОГДА УчетСебестоимости.ВидЗапасов
	|		ИНАЧЕ УчетСебестоимости.КорВидЗапасов
	|	КОНЕЦ
	|////////////////////////////////////////////////////////////////////////////////
	|
	|;
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	Т.Организация,
	|	Т.Партия,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаУчетаНоменклатурыДляСвязи,
	|	Т.ВидЗапасовДляСвязи,
	|	СУММА(ВЫБОР КОГДА Т.Знаменатель < 0
	|		ТОГДА -Т.Знаменатель
	|		ИНАЧЕ Т.Знаменатель 
	|	КОНЕЦ) КАК Знаменатель
	|ПОМЕСТИТЬ ЗнаменателиСебестоимости
	|ИЗ
	|	ВТСебестоимость КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.Организация,
	|	Т.Партия,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаУчетаНоменклатурыДляСвязи,
	|	Т.ВидЗапасовДляСвязи
	|////////////////////////////////////////////////////////////////////////////////
	|
	|;
	|ВЫБРАТЬ
	|	2 КАК Порядок,
	|	УчетСебестоимости.Период КАК Период,
	|	УчетСебестоимости.Регистратор КАК Регистратор,
	|	УчетСебестоимости.Организация КАК Организация,
	|	УчетСебестоимости.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	УчетСебестоимости.ВидЗапасов КАК ВидЗапасов,
	|	УчетСебестоимости.Партия КАК Партия,
	|	УчетСебестоимости.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	УчетСебестоимости.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	УчетСебестоимости.АналитикаРасходов КАК АналитикаРасходов,
	|
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	УчетСебестоимости.РазделУчета КАК РазделУчета,
	|	УчетСебестоимости.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	УчетСебестоимости.ЗаказКлиента КАК ЗаказКлиента,
	|	УчетСебестоимости.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	УчетСебестоимости.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровОтКлиентаПрошлыхПериодов)
	|			ТОГДА УчетСебестоимости.РазделУчета
	|		ИНАЧЕ УчетСебестоимости.КорРазделУчета КОНЕЦ) КАК КорРазделУчета,
	|	УчетСебестоимости.КорВидЗапасов КАК КорВидЗапасов,
	|	УчетСебестоимости.КорОрганизация КАК КорОрганизация,
	|	УчетСебестоимости.Подразделение КАК Подразделение,
	|	УчетСебестоимости.ВариантРаспределенияРасходовУпр КАК ВариантРаспределенияРасходовУпр,
	|	УчетСебестоимости.ВариантРаспределенияРасходовРегл КАК ВариантРаспределенияРасходовРегл,
	|	УчетСебестоимости.ПринятиеКНалоговомуУчету КАК ПринятиеКНалоговомуУчету,
	|	УчетСебестоимости.ГруппаПродукции КАК ГруппаПродукции,
	|	УчетСебестоимости.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	УчетСебестоимости.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	УчетСебестоимости.КорПартия,
	|	УчетСебестоимости.КорАналитикаУчетаПартий,
	|	УчетСебестоимости.КорАналитикаФинансовогоУчета,
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровОтКлиентаПрошлыхПериодов)
	|			ТОГДА УчетСебестоимости.ВидДеятельностиНДС
	|		ИНАЧЕ УчетСебестоимости.КорВидДеятельностиНДС КОНЕЦ) КАК КорВидДеятельностиНДС,
	|	УчетСебестоимости.ДокументДвижения КАК ДокументДвижения,
	|	ЛОЖЬ КАК ЭтоПередачаМеждуОрганизациями,
	|	УчетСебестоимости.АналитикаУчетаНоменклатурыДляСвязи КАК АналитикаУчетаНоменклатурыДляСвязи,
	|	УчетСебестоимости.ВидЗапасовДляСвязи КАК ВидЗапасовДляСвязи,
	|
	|	СУММА(ВЫБОР КОГДА УчетСебестоимости.Знаменатель < 0
	|		ТОГДА -УчетСебестоимости.Знаменатель
	|		ИНАЧЕ УчетСебестоимости.Знаменатель 
	|	КОНЕЦ) КАК Количество,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК ДопРасходы,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК СтоимостьЗабалансовая,
	|	0 КАК СтоимостьЗабалансоваяРегл,
	|	0 КАК СтоимостьРегл,
	|	0 КАК СтоимостьУпр,
	|	0 КАК ДопРасходыРегл,
	|	0 КАК ДопРасходыУпр,
	|	0 КАК НДСРегл,
	|	0 КАК НДСУпр,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	СУММА(ВЫБОР КОГДА УчетСебестоимости.Знаменатель < 0
	|		ТОГДА -УчетСебестоимости.Знаменатель
	|		ИНАЧЕ УчетСебестоимости.Знаменатель 
	|	КОНЕЦ) КАК ИсходноеКоличество
	|ИЗ
	|	ВТСебестоимость КАК УчетСебестоимости
	|
	|СГРУППИРОВАТЬ ПО
	|	УчетСебестоимости.Период,
	|	УчетСебестоимости.Регистратор,
	|	УчетСебестоимости.Организация,
	|	УчетСебестоимости.АналитикаУчетаНоменклатуры,
	|	УчетСебестоимости.ВидЗапасов,
	|	УчетСебестоимости.Партия,
	|	УчетСебестоимости.АналитикаУчетаПартий,
	|	УчетСебестоимости.КорПартия,
	|	УчетСебестоимости.КорАналитикаУчетаПартий,
	|	УчетСебестоимости.АналитикаФинансовогоУчета,
	|	УчетСебестоимости.СтатьяРасходовСписания,
	|	УчетСебестоимости.АналитикаРасходов,
	|	УчетСебестоимости.РазделУчета,
	|	УчетСебестоимости.АналитикаУчетаПоПартнерам,
	|	УчетСебестоимости.ЗаказКлиента,
	|	УчетСебестоимости.ХозяйственнаяОперация,
	|	УчетСебестоимости.КорАналитикаУчетаНоменклатуры,
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровОтКлиентаПрошлыхПериодов)
	|			ТОГДА УчетСебестоимости.РазделУчета
	|		ИНАЧЕ УчетСебестоимости.КорРазделУчета КОНЕЦ), // КорРазделУчета
	|	УчетСебестоимости.КорВидЗапасов,
	|	УчетСебестоимости.КорОрганизация,
	|	УчетСебестоимости.Подразделение,
	|	УчетСебестоимости.ВариантРаспределенияРасходовУпр,
	|	УчетСебестоимости.ВариантРаспределенияРасходовРегл,
	|	УчетСебестоимости.ПринятиеКНалоговомуУчету,
	|	УчетСебестоимости.ГруппаПродукции,
	|	УчетСебестоимости.НаправлениеДеятельности,
	|	УчетСебестоимости.КорНаправлениеДеятельности,
	|	УчетСебестоимости.КорАналитикаФинансовогоУчета,
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровОтКлиентаПрошлыхПериодов)
	|			ТОГДА УчетСебестоимости.ВидДеятельностиНДС
	|		ИНАЧЕ УчетСебестоимости.КорВидДеятельностиНДС КОНЕЦ), // КорВидДеятельностиНДС
	|	УчетСебестоимости.ДокументДвижения,
	|	УчетСебестоимости.АналитикаУчетаНоменклатурыДляСвязи,
	|	УчетСебестоимости.ВидЗапасовДляСвязи
	|
	|ИМЕЮЩИЕ
	|	СУММА(ВЫБОР КОГДА УчетСебестоимости.Знаменатель < 0
	|		ТОГДА -УчетСебестоимости.Знаменатель
	|		ИНАЧЕ УчетСебестоимости.Знаменатель 
	|	КОНЕЦ) <> 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	1 КАК Порядок,
	|	Партии.Период КАК Период,
	|	Партии.Регистратор КАК Регистратор,
	|	Партии.Организация КАК Организация,
	|	Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов КАК ВидЗапасов,
	|	Партии.Партия КАК Партия,
	|	Партии.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Партии.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	Партии.АналитикаРасходов КАК АналитикаРасходов,
	|
	|	НЕОПРЕДЕЛЕНО КАК ВидДвижения,
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
	|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
	|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
	|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
	|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
	|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
	|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
	|	НЕОПРЕДЕЛЕНО КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовУпр,
	|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовРегл,
	|	НЕОПРЕДЕЛЕНО КАК ПринятиеКНалоговомуУчету,
	|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК КорПартия,
	|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПартий,
	|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
	|	НЕОПРЕДЕЛЕНО КАК КорВидДеятельностиНДС,
	|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
	|	ЛОЖЬ 		 КАК ЭтоПередачаМеждуОрганизациями,
	|	Партии.АналитикаУчетаНоменклатурыДляСвязи КАК АналитикаУчетаНоменклатурыДляСвязи,
	|	Партии.ВидЗапасовДляСвязи КАК ВидЗапасовДляСвязи,
	|	СУММА(ВЫБОР
	|		КОГДА НЕ ЗнаменателиСебестоимости.Знаменатель ЕСТЬ NULL
	|			ТОГДА ЗнаменателиСебестоимости.Знаменатель
	|		КОГДА Партии.Знаменатель < 0 ТОГДА
	|			-Партии.Знаменатель
	|		ИНАЧЕ Партии.Знаменатель
	|	КОНЕЦ) КАК Количество,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК ДопРасходы,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК СтоимостьЗабалансовая,
	|	0 КАК СтоимостьЗабалансоваяРегл,
	|	СУММА(Партии.НДСРегл) КАК СтоимостьРегл,
	|	СУММА(Партии.НДСУпр) КАК СтоимостьУпр,
	|	0 КАК ДопРасходыРегл,
	|	0 КАК ДопРасходыУпр,
	|	0 КАК НДСРегл,
	|	0 КАК НДСУпр,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	0 КАК ИсходноеКоличество
	|ИЗ
	|	ВтПартии КАК Партии
	|	ЛЕВОЕ СОЕДИНЕНИЕ ЗнаменателиСебестоимости КАК ЗнаменателиСебестоимости
	|		ПО ЗнаменателиСебестоимости.Регистратор = Партии.Регистратор
	|		И ЗнаменателиСебестоимости.Организация = Партии.Организация
	|		И ЗнаменателиСебестоимости.Партия = Партии.Партия
	|		И ЗнаменателиСебестоимости.ВидДеятельностиНДС = Партии.ВидДеятельностиНДС
	|		И ЗнаменателиСебестоимости.АналитикаУчетаНоменклатурыДляСвязи = Партии.АналитикаУчетаНоменклатурыДляСвязи
	|		И ЗнаменателиСебестоимости.ВидЗапасовДляСвязи = Партии.ВидЗапасовДляСвязи
	|
	|СГРУППИРОВАТЬ ПО
	|	Партии.Период,
	|	Партии.Регистратор,
	|	Партии.Организация,
	|	Партии.АналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов,
	|	Партии.Партия,
	|	Партии.АналитикаФинансовогоУчета,
	|	Партии.СтатьяРасходовСписания,
	|	Партии.АналитикаРасходов,
	|	Партии.АналитикаУчетаНоменклатурыДляСвязи,
	|	Партии.ВидЗапасовДляСвязи
	|
	|ИМЕЮЩИЕ
	|	СУММА(ВЫБОР
	|		КОГДА НЕ ЗнаменателиСебестоимости.Знаменатель ЕСТЬ NULL
	|			ТОГДА ЗнаменателиСебестоимости.Знаменатель
	|		КОГДА Партии.Знаменатель < 0 ТОГДА
	|			-Партии.Знаменатель
	|		ИНАЧЕ Партии.Знаменатель
	|	КОНЕЦ) <> 0
	|	И (СУММА(Партии.НДСРегл) <> 0 ИЛИ СУММА(Партии.НДСУпр) <> 0)
	|
	|УПОРЯДОЧИТЬ ПО
	|	Регистратор,
	|	Организация,
	|	Партия,
	|	СтатьяРасходовСписания,
	|	АналитикаРасходов,
	|	АналитикаУчетаНоменклатурыДляСвязи,
	|	ВидЗапасовДляСвязи,
	|	АналитикаУчетаНоменклатуры,
	|	ВидЗапасов,
	|	АналитикаФинансовогоУчета,
	|	Порядок
	|";
	
	ЗаписьРаспределения = Новый Структура("
	|Период, АналитикаУчетаНоменклатуры, РазделУчета, ВидЗапасов, Организация, Склад, Партия, АналитикаФинансовогоУчета,
	|АналитикаУчетаНоменклатурыДляСвязи, ВидЗапасовДляСвязи,
	|ХозяйственнаяОперация, ЗаказКлиента, ТипЗапасов, АналитикаУчетаПоПартнерам, ЭтоПередачаМеждуОрганизациями,
	|КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов, КорТипЗапасов, КорОрганизация,
	|АналитикаУчетаНоменклатурыВО, АналитикаФинансовогоУчетаВО, АналитикаАктивовПассивов, КорСклад,
	|СтатьяАктивовПассивов, Подразделение, АналитикаРасходов, СтатьяРасходовСписания, СтатьяДоходов, АналитикаДоходов,
	|ВариантРаспределенияРасходовУпр, ВариантРаспределенияРасходовРегл,
	|ДокументДвижения, ИдентификаторСтроки, ПринятиеКНалоговомуУчету, ГруппаПродукции, СписаниеПриПередачеНУ,
	|ИсточникГФУНоменклатуры, КорИсточникГФУНоменклатуры, НаправлениеДеятельности, КорНаправлениеДеятельности,
	|Стоимость, СтоимостьБезНДС, Количество, КорСтоимость, ПостояннаяРазница, ВременнаяРазница,
	|ДопРасходы, ДопРасходыБезНДС, СтоимостьРегл, НДСРегл,
	|КорПартия, КорАналитикаУчетаПартий, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС,
	|СтатьяКалькуляции, ТипЗаписи, ДокументИсточник,
	|СтоимостьЗабалансовая, Трудозатраты, ПостатейныеПостоянныеСНДС, ПостатейныеПостоянныеБезНДС,
	|СтоимостьЗабалансоваяРегл, ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеПостоянныеРегл,
	|ПостатейныеПеременныеСНДС, ПостатейныеПеременныеБезНДС, ПостатейныеПеременныеРегл,
	|СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр, НДСУпр
	|");
	
	СуммыРаспределения = Новый Структура("
	|Количество, Стоимость, СтоимостьБезНДС, СтоимостьЗабалансовая, СтоимостьРегл, СтоимостьУпр, СтоимостьЗабалансоваяРегл, НДСРегл, НДСУпр,
	|ДопРасходы, ДопРасходыБезНДС, ДопРасходыРегл, ДопРасходыУпр, ПостояннаяРазница, ВременнаяРазница
	|");
	
	СтрокаОстатка = Новый Структура("
	|Регистратор, Организация, АналитикаУчетаНоменклатуры, ВидЗапасов, Партия, АналитикаФинансовогоУчета, СтатьяРасходовСписания, АналитикаРасходов,
	|АналитикаУчетаНоменклатурыДляСвязи, ВидЗапасовДляСвязи,
	|Количество, Стоимость, СтоимостьБезНДС, СтоимостьЗабалансовая, СтоимостьРегл, СтоимостьУпр, СтоимостьЗабалансоваяРегл, НДСРегл, НДСУпр,
	|ДопРасходы, ДопРасходыБезНДС, ДопРасходыРегл, ДопРасходыУпр, ПостояннаяРазница, ВременнаяРазница
	|");
	
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина,,,
		Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя);
	
	// Формируются движения по регистрам:
	// - СебестоимостьТоваров
	// - ПрочиеРасходы
	Пока Выборка.Следующий() Цикл
		
		Если Выборка.Порядок = 1 Тогда
			
			ЗаполнитьЗначенияСвойств(СтрокаОстатка, Выборка);
			
		ИначеЕсли СтрокаОстатка.Регистратор = Выборка.Регистратор
			И СтрокаОстатка.Организация = Выборка.Организация
			И СтрокаОстатка.Партия = Выборка.Партия
			И СтрокаОстатка.СтатьяРасходовСписания = Выборка.СтатьяРасходовСписания
			И СтрокаОстатка.АналитикаРасходов = Выборка.АналитикаРасходов
			И СтрокаОстатка.АналитикаУчетаНоменклатурыДляСвязи = Выборка.АналитикаУчетаНоменклатурыДляСвязи
			И СтрокаОстатка.ВидЗапасовДляСвязи = Выборка.ВидЗапасовДляСвязи Тогда
			
			ЗаполнитьЗначенияСвойств(ЗаписьРаспределения, Выборка);
			
			РасчетСебестоимостиКорректировкаСтоимости.РаспределитьСтоимость(СуммыРаспределения, СтрокаОстатка, Выборка, Выборка.Количество);
			РасчетСебестоимостиКорректировкаСтоимости.ДополнитьСуммыРаспределения(ЗаписьРаспределения, СуммыРаспределения);
			
			Если ЗаписьРаспределения.СтоимостьРегл <> 0 ИЛИ ЗаписьРаспределения.СтоимостьУпр <> 0 Тогда
					
				// Если есть кор. раздел - необходимо скорректировать стоимость в кор. части.
				Если ЗначениеЗаполнено(ЗаписьРаспределения.КорРазделУчета) Тогда
					
					РасчетСебестоимостиКорректировкаСтоимости.СформироватьКорДвиженияСебестоимостьТоваров(ПараметрыРасчета, ЗаписьРаспределения, ПараметрыРасчета.ПредварительныйРасчет);
							
				КонецЕсли;
				
				Если ПараметрыРасчета.ПредварительныйРасчет Тогда
					Продолжить;
				КонецЕсли;
				
				// Корректировка списания товаров на затраты в регистре учет прочих расходов.
				Если Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СписаниеТоваров
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СписаниеТоваровПоТребованию
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СторноСписанияНаРасходы
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПересортицаТоваровСПереоценкой
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПорчаТоваровСПереоценкой
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратТоваровПоставщику
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаНаПрочиеЦели
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаВЭксплуатацию
				 Или Выборка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ОтчетКомиссионераОСписании Тогда
				 	
				 	СуммовыеПоказатели = Новый Структура;
					СуммовыеПоказатели.Вставить("СуммаСНДС", 0);
					СуммовыеПоказатели.Вставить("СуммаБезНДС", 0);
					СуммовыеПоказатели.Вставить("СуммаРегл", ЗаписьРаспределения.СтоимостьРегл);
					СуммовыеПоказатели.Вставить("СуммаУпр", ЗаписьРаспределения.СтоимостьУпр);
					СуммовыеПоказатели.Вставить("ПостояннаяРазница", 0);
					СуммовыеПоказатели.Вставить("ВременнаяРазница", 0);
				 
				 	РасчетСебестоимостиКорректировкаСтоимости.СформироватьДвиженияПрочиеРасходы(
				 		ПараметрыРасчета,
						ЗаписьРаспределения,
						СуммовыеПоказатели);
					
				КонецЕсли;

			КонецЕсли;
			
		КонецЕсли;

	КонецЦикла;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"ВтПартии, ВтРегистраторы, ВТСебестоимость, ЗнаменателиСебестоимости"
		+ ?(НЕ ВыполненРасчетПартийНДС, ", ЗнаменателиРасходов", ""));
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвижения(ПараметрыРасчета);
	
КонецПроцедуры

// Этап 3.18
Процедура ВключитьИсключитьНДСВСтоимостьПродаж(ПараметрыРасчета) Экспорт

	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "ВключитьИсключитьНДСВСтоимостьПродаж");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиКорректировкаСтоимости.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Продажи.Период,
	|	Продажи.Регистратор,
	|	АналитикаПартнеров.Организация,
	|	Продажи.АналитикаУчетаНоменклатуры,
	|	Продажи.Партия,
	|	Продажи.АналитикаФинансовогоУчета,
	|	Продажи.ВидДеятельностиНДС
	|ПОМЕСТИТЬ ДвиженияПродаж
	|ИЗ
	|	ВТКэшРасчетныеОборотыВыручкаИСебестоимостьПродаж КАК Продажи
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборАналитикаПоПартнерам КАК АналитикаПартнеров
	|		ПО Продажи.АналитикаУчетаПоПартнерам = АналитикаПартнеров.КлючАналитики
	|ГДЕ
	|	&ПартионныйУчетВерсии22
	|	И АналитикаПартнеров.Организация В(&ОрганизацииСУчетомПартийНДСВерсии22)
	|	И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Период,
	|	Регистратор,
	|	Организация,
	|	АналитикаУчетаНоменклатуры,
	|	Партия,
	|	АналитикаФинансовогоУчета,
	|	ВидДеятельностиНДС
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Партии.Период КАК Период,
	|	Партии.Регистратор КАК Регистратор,
	|	Партии.Организация КАК Организация,
	|	Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов КАК ВидЗапасов,
	|	Партии.СтатьяСписанияНДС,
	|	Партии.АналитикаСписанияНДС,
	|	Партии.РазделУчета,
	|	Партии.Партия,
	|	Партии.АналитикаУчетаПартий,
	|	Партии.АналитикаФинансовогоУчета,
	|	Партии.ВидДеятельностиНДС,
	|	Партии.РаспределениеПоВыбывшимТоварам,
	|	СУММА(Партии.Количество) КАК Количество,
	|	СУММА(ВЫБОР
	|		КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА 0
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		ТОГДА
	|			Партии.НДСРегл
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) < &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			Партии.НДСРегл
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		ТОГДА
	|			-Партии.НДСРегл
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) >= &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			-Партии.НДСРегл
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ
	|	) КАК НДСРегл,
	|	СУММА(
	|		ВЫБОР КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА 0
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		ТОГДА
	|			Партии.НДСУпр
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) < &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			Партии.НДСУпр
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		ТОГДА
	|			-Партии.НДСУпр
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) >= &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			-Партии.НДСУпр
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ
	|	) КАК НДСУпр,
	|	СУММА(
	|		ВЫБОР КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА Партии.НДСРегл
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ
	|	) КАК СписаниеНДС,
	|	СУММА(
	|		ВЫБОР КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА Партии.НДСУпр
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ
	|	) КАК СписаниеНДСУпр
	|ПОМЕСТИТЬ ВтПартии
	|ИЗ (
	|	ВЫБРАТЬ
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Партии.ВидЗапасов КАК ВидЗапасов,
	|		Партии.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
	|		Партии.НалогообложениеНДС,
	|		Партии.ДокументПоступления,
	|		Партии.Количество КАК Количество,
	|		Партии.НДСРегл КАК НДСРегл,
	|		0 КАК НДСУпр,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС,
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|		НЕОПРЕДЕЛЕНО КАК Партия,
	|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК ВидДеятельностиНДС,
	|		ЛОЖЬ КАК РаспределениеПоВыбывшимТоварам
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровОрганизаций КАК Партии
	|	ГДЕ
	|		НЕ &ПартионныйУчетВерсии22
	|		И Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Партии.Активность
	|		И Партии.Организация В(&МассивОрганизаций)
	|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Партии.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.АналитикаУчетаПродукции КАК АналитикаУчетаНоменклатуры,
	|		ВЫБОР КОГДА Партии.КорВидЗапасов <> ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
	|			ТОГДА Партии.КорВидЗапасов
	|			ИНАЧЕ Партии.ВидЗапасов
	|		КОНЕЦ КАК ВидЗапасов,
	|		Партии.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
	|		Партии.НалогообложениеНДС,
	|		Партии.ДокументПоступления,
	|		0 КАК Количество,
	|		Партии.НДСРегл КАК НДСРегл,
	|		0 КАК НДСУпр,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС,
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|		НЕОПРЕДЕЛЕНО КАК Партия,
	|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК ВидДеятельностиНДС,
	|		ЛОЖЬ КАК РаспределениеПоВыбывшимТоварам
	|	ИЗ
	|		РегистрНакопления.ПартииЗатратНаВыпуск КАК Партии
	|	ГДЕ
	|		НЕ &ПартионныйУчетВерсии22
	|		И Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Партии.Активность
	|		И Партии.Организация В(&МассивОрганизаций)
	|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Партии.НДСРегл <> 0
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Партии.ВидЗапасов КАК ВидЗапасов,
	|		Партии.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
	|		Партии.НалогообложениеНДС,
	|		Партии.ДокументПоступления,
	|		0 КАК Количество,
	|		Партии.НДСРегл КАК НДСРегл,
	|		0 КАК НДСУпр,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС,
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|		НЕОПРЕДЕЛЕНО КАК Партия,
	|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК ВидДеятельностиНДС,
	|		ЛОЖЬ КАК РаспределениеПоВыбывшимТоварам
	|	ИЗ
	|		РегистрНакопления.ПартииРасходовНаСебестоимостьТоваров КАК Партии
	|	ГДЕ
	|		НЕ &ПартионныйУчетВерсии22
	|		И Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Партии.Активность
	|		И Партии.Организация В(&МассивОрганизаций)
	|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Партии.НДСРегл <> 0
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Партии.ВидЗапасов КАК ВидЗапасов,
	|		Партии.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
	|		Партии.НалогообложениеНДС,
	|		Партии.ДокументПоступления,
	|		Партии.Количество КАК Количество,
	|		Партии.НДСРегл КАК НДСРегл,
	|		0 КАК НДСУпр,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС,
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|		НЕОПРЕДЕЛЕНО КАК Партия,
	|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК ВидДеятельностиНДС,
	|		ЛОЖЬ КАК РаспределениеПоВыбывшимТоварам
	|	ИЗ
	|		РегистрНакопления.ПартииПроизводственныхЗатрат КАК Партии
	|	ГДЕ
	|		НЕ &ПартионныйУчетВерсии22
	|		И Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Партии.Активность
	|		И Партии.Организация В(&МассивОрганизаций)
	|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Партии.НДСРегл <> 0
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Партии.ВидЗапасов КАК ВидЗапасов,
	|		Партии.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
	|		Партии.НалогообложениеНДС,
	|		Партии.ДокументПоступления,
	|		Партии.Количество КАК Количество,
	|		Партии.НДСРегл КАК НДСРегл,
	|		0 КАК НДСУпр,
	|		ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяСписанияНДС,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|		НЕОПРЕДЕЛЕНО КАК Партия,
	|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК ВидДеятельностиНДС,
	|		ЛОЖЬ КАК РаспределениеПоВыбывшимТоварам
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровПереданныеНаКомиссию КАК Партии
	|	ГДЕ
	|		НЕ &ПартионныйУчетВерсии22
	|		И Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Партии.Активность
	|		И Партии.Организация В(&МассивОрганизаций)
	|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Партии.ВидЗапасов КАК ВидЗапасов,
	|		Партии.ВидДеятельностиНДС КАК НалогообложениеПартии,
	|		Партии.КорВидДеятельностиНДС КАК НалогообложениеНДС,
	|		Партии.ДокументПоступления,
	|		(ВЫБОР
	|			КОГДА Партии.ТипЗаписи В (
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
	|				ТОГДА (ВЫБОР
	|					КОГДА Партии.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|						ТОГДА Партии.СтоимостьБезНДС + Партии.НДС
	|					КОГДА Партии.СтоимостьБезНДС = 0 ТОГДА Партии.НДС
	|					ИНАЧЕ Партии.СтоимостьБезНДС КОНЕЦ)
	|			ИНАЧЕ Партии.Количество КОНЕЦ) КАК Количество,
	|		Партии.НДС КАК НДСРегл,
	|		Партии.НДСУпр КАК НДСУпр,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС,
	|		Партии.РазделУчета,
	|		(ВЫБОР
	|			КОГДА ДвиженияПродаж.Регистратор ЕСТЬ NULL ТОГДА НЕОПРЕДЕЛЕНО
	|			ИНАЧЕ Партии.Партия КОНЕЦ) КАК Партия,
	|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
	|		Партии.АналитикаФинансовогоУчета,
	|		Партии.ВидДеятельностиНДС,
	|		(ВЫБОР
	|			КОГДА Партии.ТипЗаписи В (
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК РаспределениеПоВыбывшимТоварам
	|	ИЗ
	|		ВТКэшРасчетныеОборотыДетализацияПартийТоваровДляНДСиУСН КАК Партии
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДвиженияПродаж КАК ДвиженияПродаж
	|		 ПО ДвиженияПродаж.Период = Партии.Период
	|		 И ДвиженияПродаж.Регистратор = Партии.Регистратор
	|		 И ДвиженияПродаж.Организация = Партии.Организация
	|		 И ДвиженияПродаж.АналитикаУчетаНоменклатуры = Партии.АналитикаУчетаНоменклатуры
	|		 И ДвиженияПродаж.Партия = Партии.Партия
	|		 И ДвиженияПродаж.АналитикаФинансовогоУчета = Партии.АналитикаФинансовогоУчета
	|		 И ДвиженияПродаж.ВидДеятельностиНДС = Партии.ВидДеятельностиНДС
	|	ГДЕ
	|		&ПартионныйУчетВерсии22
	|		И Партии.Организация В(&ОрганизацииСУчетомПартийНДСВерсии22)
	|		И НЕ Партии.СлужебноеВидДвиженияПриход
	|	
	|	) КАК Партии
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|	ПО
	|		ДанныеПервичныхДокументов.Организация = Партии.Организация
	|		И ДанныеПервичныхДокументов.Документ = Партии.ДокументПоступления
	|ГДЕ
	|	Партии.НалогообложениеНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|
	|СГРУППИРОВАТЬ ПО
	|	Партии.Период,
	|	Партии.Регистратор,
	|	Партии.Организация,
	|	Партии.АналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов,
	|	Партии.СтатьяСписанияНДС,
	|	Партии.АналитикаСписанияНДС,
	|	Партии.РазделУчета,
	|	Партии.Партия,
	|	Партии.АналитикаУчетаПартий,
	|	Партии.АналитикаФинансовогоУчета,
	|	Партии.ВидДеятельностиНДС,
	|	Партии.РаспределениеПоВыбывшимТоварам
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Партии.Регистратор КАК Регистратор
	|ПОМЕСТИТЬ ВтРегистраторы
	|ИЗ
	|	ВтПартии КАК Партии
	|ГДЕ
	|	Партии.НДСРегл <> 0
	|	ИЛИ Партии.НДСУпр <> 0
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	2 КАК Порядок,
	|	Продажи.Период                     КАК Период,
	|	Продажи.Регистратор                КАК Регистратор,
	|	Продажи.Регистратор                КАК ДокументДвижения,
	|	АналитикаПартнеров.Организация     КАК Организация,
	|	Продажи.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Продажи.ВидЗапасов                 КАК ВидЗапасов,
	|	Продажи.РазделУчета				   КАК РазделУчета,
	|	Продажи.Партия				   	   КАК Партия,
	|	Продажи.АналитикаУчетаПартий	   КАК АналитикаУчетаПартий,
	|	Продажи.АналитикаФинансовогоУчета  КАК АналитикаФинансовогоУчета,
	|	Продажи.ВидДеятельностиНДС		   КАК ВидДеятельностиНДС,
	|
	|	Продажи.ЗаказКлиента               КАК ЗаказКлиента,
	|	Продажи.АналитикаУчетаПоПартнерам  КАК АналитикаУчетаПоПартнерам,
	|	Продажи.Подразделение              КАК Подразделение,
	|	Продажи.ТипЗапасов                 КАК ТипЗапасов,
	|	Продажи.Менеджер                   КАК Менеджер,
	|	Продажи.Склад                      КАК Склад,
	|	Продажи.Соглашение                 КАК Соглашение,
	|	Продажи.Договор                    КАК Договор,
	|	Продажи.ХозяйственнаяОперация      КАК ХозяйственнаяОперация,
	|	Продажи.НалогообложениеНДС         КАК НалогообложениеНДС,
	|	Продажи.ВалютаВзаиморасчетов       КАК ВалютаВзаиморасчетов,
	|	Продажи.ВалютаДокумента            КАК ВалютаДокумента,
	|	Продажи.ИсточникГФУНоменклатуры    КАК ИсточникГФУНоменклатуры,
	|	Продажи.ИсточникГФУРасчетов        КАК ИсточникГФУРасчетов,
	|	Продажи.НаправлениеДеятельностиКонтрагента КАК НаправлениеДеятельностиКонтрагента,
	|	Продажи.НаправлениеДеятельностиНоменклатуры КАК НаправлениеДеятельностиНоменклатуры,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетПартий И Продажи.Количество = 0
	|			ТОГДА (ВЫБОР
	|				КОГДА Продажи.ДопРасходыРегл = 0 ТОГДА Продажи.НДСРегл
	|				ИНАЧЕ Продажи.ДопРасходыРегл КОНЕЦ)
	|		КОГДА Продажи.Количество < 0 ТОГДА
	|			0 - Продажи.Количество
	|		ИНАЧЕ
	|			Продажи.Количество
	|		КОНЕЦ
	|	) КАК Количество,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК ДопРасходы,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК СтоимостьЗабалансовая,
	|	0 КАК СтоимостьЗабалансоваяРегл,
	|	0 КАК СтоимостьРегл,
	|	0 КАК НДСРегл,
	|	0 КАК НДСУпр,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	0 КАК Трудозатраты,
	|	0 КАК ПостатейныеПостоянныеСНДС,
	|	0 КАК ПостатейныеПеременныеСНДС,
	|	0 КАК ПостатейныеПостоянныеБезНДС,
	|	0 КАК ПостатейныеПеременныеБезНДС,
	|	0 КАК ДопРасходыРегл,
	|	0 КАК ТрудозатратыРегл,
	|	0 КАК ПостатейныеПостоянныеРегл,
	|	0 КАК ПостатейныеПеременныеРегл,
	|	0 КАК СтоимостьУпр,
	|	0 КАК ДопРасходыУпр,
	|	0 КАК ТрудозатратыУпр,
	|	0 КАК ПостатейныеПостоянныеУпр,
	|	0 КАК ПостатейныеПеременныеУпр,
	|
	|	СУММА(Продажи.Количество)          КАК ИсходноеКоличество,
	|	0                                  КАК КорСтоимость
	|ИЗ
	|	ВТКэшРасчетныеОборотыВыручкаИСебестоимостьПродаж КАК Продажи
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтРегистраторы КАК Регистраторы
	|			ПО Регистраторы.Регистратор = Продажи.Регистратор
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборАналитикаПоПартнерам КАК АналитикаПартнеров
	|			ПО Продажи.АналитикаУчетаПоПартнерам = АналитикаПартнеров.КлючАналитики
	|
	|ГДЕ
	|	Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|	
	|СГРУППИРОВАТЬ ПО
	|	Продажи.Период,
	|	Продажи.Регистратор,
	|	Продажи.АналитикаУчетаНоменклатуры,
	|	Продажи.ЗаказКлиента,
	|	Продажи.АналитикаУчетаПоПартнерам,
	|	Продажи.Подразделение,
	|	Продажи.ТипЗапасов,
	|	Продажи.ВидЗапасов,
	|	Продажи.Менеджер,
	|	Продажи.Склад,
	|	Продажи.Соглашение,
	|	Продажи.Договор,
	|	Продажи.ХозяйственнаяОперация,
	|	Продажи.НалогообложениеНДС,
	|	Продажи.ВалютаВзаиморасчетов,
	|	Продажи.ВалютаДокумента,
	|	Продажи.ИсточникГФУНоменклатуры,
	|	Продажи.ИсточникГФУРасчетов,
	|	Продажи.НаправлениеДеятельностиКонтрагента,
	|	Продажи.НаправлениеДеятельностиНоменклатуры,
	|	АналитикаПартнеров.Организация,
	|	Продажи.РазделУчета,
	|	Продажи.Партия,
	|	Продажи.АналитикаУчетаПартий,
	|	Продажи.АналитикаФинансовогоУчета,
	|	Продажи.ВидДеятельностиНДС
	|
	|ИМЕЮЩИЕ
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетПартий И Продажи.Количество = 0
	|			ТОГДА (ВЫБОР
	|				КОГДА Продажи.ДопРасходыРегл = 0 ТОГДА Продажи.НДСРегл
	|				ИНАЧЕ Продажи.ДопРасходыРегл КОНЕЦ)
	|		КОГДА Продажи.Количество < 0 ТОГДА
	|			0 - Продажи.Количество
	|		ИНАЧЕ
	|			Продажи.Количество
	|		КОНЕЦ
	|	) <> 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	1 								   КАК Порядок,
	|	Партии.Период 					   КАК Период,
	|	Партии.Регистратор 				   КАК Регистратор,
	|	Партии.Регистратор 				   КАК ДокументДвижения,
	|	Партии.Организация 				   КАК Организация,
	|	Партии.АналитикаУчетаНоменклатуры  КАК АналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов 				   КАК ВидЗапасов,
	|	Партии.РазделУчета				   КАК РазделУчета,
	|	Партии.Партия				   	   КАК Партия,
	|	Партии.АналитикаУчетаПартий	       КАК АналитикаУчетаПартий,
	|	Партии.АналитикаФинансовогоУчета   КАК АналитикаФинансовогоУчета,
	|	Партии.ВидДеятельностиНДС		   КАК ВидДеятельностиНДС,
	|
	|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
	|	НЕОПРЕДЕЛЕНО КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО КАК ТипЗапасов,
	|	НЕОПРЕДЕЛЕНО КАК Менеджер,
	|	НЕОПРЕДЕЛЕНО КАК Склад,
	|	НЕОПРЕДЕЛЕНО КАК Соглашение,
	|	НЕОПРЕДЕЛЕНО КАК Договор,
	|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
	|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
	|	НЕОПРЕДЕЛЕНО КАК ВалютаВзаиморасчетов,
	|	НЕОПРЕДЕЛЕНО КАК ВалютаДокумента,
	|	НЕОПРЕДЕЛЕНО КАК ИсточникГФУНоменклатуры,
	|	НЕОПРЕДЕЛЕНО КАК ИсточникГФУРасчетов,
	|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельностиКонтрагента,
	|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельностиНоменклатуры,
	|
	|	СУММА(Партии.Количество) КАК Количество,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК ДопРасходы,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК СтоимостьЗабалансовая,
	|	0 КАК СтоимостьЗабалансоваяРегл,
	|	СУММА(ВЫБОР
	|		КОГДА Партии.РаспределениеПоВыбывшимТоварам ТОГДА 0
	|		ИНАЧЕ Партии.НДСРегл КОНЕЦ) КАК СтоимостьРегл,
	|	0 КАК НДСРегл,
	|	0 КАК НДСУпр,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	0 КАК Трудозатраты,
	|	0 КАК ПостатейныеПостоянныеСНДС,
	|	0 КАК ПостатейныеПеременныеСНДС,
	|	0 КАК ПостатейныеПостоянныеБезНДС,
	|	0 КАК ПостатейныеПеременныеБезНДС,
	|	СУММА(ВЫБОР
	|		КОГДА Партии.РаспределениеПоВыбывшимТоварам ТОГДА Партии.НДСРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыРегл,
	|	0 КАК ТрудозатратыРегл,
	|	0 КАК ПостатейныеПостоянныеРегл,
	|	0 КАК ПостатейныеПеременныеРегл,
	|	СУММА(ВЫБОР
	|		КОГДА Партии.РаспределениеПоВыбывшимТоварам ТОГДА 0
	|		ИНАЧЕ Партии.НДСРегл КОНЕЦ) КАК СтоимостьУпр,
	|	СУММА(ВЫБОР
	|		КОГДА Партии.РаспределениеПоВыбывшимТоварам ТОГДА Партии.НДСУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыУпр,
	|	0 КАК ТрудозатратыУпр,
	|	0 КАК ПостатейныеПостоянныеУпр,
	|	0 КАК ПостатейныеПеременныеУпр,
	|
	|	0 КАК ИсходноеКоличество,
	|	0 КАК КорСтоимость
	|ИЗ
	|	ВтПартии КАК Партии
	|ГДЕ
	|	Партии.Количество > 0
	|
	|СГРУППИРОВАТЬ ПО
	|	Партии.Период,
	|	Партии.Регистратор,
	|	Партии.Организация,
	|	Партии.АналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов,
	|	Партии.РазделУчета,
	|	Партии.Партия,
	|	Партии.АналитикаУчетаПартий,
	|	Партии.АналитикаФинансовогоУчета,
	|	Партии.ВидДеятельностиНДС
	|
	|ИМЕЮЩИЕ
	|	СУММА(Партии.НДСРегл) <> 0
	|	ИЛИ СУММА(Партии.НДСУпр) <> 0
	|
	|УПОРЯДОЧИТЬ ПО
	|	Регистратор,
	|	Организация,
	|	АналитикаУчетаНоменклатуры,
	|	ВидЗапасов,
	|	РазделУчета,
	|	Партия,
	|	АналитикаФинансовогоУчета,
	|	ВидДеятельностиНДС,
	|	Порядок
	|";
	
	ЗаписьРаспределения = Новый Структура("
	|Период, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, Менеджер,
	|ХозяйственнаяОперация, ЗаказКлиента, ТипЗапасов,
	|Подразделение, АналитикаУчетаПоПартнерам,
	|Склад, Соглашение, Договор, ВалютаВзаиморасчетов, ВалютаДокумента,
	|ИсточникГФУНоменклатуры, ИсточникГФУРасчетов,
	|НаправлениеДеятельностиКонтрагента, НаправлениеДеятельностиНоменклатуры,
	|НалогообложениеНДС, ДокументДвижения,
	|РазделУчета, Партия, АналитикаУчетаПартий, АналитикаФинансовогоУчета, ВидДеятельностиНДС,
	|Стоимость, СтоимостьБезНДС, Количество,
	|ДопРасходы, ДопРасходыБезНДС,
	|СтоимостьРегл, НДСРегл, НДСУпр, ПостояннаяРазница, ВременнаяРазница,
	|СтоимостьЗабалансовая, Трудозатраты, ПостатейныеПостоянныеСНДС, ПостатейныеПеременныеСНДС,
	|ПостатейныеПостоянныеБезНДС, ПостатейныеПеременныеБезНДС,
	|СтоимостьЗабалансоваяРегл, ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеПостоянныеРегл, ПостатейныеПеременныеРегл,
	|СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр");
	
	СтрокаОстатка = Новый Структура("
	|Регистратор, Организация, АналитикаУчетаНоменклатуры, ВидЗапасов,
	|РазделУчета, Партия, АналитикаУчетаПартий, АналитикаФинансовогоУчета, ВидДеятельностиНДС,
	|Количество, Стоимость, СтоимостьБезНДС, СтоимостьРегл, НДСРегл, НДСУпр,
	|ДопРасходы, ДопРасходыБезНДС, ПостояннаяРазница, ВременнаяРазница,
	|СтоимостьЗабалансовая, Трудозатраты, ПостатейныеПостоянныеСНДС, ПостатейныеПеременныеСНДС,
	|ПостатейныеПостоянныеБезНДС, ПостатейныеПеременныеБезНДС,
	|СтоимостьЗабалансоваяРегл, ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеПостоянныеРегл, ПостатейныеПеременныеРегл,
	|СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр");
	
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина,,,
		Метаданные.РегистрыНакопления.ВыручкаИСебестоимостьПродаж.Имя);
	
	// Формируются движения по регистрам:
	// - ВыручкаИСебестоимостьПродаж
	Пока Выборка.Следующий() Цикл
		
		Если Выборка.Порядок = 1 Тогда
			
			ЗаполнитьЗначенияСвойств(СтрокаОстатка, Выборка);
			
		ИначеЕсли СтрокаОстатка.Регистратор = Выборка.Регистратор
		 И СтрокаОстатка.Организация = Выборка.Организация
		 И СтрокаОстатка.АналитикаУчетаНоменклатуры = Выборка.АналитикаУчетаНоменклатуры
		 И СтрокаОстатка.ВидЗапасов = Выборка.ВидЗапасов
		 И СтрокаОстатка.РазделУчета = Выборка.РазделУчета
		 И СтрокаОстатка.Партия = Выборка.Партия
		 И СтрокаОстатка.АналитикаФинансовогоУчета = Выборка.АналитикаФинансовогоУчета
		 И СтрокаОстатка.ВидДеятельностиНДС = Выборка.ВидДеятельностиНДС
		 И СтрокаОстатка.Количество > 0 Тогда
		
			ЗаполнитьЗначенияСвойств(ЗаписьРаспределения, Выборка);
			
			РасчетСебестоимостиКорректировкаСтоимости.РаспределитьСтоимость(ЗаписьРаспределения, СтрокаОстатка, Выборка, Выборка.Количество);
			
			РасчетСебестоимостиКорректировкаСтоимости.СформироватьДвиженияВыручкаИСебестоимостьПродаж(ПараметрыРасчета, ЗаписьРаспределения);

		КонецЕсли;
		
	КонецЦикла;
	
 	// Формируются движения по регистрам:
	// - ПрочиеРасходы
	РасчетСебестоимостиКорректировкаСтоимости.СформироватьДвиженияПрочиеРасходыСписаниеНДС(ПараметрыРасчета);
	
	// Формируются движения по регистрам:
	// - ДвиженияНоменклатураДоходыРасходы
	РасчетСебестоимостиКорректировкаСтоимости.СформироватьДвиженияНоменклатураДоходыРасходыСписаниеНДС(ПараметрыРасчета);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, "ВтПартии, ДвиженияПродаж, ВтРегистраторы");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвижения(ПараметрыРасчета);
	
КонецПроцедуры

// Этап 3.18.2
Процедура ВключитьИсключитьНДСВСтоимостьПродаж24(ПараметрыРасчета) Экспорт

	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "ВключитьИсключитьНДСВСтоимостьПродаж24");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиКорректировкаСтоимости.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Продажи.Период,
	|	Продажи.Регистратор,
	|	АналитикаПартнеров.Организация,
	|	Продажи.Партия,
	|	Продажи.ВидДеятельностиНДС,
	|	Продажи.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатурыДляСвязи,
	|	Продажи.ВидЗапасов КАК ВидЗапасовДляСвязи
	|ПОМЕСТИТЬ ДвиженияПродаж
	|ИЗ
	|	ВТКэшРасчетныеОборотыВыручкаИСебестоимостьПродаж КАК Продажи
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборАналитикаПоПартнерам КАК АналитикаПартнеров
	|		ПО Продажи.АналитикаУчетаПоПартнерам = АналитикаПартнеров.КлючАналитики
	|ГДЕ
	|	&ПартионныйУчетВерсии22
	|	И АналитикаПартнеров.Организация В(&ОрганизацииСУчетомПартийНДСВерсии24)
	|	И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|ИНДЕКСИРОВАТЬ ПО
	|	Период,
	|	Регистратор,
	|	Организация,
	|	Партия,
	|	ВидДеятельностиНДС,
	|	АналитикаУчетаНоменклатурыДляСвязи,
	|	ВидЗапасовДляСвязи
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Партии.Период КАК Период,
	|	Партии.Регистратор КАК Регистратор,
	|	Партии.Организация КАК Организация,
	|	Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов,
	|	Партии.СтатьяСписанияНДС,
	|	Партии.АналитикаСписанияНДС,
	|	Партии.РазделУчета,
	|	Партии.Партия,
	|	Партии.АналитикаФинансовогоУчета,
	|	Партии.ВидДеятельностиНДС,
	|	Партии.АналитикаУчетаНоменклатурыДляСвязи,
	|	Партии.ВидЗапасовДляСвязи,
	|	Партии.РаспределениеПоВыбывшимТоварам,
	|
	|	СУММА(Партии.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	СУММА(Партии.СтоимостьБезНДСУпр) КАК СтоимостьБезНДСУпр,
	|	СУММА(
	|		ВЫБОР КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА 0
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		ТОГДА
	|			Партии.НДСРегл
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) < &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			Партии.НДСРегл
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		ТОГДА
	|			-Партии.НДСРегл
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) >= &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			-Партии.НДСРегл
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ
	|	) КАК НДСРегл,
	|	СУММА(
	|		ВЫБОР КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА 0
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		ТОГДА
	|			Партии.НДСУпр
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) < &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			Партии.НДСУпр
	|
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		ТОГДА
	|			-Партии.НДСУпр
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|		 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) >= &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА
	|			-Партии.НДСУпр
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ
	|	) КАК НДСУпр,
	|	СУММА(
	|		ВЫБОР КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА Партии.НДСРегл
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ
	|	) КАК СписаниеНДС,
	|	СУММА(
	|		ВЫБОР КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА Партии.НДСУпр
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ
	|	) КАК СписаниеНДСУпр,
	|	СУММА(ВЫБОР
	|		КОГДА Партии.НалогообложениеПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|			ТОГДА Партии.СтоимостьБезНДС + Партии.НДСРегл
	|		КОГДА Партии.СтоимостьБезНДС = 0
	|			ТОГДА Партии.НДСРегл
	|		ИНАЧЕ Партии.СтоимостьБезНДС КОНЕЦ) КАК Стоимость
	|ПОМЕСТИТЬ ВтПартии
	|ИЗ (
	|	ВЫБРАТЬ
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|		ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
	|		Партии.ВидДеятельностиНДС КАК НалогообложениеПартии,
	|		Партии.КорВидДеятельностиНДС КАК НалогообложениеНДС,
	|		Партии.ДокументПоступления КАК ДокументПоступления,
	|		Партии.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|		Партии.СтоимостьБезНДСУпр КАК СтоимостьБезНДСУпр,
	|		Партии.НДС КАК НДСРегл,
	|		Партии.НДСУпр КАК НДСУпр,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС,
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|		(ВЫБОР
	|			КОГДА ДвиженияПродаж.Регистратор ЕСТЬ NULL ТОГДА НЕОПРЕДЕЛЕНО
	|			ИНАЧЕ Партии.Партия КОНЕЦ) КАК Партия,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
	|		Партии.ВидДеятельностиНДС,
	|		Партии.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатурыДляСвязи,
	|		Партии.КорВидЗапасов КАК ВидЗапасовДляСвязи,
	|		(ВЫБОР
	|			КОГДА Партии.ТипЗаписи В (
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК РаспределениеПоВыбывшимТоварам
	|	ИЗ
	|		ВТКэшРасчетныеОборотыДетализацияПартийТоваровДляНДСиУСН2_4 КАК Партии
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДвиженияПродаж КАК ДвиженияПродаж
	|		 ПО ДвиженияПродаж.Период = Партии.Период
	|		 И ДвиженияПродаж.Регистратор = Партии.Регистратор
	|		 И ДвиженияПродаж.Организация = Партии.Организация
	|		 И ДвиженияПродаж.Партия = Партии.Партия
	|		 И ДвиженияПродаж.ВидДеятельностиНДС = Партии.ВидДеятельностиНДС
	|		 И ДвиженияПродаж.АналитикаУчетаНоменклатурыДляСвязи = Партии.КорАналитикаУчетаНоменклатуры
	|		 И ДвиженияПродаж.ВидЗапасовДляСвязи = Партии.КорВидЗапасов
	|	ГДЕ
	|		&ПартионныйУчетВерсии22
	|		И Партии.Организация В(&ОрганизацииСУчетомПартийНДСВерсии24)
	|		И НЕ Партии.СлужебноеВидДвиженияПриход
	|	
	|	) КАК Партии
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|	ПО
	|		ДанныеПервичныхДокументов.Организация = Партии.Организация
	|		И ДанныеПервичныхДокументов.Документ = Партии.ДокументПоступления
	|ГДЕ
	|	Партии.НалогообложениеНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|
	|СГРУППИРОВАТЬ ПО
	|	Партии.Период,
	|	Партии.Регистратор,
	|	Партии.Организация,
	|	Партии.АналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов,
	|	Партии.СтатьяСписанияНДС,
	|	Партии.АналитикаСписанияНДС,
	|	Партии.РазделУчета,
	|	Партии.Партия,
	|	Партии.АналитикаФинансовогоУчета,
	|	Партии.ВидДеятельностиНДС,
	|	Партии.АналитикаУчетаНоменклатурыДляСвязи,
	|	Партии.ВидЗапасовДляСвязи,
	|	Партии.РаспределениеПоВыбывшимТоварам
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Партии.Регистратор КАК Регистратор
	|ПОМЕСТИТЬ ВтРегистраторы
	|ИЗ
	|	ВтПартии КАК Партии
	|ГДЕ
	|	Партии.НДСРегл <> 0
	|	ИЛИ Партии.НДСУпр <> 0
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	2 КАК Порядок,
	|	Продажи.Период                     КАК Период,
	|	Продажи.Регистратор                КАК Регистратор,
	|	Продажи.Регистратор                КАК ДокументДвижения,
	|	АналитикаПартнеров.Организация     КАК Организация,
	|	Продажи.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Продажи.ВидЗапасов                 КАК ВидЗапасов,
	|	Продажи.РазделУчета				   КАК РазделУчета,
	|	Продажи.Партия				   	   КАК Партия,
	|	Продажи.АналитикаУчетаПартий	   КАК АналитикаУчетаПартий,
	|	Продажи.АналитикаФинансовогоУчета  КАК АналитикаФинансовогоУчета,
	|	Продажи.ВидДеятельностиНДС		   КАК ВидДеятельностиНДС,
	|
	|	Продажи.ЗаказКлиента               КАК ЗаказКлиента,
	|	Продажи.АналитикаУчетаПоПартнерам  КАК АналитикаУчетаПоПартнерам,
	|	Продажи.Подразделение              КАК Подразделение,
	|	Продажи.ТипЗапасов                 КАК ТипЗапасов,
	|	Продажи.Менеджер                   КАК Менеджер,
	|	Продажи.Склад                      КАК Склад,
	|	Продажи.Соглашение                 КАК Соглашение,
	|	Продажи.Договор                    КАК Договор,
	|	Продажи.ХозяйственнаяОперация      КАК ХозяйственнаяОперация,
	|	Продажи.НалогообложениеНДС         КАК НалогообложениеНДС,
	|	Продажи.ВалютаВзаиморасчетов       КАК ВалютаВзаиморасчетов,
	|	Продажи.ВалютаДокумента            КАК ВалютаДокумента,
	|	Продажи.ИсточникГФУНоменклатуры    КАК ИсточникГФУНоменклатуры,
	|	Продажи.ИсточникГФУРасчетов        КАК ИсточникГФУРасчетов,
	|	Продажи.НаправлениеДеятельностиКонтрагента КАК НаправлениеДеятельностиКонтрагента,
	|	Продажи.НаправлениеДеятельностиНоменклатуры КАК НаправлениеДеятельностиНоменклатуры,
	|	Продажи.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатурыДляСвязи,
	|	Продажи.ВидЗапасов КАК ВидЗапасовДляСвязи,
	|
	|	СУММА(ВЫБОР // полностью аналогичное условие должно быть в конструкции ИМЕЮЩИЕ
	|		КОГДА Продажи.РасчетПартий И Продажи.Количество = 0 И Продажи.ДопРасходыРегл <> 0
	|			ТОГДА Продажи.ДопРасходыРегл
	|		КОГДА ЕСТЬNULL(Цены.СтоимостьРегл + Цены.ДопРасходыРегл + Цены.ТрудозатратыРегл, 0) = 0
	|			ТОГДА Продажи.НДСРегл
	|		ИНАЧЕ
	|			ВЫРАЗИТЬ(Продажи.Количество * ЕСТЬNULL(Цены.СтоимостьРегл + Цены.ДопРасходыРегл + Цены.ТрудозатратыРегл, 0) КАК ЧИСЛО(31,2))
	|		КОНЕЦ
	|	) КАК Количество,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК ДопРасходы,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК СтоимостьЗабалансовая,
	|	0 КАК СтоимостьЗабалансоваяРегл,
	|	0 КАК СтоимостьРегл,
	|	0 КАК НДСРегл,
	|	0 КАК НДСУпр,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	0 КАК Трудозатраты,
	|	0 КАК ПостатейныеПостоянныеСНДС,
	|	0 КАК ПостатейныеПеременныеСНДС,
	|	0 КАК ПостатейныеПостоянныеБезНДС,
	|	0 КАК ПостатейныеПеременныеБезНДС,
	|	0 КАК ДопРасходыРегл,
	|	0 КАК ТрудозатратыРегл,
	|	0 КАК ПостатейныеПостоянныеРегл,
	|	0 КАК ПостатейныеПеременныеРегл,
	|	0 КАК СтоимостьУпр,
	|	0 КАК ДопРасходыУпр,
	|	0 КАК ТрудозатратыУпр,
	|	0 КАК ПостатейныеПостоянныеУпр,
	|	0 КАК ПостатейныеПеременныеУпр,
	|
	|	СУММА(ВЫРАЗИТЬ(Продажи.Количество * ЕСТЬNULL(Цены.СтоимостьРегл + Цены.ДопРасходыРегл + Цены.ТрудозатратыРегл, 0) КАК ЧИСЛО(31,2))) КАК ИсходноеКоличество,
	|	0 КАК КорСтоимость
	|ИЗ
	|	ВТКэшРасчетныеОборотыВыручкаИСебестоимостьПродаж КАК Продажи
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтРегистраторы КАК Регистраторы
	|			ПО Регистраторы.Регистратор = Продажи.Регистратор
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборАналитикаПоПартнерам КАК АналитикаПартнеров
	|			ПО Продажи.АналитикаУчетаПоПартнерам = АналитикаПартнеров.КлючАналитики
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТСтоимостьПартийТоваровПредыдущая КАК Цены
	|			ПО Цены.Организация = АналитикаПартнеров.Организация
	|			И Цены.Партия = Продажи.Партия
	|			И Цены.АналитикаУчетаПартий = Продажи.АналитикаУчетаПартий
	|			И Цены.АналитикаФинансовогоУчета = Продажи.АналитикаФинансовогоУчета
	|			И Цены.ВидДеятельностиНДС = Продажи.ВидДеятельностиНДС
	|			И Цены.АналитикаУчетаНоменклатуры = Продажи.АналитикаУчетаНоменклатуры
	|			И Цены.ВидЗапасов = Продажи.ВидЗапасов
	|			И Цены.РазделУчета = Продажи.РазделУчета
	|
	|ГДЕ
	|	АналитикаПартнеров.Организация В(&ОрганизацииСУчетомПартийНДСВерсии24)
	|	И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|	
	|СГРУППИРОВАТЬ ПО
	|	Продажи.Период,
	|	Продажи.Регистратор,
	|	Продажи.АналитикаУчетаНоменклатуры,
	|	Продажи.ЗаказКлиента,
	|	Продажи.АналитикаУчетаПоПартнерам,
	|	Продажи.Подразделение,
	|	Продажи.ТипЗапасов,
	|	Продажи.ВидЗапасов,
	|	Продажи.Менеджер,
	|	Продажи.Склад,
	|	Продажи.Соглашение,
	|	Продажи.Договор,
	|	Продажи.ХозяйственнаяОперация,
	|	Продажи.НалогообложениеНДС,
	|	Продажи.ВалютаВзаиморасчетов,
	|	Продажи.ВалютаДокумента,
	|	Продажи.ИсточникГФУНоменклатуры,
	|	Продажи.ИсточникГФУРасчетов,
	|	Продажи.НаправлениеДеятельностиКонтрагента,
	|	Продажи.НаправлениеДеятельностиНоменклатуры,
	|	АналитикаПартнеров.Организация,
	|	Продажи.РазделУчета,
	|	Продажи.Партия,
	|	Продажи.АналитикаУчетаПартий,
	|	Продажи.АналитикаФинансовогоУчета,
	|	Продажи.ВидДеятельностиНДС,
	|	Продажи.АналитикаУчетаНоменклатуры,
	|	Продажи.ВидЗапасов
	|
	|ИМЕЮЩИЕ
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетПартий И Продажи.Количество = 0 И Продажи.ДопРасходыРегл <> 0
	|			ТОГДА Продажи.ДопРасходыРегл
	|		КОГДА ЕСТЬNULL(Цены.СтоимостьРегл + Цены.ДопРасходыРегл + Цены.ТрудозатратыРегл, 0) = 0
	|			ТОГДА Продажи.НДСРегл
	|		ИНАЧЕ
	|			ВЫРАЗИТЬ(Продажи.Количество * ЕСТЬNULL(Цены.СтоимостьРегл + Цены.ДопРасходыРегл + Цены.ТрудозатратыРегл, 0) КАК ЧИСЛО(31,2))
	|		КОНЕЦ
	|	) <> 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	1 								   КАК Порядок,
	|	Партии.Период 					   КАК Период,
	|	Партии.Регистратор 				   КАК Регистратор,
	|	Партии.Регистратор 				   КАК ДокументДвижения,
	|	Партии.Организация 				   КАК Организация,
	|	Партии.АналитикаУчетаНоменклатуры  КАК АналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов 				   КАК ВидЗапасов,
	|	Партии.РазделУчета				   КАК РазделУчета,
	|	Партии.Партия				   	   КАК Партия,
	|	НЕОПРЕДЕЛЕНО	       			   КАК АналитикаУчетаПартий,
	|	Партии.АналитикаФинансовогоУчета   КАК АналитикаФинансовогоУчета,
	|	Партии.ВидДеятельностиНДС		   КАК ВидДеятельностиНДС,
	|
	|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
	|	НЕОПРЕДЕЛЕНО КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО КАК ТипЗапасов,
	|	НЕОПРЕДЕЛЕНО КАК Менеджер,
	|	НЕОПРЕДЕЛЕНО КАК Склад,
	|	НЕОПРЕДЕЛЕНО КАК Соглашение,
	|	НЕОПРЕДЕЛЕНО КАК Договор,
	|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
	|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
	|	НЕОПРЕДЕЛЕНО КАК ВалютаВзаиморасчетов,
	|	НЕОПРЕДЕЛЕНО КАК ВалютаДокумента,
	|	НЕОПРЕДЕЛЕНО КАК ИсточникГФУНоменклатуры,
	|	НЕОПРЕДЕЛЕНО КАК ИсточникГФУРасчетов,
	|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельностиКонтрагента,
	|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельностиНоменклатуры,
	|	Партии.АналитикаУчетаНоменклатурыДляСвязи КАК АналитикаУчетаНоменклатурыДляСвязи,
	|	Партии.ВидЗапасовДляСвязи КАК ВидЗапасовДляСвязи,
	|
	|	СУММА(ВЫБОР КОГДА Партии.Стоимость < 0 ТОГДА -Партии.Стоимость
	|		ИНАЧЕ Партии.Стоимость КОНЕЦ) КАК Количество,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК ДопРасходы,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК СтоимостьЗабалансовая,
	|	0 КАК СтоимостьЗабалансоваяРегл,
	|	СУММА(ВЫБОР
	|		КОГДА Партии.РаспределениеПоВыбывшимТоварам ТОГДА 0
	|		ИНАЧЕ Партии.НДСРегл КОНЕЦ) КАК СтоимостьРегл,
	|	0 КАК НДСРегл,
	|	0 КАК НДСУпр,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	0 КАК Трудозатраты,
	|	0 КАК ПостатейныеПостоянныеСНДС,
	|	0 КАК ПостатейныеПеременныеСНДС,
	|	0 КАК ПостатейныеПостоянныеБезНДС,
	|	0 КАК ПостатейныеПеременныеБезНДС,
	|	СУММА(ВЫБОР
	|		КОГДА Партии.РаспределениеПоВыбывшимТоварам ТОГДА Партии.НДСРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыРегл,
	|	0 КАК ТрудозатратыРегл,
	|	0 КАК ПостатейныеПостоянныеРегл,
	|	0 КАК ПостатейныеПеременныеРегл,
	|	СУММА(ВЫБОР
	|		КОГДА Партии.РаспределениеПоВыбывшимТоварам ТОГДА 0
	|		ИНАЧЕ Партии.НДСУпр КОНЕЦ) КАК СтоимостьУпр,
	|	СУММА(ВЫБОР
	|		КОГДА Партии.РаспределениеПоВыбывшимТоварам ТОГДА Партии.НДСУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыУпр,
	|	0 КАК ТрудозатратыУпр,
	|	0 КАК ПостатейныеПостоянныеУпр,
	|	0 КАК ПостатейныеПеременныеУпр,
	|
	|	0 КАК ИсходноеКоличество,
	|	0 КАК КорСтоимость
	|ИЗ
	|	ВтПартии КАК Партии
	|ГДЕ
	|	Партии.Стоимость <> 0
	|
	|СГРУППИРОВАТЬ ПО
	|	Партии.Период,
	|	Партии.Регистратор,
	|	Партии.Организация,
	|	Партии.АналитикаУчетаНоменклатуры,
	|	Партии.ВидЗапасов,
	|	Партии.РазделУчета,
	|	Партии.Партия,
	|	Партии.АналитикаФинансовогоУчета,
	|	Партии.ВидДеятельностиНДС,
	|	Партии.АналитикаУчетаНоменклатурыДляСвязи,
	|	Партии.ВидЗапасовДляСвязи
	|
	|ИМЕЮЩИЕ
	|	СУММА(Партии.НДСРегл) <> 0
	|	ИЛИ СУММА(Партии.НДСУпр) <> 0
	|
	|УПОРЯДОЧИТЬ ПО
	|	Регистратор,
	|	Организация,
	|	Партия,
	|	ВидДеятельностиНДС,
	|	АналитикаУчетаНоменклатурыДляСвязи,
	|	ВидЗапасовДляСвязи,
	|	Порядок
	|";
	
	ЗаписьРаспределения = Новый Структура("
	|Период, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, Менеджер,
	|АналитикаУчетаНоменклатурыДляСвязи, ВидЗапасовДляСвязи,
	|ХозяйственнаяОперация, ЗаказКлиента, ТипЗапасов,
	|Подразделение, АналитикаУчетаПоПартнерам,
	|Склад, Соглашение, Договор, ВалютаВзаиморасчетов, ВалютаДокумента,
	|ИсточникГФУНоменклатуры, ИсточникГФУРасчетов,
	|НаправлениеДеятельностиКонтрагента, НаправлениеДеятельностиНоменклатуры,
	|НалогообложениеНДС, ДокументДвижения,
	|РазделУчета, Партия, АналитикаУчетаПартий, АналитикаФинансовогоУчета, ВидДеятельностиНДС,
	|Стоимость, СтоимостьБезНДС, Количество,
	|ДопРасходы, ДопРасходыБезНДС,
	|СтоимостьРегл, НДСРегл, НДСУпр, ПостояннаяРазница, ВременнаяРазница,
	|СтоимостьЗабалансовая, Трудозатраты, ПостатейныеПостоянныеСНДС, ПостатейныеПеременныеСНДС,
	|ПостатейныеПостоянныеБезНДС, ПостатейныеПеременныеБезНДС,
	|СтоимостьЗабалансоваяРегл, ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеПостоянныеРегл, ПостатейныеПеременныеРегл,
	|СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр");
	
	СтрокаОстатка = Новый Структура("
	|Регистратор, Организация, АналитикаУчетаНоменклатуры, ВидЗапасов,
	|РазделУчета, Партия, АналитикаУчетаПартий, АналитикаФинансовогоУчета, ВидДеятельностиНДС,
	|АналитикаУчетаНоменклатурыДляСвязи, ВидЗапасовДляСвязи,
	|Количество, Стоимость, СтоимостьБезНДС, СтоимостьРегл, НДСРегл, НДСУпр,
	|ДопРасходы, ДопРасходыБезНДС, ПостояннаяРазница, ВременнаяРазница,
	|СтоимостьЗабалансовая, Трудозатраты, ПостатейныеПостоянныеСНДС, ПостатейныеПеременныеСНДС,
	|ПостатейныеПостоянныеБезНДС, ПостатейныеПеременныеБезНДС,
	|СтоимостьЗабалансоваяРегл, ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеПостоянныеРегл, ПостатейныеПеременныеРегл,
	|СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр");
	
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина,,,
		Метаданные.РегистрыНакопления.ВыручкаИСебестоимостьПродаж.Имя);
	
	// Формируются движения по регистрам:
	// - ВыручкаИСебестоимостьПродаж
	Пока Выборка.Следующий() Цикл
		
		Если Выборка.Порядок = 1 Тогда
			
			ЗаполнитьЗначенияСвойств(СтрокаОстатка, Выборка);
			
		ИначеЕсли СтрокаОстатка.Регистратор = Выборка.Регистратор
		 И СтрокаОстатка.Организация = Выборка.Организация
		 И СтрокаОстатка.Партия = Выборка.Партия
		 И СтрокаОстатка.ВидДеятельностиНДС = Выборка.ВидДеятельностиНДС
		 И СтрокаОстатка.АналитикаУчетаНоменклатурыДляСвязи = Выборка.АналитикаУчетаНоменклатурыДляСвязи
		 И СтрокаОстатка.ВидЗапасовДляСвязи = Выборка.ВидЗапасовДляСвязи
		 И СтрокаОстатка.Количество > 0 Тогда
		
			ЗаполнитьЗначенияСвойств(ЗаписьРаспределения, Выборка);
			
			РасчетСебестоимостиКорректировкаСтоимости.РаспределитьСтоимость(ЗаписьРаспределения, СтрокаОстатка, Выборка, Выборка.Количество);
			
			РасчетСебестоимостиКорректировкаСтоимости.СформироватьДвиженияВыручкаИСебестоимостьПродаж(ПараметрыРасчета, ЗаписьРаспределения);

		КонецЕсли;
		
	КонецЦикла;
	
	// Формируются движения по регистрам:
	// - ПрочиеРасходы
	РасчетСебестоимостиКорректировкаСтоимости.СформироватьДвиженияПрочиеРасходыСписаниеНДС(ПараметрыРасчета);
	
	// Формируются движения по регистрам:
	// - ДвиженияНоменклатураДоходыРасходы
	РасчетСебестоимостиКорректировкаСтоимости.СформироватьДвиженияНоменклатураДоходыРасходыСписаниеНДС(ПараметрыРасчета);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, "ВтПартии, ДвиженияПродаж, ВтРегистраторы");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвижения(ПараметрыРасчета);
	
КонецПроцедуры

#КонецОбласти

#Область СписаниеОшибокОкругления

Процедура СписатьОшибкиОкругленияРасчетаСебестоимости(ПараметрыРасчета) Экспорт
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиКорректировкаСтоимости.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	// Списание ошибок округления в регистре ДетализацияПартийТоваровДляНДСиУСН2_4
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.Организация КАК Организация,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	СУММА(Т.КоличествоСебестоимость) КАК КоличествоСебестоимость,
	|	СУММА(Т.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	СУММА(Т.НДС) КАК НДС,
	|	СУММА(Т.СтоимостьБезНДСУпр) КАК СтоимостьБезНДСУпр,
	|	СУММА(Т.НДСУпр) КАК НДСУпр
	|ПОМЕСТИТЬ ВТОкруглениеДетализацияПартийТоваровДляНДСиУСН2_4
	|ИЗ
	|	(ВЫБРАТЬ
	|		Т.Организация КАК Организация,
	|		Т.Партия КАК Партия,
	|		ЕСТЬNULL(АналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)) КАК АналитикаУчетаПартий,
	|		Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|		Т.Количество КАК КоличествоСебестоимость,
	|		0 КАК СтоимостьБезНДС,
	|		0 КАК НДС,
	|		0 КАК СтоимостьБезНДСУпр,
	|		0 КАК НДСУпр
	|	ИЗ
	|		ВТКэшРасчетныеОстаткиСебестоимостьТоваров КАК Т
	|			ЛЕВОЕ СОЕДИНЕНИЕ ВТОтборАналитикиУчетаПартийНДС2_4 КАК АналитикиУчетаПартий
	|			ПО Т.АналитикаУчетаПартий = АналитикиУчетаПартий.Ссылка
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Т.Организация,
	|		Т.Партия,
	|		Т.АналитикаУчетаПартий,
	|		Т.ВидДеятельностиНДС,
	|		0,
	|		Т.СтоимостьБезНДС,
	|		Т.НДС,
	|		Т.СтоимостьБезНДСУпр,
	|		Т.НДСУпр
	|	ИЗ
	|		ВТКэшРасчетныеОстаткиДетализацияПартийТоваровДляНДСиУСН2_4 КАК Т) КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС
	|
	|ИМЕЮЩИЕ
	|	СУММА(Т.КоличествоСебестоимость) = 0
	|	И СУММА(Т.СтоимостьБезНДС) МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|	И СУММА(Т.НДС) МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|	И СУММА(Т.СтоимостьБезНДСУпр) МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|	И СУММА(Т.НДСУпр) МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыРасчетаСебестоимости.Ссылка 		КАК ДокументДвижения,
	|	&КонецПериода								КАК Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)		КАК ВидДвижения,
	|
	|	Т.Организация КАК Организация,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Т.ДокументПоступления КАК ДокументПоступления,
	|	Т.АналитикаУчетаДокументаПоступления КАК АналитикаУчетаДокументаПоступления,
	|	Т.Номенклатура КАК Номенклатура,
	|	Т.Характеристика КАК Характеристика,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПогрешностьРасчетаСебестоимости)	КАК СтатьяРасходовАктивов,
	|
	|	Т.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|	Т.НДС КАК НДС,
	|	Т.СтоимостьБезНДСУпр КАК СтоимостьБезНДСУпр,
	|	Т.НДСУпр КАК НДСУпр
	|ИЗ
	|	ВТКэшРасчетныеОстаткиДетализацияПартийТоваровДляНДСиУСН2_4 КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОкруглениеДетализацияПартийТоваровДляНДСиУСН2_4 КАК Округление
	|		ПО Т.Организация = Округление.Организация
	|			И Т.Партия = Округление.Партия
	|			И Т.АналитикаУчетаПартий = Округление.АналитикаУчетаПартий
	|			И Т.ВидДеятельностиНДС = Округление.ВидДеятельностиНДС
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыРасчетаСебестоимости
	|			ПО Т.Организация = ДокументыРасчетаСебестоимости.Организация";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьДвиженияПоРегиструПоДаннымЗапроса(
		ПараметрыРасчета,
		Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН2_4.Имя,
		Запрос,
		Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН2_4.Имя);
	
КонецПроцедуры

#КонецОбласти

#Область УчетНДС

// Возвращает имя регистра, используемого для учета партий НДС, при партионном учете версии 2.2.
//
// Параметры:
//	Организация - СправочникСсылка.Организации - организация
//	Период 		- Дата - период учета НДС
//
// Возвращаемое значение:
//	Строка - имя регистра учета партий НДС;
//		возможные значения:
//		- "ДетализацияПартийТоваровДляНДСиУСН"
//		- "ДетализацияПартийТоваровДляНДСиУСН2_4"
//		- ""
//
Функция ИмяРегистраУчетаПартийНДС(Организация, Период = Неопределено) Экспорт
	
	ИмяРегистра 		   = "";
	ПериодПолитики		   = НачалоМесяца(?(ЗначениеЗаполнено(Период), Период, ТекущаяДатаСеанса()));
	ПартионныйУчетВерсии22 = РасчетСебестоимостиПовтИсп.ПартионныйУчетВерсии22(ПериодПолитики);
	
	Если ПартионныйУчетВерсии22 Тогда
		
		ПараметрыУчетнойПолитики = ЗначениеНастроекПовтИсп.ПараметрыУчетнойПолитики(Организация, ПериодПолитики); 
		
		Если ПараметрыУчетнойПолитики.РаздельныйУчетТоваров Тогда
			
			Если ПараметрыУчетнойПолитики.МетодОценкиСтоимостиТоваров = Перечисления.МетодыОценкиСтоимостиТоваров.ФИФОСкользящаяОценка Тогда
				ИмяРегистра = Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН2_4.Имя;
			Иначе
				ИмяРегистра = Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН.Имя;
			КонецЕсли;
			
		КонецЕсли;

		
	КонецЕсли;
	
	Возврат ИмяРегистра;
	
КонецФункции

#КонецОбласти

#Область ПоследовательностиРасчета

// Устанавливает признак необходимости распределению НДС и формирования записей книги покупок/продаж в указанном периоде.
//
Процедура СформироватьЗаданияДляМеханизмовУчетаНДСПартионныйУчет21(РассчитанныйПериод, МассивОрганизаций, ОкончаниеРасчета = Истина) Экспорт
	
	ТекстЗапроса = "";
	ШаблонТекстаЗапроса = "
	|%1
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Организация КАК Организация,
	|	%2
	|	%3
	|	Т.НалогообложениеНДС КАК КорВидДеятельностиНДС
	|ИЗ 
	|	РегистрНакопления.%4 КАК Т
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В (&МассивОрганизаций)
	|	И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И Т.Активность
	|	%5
	|";
	
	ПартионныеРегистры = Новый Соответствие;
	ПартионныеРегистры.Вставить(Метаданные.РегистрыНакопления.ПартииТоваровОрганизаций, 			"ДокументПоступления");
	ПартионныеРегистры.Вставить(Метаданные.РегистрыНакопления.ПартииТоваровПереданныеНаКомиссию, 	"ДокументПоступления");
	ПартионныеРегистры.Вставить(Метаданные.РегистрыНакопления.ПартииРасходовНаСебестоимостьТоваров, "ДокументПоступления");
	ПартионныеРегистры.Вставить(Метаданные.РегистрыНакопления.ПартииПроизводственныхЗатрат, 		"ДокументПоступления");
	ПартионныеРегистры.Вставить(Метаданные.РегистрыНакопления.ПартииЗатратНаВыпуск, 				"ДокументПоступления");
	ПартионныеРегистры.Вставить(Метаданные.РегистрыНакопления.ПартииПрочихРасходов, 				"ДокументПоступленияРасходов");
	
	Для Каждого ОбслуживаемыйРегистр Из ПартионныеРегистры Цикл
		
		ТекстЗапроса = ТекстЗапроса
			+ СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				ШаблонТекстаЗапроса,
				?(ТекстЗапроса = "", "", "ОБЪЕДИНИТЬ ВСЕ"),
				?(ОкончаниеРасчета, "ЕСТЬNULL(Т.АналитикаУчетаПартий.НалогообложениеНДС, ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)) КАК ВидДеятельностиНДС,", ""),
				?(ОкончаниеРасчета, "Т." + ОбслуживаемыйРегистр.Значение + " КАК СчетФактура,", ""),
				ОбслуживаемыйРегистр.Ключ.Имя,
				?(ОбслуживаемыйРегистр.Ключ = Метаданные.РегистрыНакопления.ПартииПрочихРасходов, "И НЕ Т.Регистратор ССЫЛКА Документ.РаспределениеНДС", ""));
		
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
	Запрос.УстановитьПараметр("НачалоПериода",     НачалоМесяца(РассчитанныйПериод));
	Запрос.УстановитьПараметр("КонецПериода",      КонецМесяца(РассчитанныйПериод));
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	&НачалоПериода КАК Период,
	|	Т.Организация,
	|	%1
	|	%2
	|	Т.КорВидДеятельностиНДС
	|ПОМЕСТИТЬ ВтИзменениеПартий
	|ИЗ
	|(%3) КАК Т";
	
	Запрос.Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		Запрос.Текст,
		?(ОкончаниеРасчета, "Т.ВидДеятельностиНДС,", ""),
		?(ОкончаниеРасчета, "Т.СчетФактура,", ""),
		СокрЛП(ТекстЗапроса));
	
	Запрос.Выполнить();
	
	Если РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(Запрос, "ВтИзменениеПартий") = 0 Тогда
		Возврат;
	КонецЕсли;
	
	УчетНДСУП.СформироватьЗаданияДляРаспределенияНДС(Запрос.МенеджерВременныхТаблиц);
	
	Если ОкончаниеРасчета Тогда
		УчетНДСУП.СформироватьЗаданияДляФормированияКнигиПокупокПродаж(Запрос.МенеджерВременныхТаблиц);
	КонецЕсли;
	
КонецПроцедуры

// Подготавливает данные для формирования записей книги покупок/продаж в указанном периоде.
// Для этого необходимо собрать данные регистров НДС из ИБ до начала записи сформированных при расчете движений.
//
Процедура ПодготовитьДанныеДляФормированияЗаданийДляМеханизмовУчетаНДСПартионныйУчет22(ПараметрыРасчета) Экспорт
	
	Если ПараметрыРасчета.ВариантРасчета <> Перечисления.ВариантыРасчетаПартийИСебестоимости.ПартииИСебестоимость Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Организация КАК Организация,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Т.КорВидДеятельностиНДС КАК КорВидДеятельностиНДС,
	|	Т.СчетФактура КАК СчетФактура
	|ПОМЕСТИТЬ ВтСтарыеДанныеДляМеханизмовУчетаНДС
	|ИЗ
	|	(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация КАК Организация,
	|		Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|		Т.КорВидДеятельностиНДС КАК КорВидДеятельностиНДС,
	|		Т.ДокументПоступления КАК СчетФактура
	|	ИЗ
	|		РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН КАК Т
	|	ГДЕ
	|		Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Т.Организация В(&МассивОрганизаций)
	|		И (Т.СтоимостьБезНДС <> 0 ИЛИ Т.НДС <> 0 ИЛИ Т.НДСУпр <> 0)
	|		И Т.Активность
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		Т.ВидДеятельностиНДС,
	|		Т.КорВидДеятельностиНДС,
	|		Т.ДокументПоступления
	|	ИЗ
	|		РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН2_4 КАК Т
	|	ГДЕ
	|		Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Т.Организация В(&МассивОрганизаций)
	|		И (Т.СтоимостьБезНДС <> 0 ИЛИ Т.НДС <> 0 ИЛИ Т.НДСУпр <> 0)
	|		И Т.Активность
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		ЕСТЬNULL(Т.АналитикаУчетаПартий.НалогообложениеНДС, ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)),
	|		Т.НалогообложениеНДС,
	|		Т.ДокументПоступленияРасходов
	|	ИЗ
	|		РегистрНакопления.ПартииПрочихРасходов КАК Т
	|	ГДЕ
	|		Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Т.Организация В(&МассивОрганизаций)
	|		И НЕ Т.Регистратор ССЫЛКА Документ.РаспределениеНДС
	|		И (Т.СтоимостьРегл <> 0 ИЛИ Т.НДСРегл <> 0 ИЛИ Т.НДСУпр <> 0)
	|		И Т.Активность
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		Т.ВидДеятельностиНДС,
	|		Т.КорВидДеятельностиНДС,
	|		Т.ДокументПоступленияРасходов
	|	ИЗ
	|		РегистрНакопления.ПартииНДСКРаспределению КАК Т
	|	ГДЕ
	|		Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Т.Организация В(&МассивОрганизаций)
	|		И НЕ Т.Регистратор ССЫЛКА Документ.РаспределениеНДС
	|		И (Т.СтоимостьРегл <> 0 ИЛИ Т.НДСРегл <> 0 ИЛИ Т.НДСУпр <> 0)
	|		И Т.Активность
	|	) КАК Т";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
	
КонецПроцедуры

// Устанавливает признак необходимости распределению НДС и формирования записей книги покупок/продаж в указанном периоде.
//
Процедура СформироватьЗаданияДляМеханизмовУчетаНДСПартионныйУчет22(ПараметрыРасчета) Экспорт
	
	Если ПараметрыРасчета.ВариантРасчета <> Перечисления.ВариантыРасчетаПартийИСебестоимости.ПартииИСебестоимость Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	&НачалоПериода КАК Период,
	|	Т.Организация КАК Организация,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Т.КорВидДеятельностиНДС КАК КорВидДеятельностиНДС,
	|	Т.СчетФактура КАК СчетФактура
	|ПОМЕСТИТЬ ВтИзменениеПартий
	|ИЗ
	|	(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация КАК Организация,
	|		Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|		Т.КорВидДеятельностиНДС КАК КорВидДеятельностиНДС,
	|		Т.ДокументПоступления КАК СчетФактура
	|	ИЗ
	|		ВТКэшДетализацияПартийТоваровДляНДСиУСН КАК Т
	|	ГДЕ
	|		Т.СтоимостьБезНДС <> 0 ИЛИ Т.НДС <> 0 ИЛИ Т.НДСУпр <> 0
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		Т.ВидДеятельностиНДС,
	|		Т.КорВидДеятельностиНДС,
	|		Т.ДокументПоступления
	|	ИЗ
	|		ВТКэшДетализацияПартийТоваровДляНДСиУСН2_4 КАК Т
	|	ГДЕ
	|		Т.СтоимостьБезНДС <> 0 ИЛИ Т.НДС <> 0 ИЛИ Т.НДСУпр <> 0
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		ЕСТЬNULL(Т.АналитикаУчетаПартий.НалогообложениеНДС, ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)),
	|		Т.НалогообложениеНДС,
	|		Т.ДокументПоступленияРасходов
	|	ИЗ
	|		ВТКэшПартииПрочихРасходов КАК Т
	|	ГДЕ
	|		Т.СтоимостьРегл <> 0 ИЛИ Т.НДСРегл <> 0 ИЛИ Т.НДСУпр <> 0
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		Т.ВидДеятельностиНДС,
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением),
	|		Т.ДокументПоступленияРасходов
	|	ИЗ
	|		ВТКэшПартииНДСКРаспределению КАК Т
	|	ГДЕ
	|		Т.СтоимостьРегл <> 0 ИЛИ Т.НДСРегл <> 0 ИЛИ Т.НДСУпр <> 0
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.Организация,
	|		Т.ВидДеятельностиНДС,
	|		Т.КорВидДеятельностиНДС,
	|		Т.СчетФактура
	|	ИЗ
	|		ВтСтарыеДанныеДляМеханизмовУчетаНДС КАК Т
	|	) КАК Т";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
	
	Если РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(Запрос, "ВтИзменениеПартий") > 0 Тогда
		УчетНДСУП.СформироватьЗаданияДляРаспределенияНДС(Запрос.МенеджерВременныхТаблиц);
		УчетНДСУП.СформироватьЗаданияДляФормированияКнигиПокупокПродаж(Запрос.МенеджерВременныхТаблиц);
	КонецЕсли;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(
		ПараметрыРасчета,
		"ВтСтарыеДанныеДляМеханизмовУчетаНДС, ВтИзменениеПартий");
	
КонецПроцедуры

#КонецОбласти

#Область СостояниеОперацииЗакрытияМесяца

Процедура Использование_РасчетПартийИСебестоимости(ПараметрыОбработчика) Экспорт
	
	ПараметрыРасчета = ПараметрыОбработчика.ПараметрыРасчета;
	ПериодРасчета    = ПараметрыРасчета.ПериодРегистрации;
	МассивОрганизаций = ПараметрыОбработчика.ДанныеЭтапа.МассивОрганизаций;
	
	ПериодПересчетаПартийНДС = ПроверкаНеобходимостьПересчетаРегистраПартийНДС(ПараметрыРасчета);
	
	Если ЗначениеЗаполнено(ПериодПересчетаПартийНДС) Тогда
		
		ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru='Обнаружены некорректные движения по регистру ""%1"" за период %2.
				|Необходимо выполнить закрытие месяца начиная с данного периода.'"),
			Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН2_4.Синоним,
			РасчетСебестоимостиПротоколРасчета.ПредставлениеПериодаРасчета(ПериодПересчетаПартийНДС));
		
		ЗакрытиеМесяцаСервер.ДобавитьПоясняющуюИнформациюКЭтапу(
			ПараметрыОбработчика,
			ТекстОшибки,
			,
			,
			Перечисления.ВариантыВажностиПроблемыСостоянияСистемы.Ошибка);
		
	КонецЕсли;
	
	ОрганизацииСДвижениямиПоСебестоимости = РасчетСебестоимостиПрикладныеАлгоритмы.ОрганизацииСДвижениямиПоСебестоимости(
		ПериодРасчета,
		МассивОрганизаций);
	
	СостояниеКорректировкиНДС = СостояниеКорректировкиНДС(ПериодРасчета, МассивОрганизаций);
	
	ЗакрытиеМесяцаСервер.УвеличитьКоличествоОбработанныхДанныхДляЗамера(ПараметрыОбработчика, 1);
	
	Если СостояниеКорректировкиНДС = Перечисления.СостоянияОперацийЗакрытияМесяца.НеВыполнено Тогда
		
		ЗакрытиеМесяцаСервер.УстановитьСостояниеНеВыполнен(
			ПараметрыОбработчика,
			НСтр("ru='Требуется выполнить корректировку налогообложения НДС.'"));
		Возврат;
		
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ОрганизацииСДвижениямиПоСебестоимости)
 	 И СостояниеКорректировкиНДС = Перечисления.СостоянияОперацийЗакрытияМесяца.НеТребуется Тогда
		
		ЗакрытиеМесяцаСервер.УстановитьСостояниеНеТребуется(
			ПараметрыОбработчика,
			НСтр("ru='Нет движений по регистрам себестоимости и прочих расходов.'"));
		Возврат;
		
	КонецЕсли;
	
КонецПроцедуры

// Возвращает текущее состояние корректировки налогообложения НДС.
//
Функция СостояниеКорректировкиНДС(ПериодРасчета, МассивОрганизаций) Экспорт
	
	НеТребуетсяКорректировкаНДС = Истина;
	ВыполненаКорректировкаНДС	= Истина;
	
	Если РасчетСебестоимостиПовтИсп.ПартионныйУчетВерсии21(НачалоМесяца(ПериодРасчета))
	 И КонецКвартала(ПериодРасчета) = КонецМесяца(ПериодРасчета) Тогда
		
		НачалоСледНалПериода = КонецМесяца(ПериодРасчета) + 1;
		
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("НачалоПериода", 	   		 НачалоМесяца(ПериодРасчета));
		Запрос.УстановитьПараметр("КонецПериода",  	   		 КонецМесяца(ПериодРасчета));
		Запрос.УстановитьПараметр("МассивОрганизаций", 		 МассивОрганизаций);
		Запрос.УстановитьПараметр("ГраницаКонецПериода", 	 Новый Граница(КонецМесяца(ПериодРасчета), ВидГраницы.Исключая));
		Запрос.УстановитьПараметр("НачалоПериодаМинус3Года", ДобавитьМесяц(НачалоСледНалПериода, -36));
		Запрос.УстановитьПараметр("КонецПериодаМинус3Года",  ДобавитьМесяц(КонецКвартала(НачалоСледНалПериода), -36));
		
		// Необходимость корректировки НДС проверяем по наборам аналитик
		Запрос.Текст =
		"ВЫБРАТЬ
		|	Партии.Организация,
		|	Партии.АналитикаУчетаНоменклатуры,
		|	Партии.ДокументПоступления,
		|	Партии.ВидЗапасов,
		|	Партии.АналитикаУчетаПартий,
		|	СУММА(Партии.КоличествоОстаток) КАК КоличествоОстаток,
		|	СУММА(Партии.Количество) КАК Количество
		|ПОМЕСТИТЬ ВТПартии
		|ИЗ
		// Регистры, используемые только в партионном учете версии 2.1
		|	(ВЫБРАТЬ
		|		Остатки.Организация						КАК Организация,
		|		Остатки.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
		|		Остатки.ДокументПоступления				КАК ДокументПоступления,
		|		Остатки.ВидЗапасов						КАК ВидЗапасов,
		|		Остатки.АналитикаУчетаПартий			КАК АналитикаУчетаПартий,
		|		Остатки.КоличествоОстаток				КАК КоличествоОстаток,
		|		Остатки.КоличествоОстаток				КАК Количество
		|	ИЗ
		|		РегистрНакопления.ПартииТоваровОрганизаций.Остатки(
		|				&ГраницаКонецПериода,
		|				АналитикаУчетаПартий.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПоФактическомуИспользованию)
		|				И Организация В(&МассивОрганизаций)
		|		) КАК Остатки
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
		|			ПО Остатки.ДокументПоступления = ДанныеПервичныхДокументов.Документ
		|	ГДЕ
		|		ДанныеПервичныхДокументов.ДатаРегистратора МЕЖДУ &НачалоПериодаМинус3Года И &КонецПериодаМинус3Года
		|		И Остатки.КоличествоОстаток > 0
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		Остатки.Организация						КАК Организация,
		|		Остатки.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
		|		Остатки.ДокументПоступления				КАК ДокументПоступления,
		|		Остатки.ВидЗапасов						КАК ВидЗапасов,
		|		Остатки.АналитикаУчетаПартий			КАК АналитикаУчетаПартий,
		|		0										КАК КоличествоОстаток,
		|		Остатки.Количество						КАК Количество
		|	ИЗ
		|		РегистрНакопления.ПартииТоваровОрганизаций КАК Остатки
		|	ГДЕ
		|		Остатки.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|		И Остатки.Организация В(&МассивОрганизаций)
		|		И Остатки.Активность
		|		И Остатки.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|		И Остатки.Регистратор ССЫЛКА Документ.КорректировкаНалогообложенияНДСПартийТоваров
		|		И Остатки.ДокументПоступления.Дата МЕЖДУ &НачалоПериодаМинус3Года И &КонецПериодаМинус3Года
		|	) КАК Партии
		|
		|СГРУППИРОВАТЬ ПО
		|	Партии.Организация,
		|	Партии.АналитикаУчетаНоменклатуры,
		|	Партии.ДокументПоступления,
		|	Партии.ВидЗапасов,
		|	Партии.АналитикаУчетаПартий
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	МИНИМУМ(Партии.КоличествоОстаток) КАК КоличествоОстаток,
		|	МАКСИМУМ(Партии.Количество) КАК Количество
		|ИЗ
		|	ВТПартии КАК Партии";
		
		Выборка = Запрос.Выполнить().Выбрать();
		Выборка.Следующий();
		
		НеТребуетсяКорректировкаНДС = (Выборка.Количество = NULL ИЛИ Выборка.Количество <= 0);
		ВыполненаКорректировкаНДС   = НеТребуетсяКорректировкаНДС ИЛИ (Выборка.КоличествоОстаток <> NULL И Выборка.КоличествоОстаток > 0);
		
	КонецЕсли;
	
	Если НеТребуетсяКорректировкаНДС Тогда
		Состояние = Перечисления.СостоянияОперацийЗакрытияМесяца.НеТребуется;
	ИначеЕсли ВыполненаКорректировкаНДС Тогда
		Состояние = Перечисления.СостоянияОперацийЗакрытияМесяца.ВыполненоУспешно;
	Иначе
		Состояние = Перечисления.СостоянияОперацийЗакрытияМесяца.НеВыполнено;
	КонецЕсли;
	
	Возврат Состояние;
	
КонецФункции

#КонецОбласти

#Область АнализСостоянияСистемы

// Заполняет проверки, выполняемые в рамках расчета партий и себестоимости.
//
// Параметры:
//	ТаблицаПроверок - Таблица значений - см. АудитСостоянияСистемыПереопределяемый.ЗаполнитьПроверкиДляРегистрации().
//
Процедура ЗаполнитьПроверкиДляРегистрации(ТаблицаПроверок) Экспорт
	
	// Соответствие остатков в регистрах СебестоимостьТоваров и ДетализацияПартийТоваровДляНДСиУСН.
	// Технологическая проверка для автотестов, см. технологический параметр "ПроверятьСоответствиеСебестоимостиИПартийНДС".
	ОписаниеПроверки = ЗакрытиеМесяцаСервер.ДобавитьОписаниеНовойПроверки(ТаблицаПроверок,
		"СоответствиеРегистровСебестоимостиИПартийНДС",
		Перечисления.ОперацииЗакрытияМесяца.РасчетПартийИСебестоимости,
		Перечисления.МоментЗапускаПроверкиОперацииЗакрытияМесяца.ПослеРасчета,
		"РасчетСебестоимостиНДС.ПроверкаСоответствияРегистровСебестоимостиИПартийНДС",
		Перечисления.ВариантыВажностиПроблемыСостоянияСистемы.Ошибка);
	
	ОписаниеПроверки.ВозможноИзменениеВажности = Истина;
	
	ЗакрытиеМесяцаСервер.ЗаполнитьПредставлениеНовойПроверки(ОписаниеПроверки,
		НСтр("ru='Соответствие остатков в регистрах себестоимости и партий НДС.'"),
		НСтр("ru='Остатки по регистру ""Детализация партий товаров для НДС и УСН"" должны соответствовать остаткам по регистру ""Себестоимость товаров"":
			|- остатки по количеству в регистре партий НДС не должны превышать остатки по количеству в регистре себестоимости
			|- не должно быть остатков по суммам регл. (СтоимостьБезНДС + НДС) в регистре партий НДС при отсутствии остатков по суммам регл. в регистре себестоимости (СтоимостьРегл + ДопРасходыРегл)
			|- не должно быть остатков по суммам упр. в регистре партий НДС (НДСУпр) при отсутствии остатков по суммам упр. в регистре себестоимости (СтоимостьУпр + ДопРасходыУпр)'"));
	
	
КонецПроцедуры

// Процедура-обработчик проверки состояния системы "СоответствиеРегистровСебестоимостиИПартийНДС".
//
Процедура ПроверкаСоответствияРегистровСебестоимостиИПартийНДС(ПараметрыПроверки) Экспорт
	
	ЗначенияПараметров = РасчетСебестоимостиПовтИсп.ЗначенияТехнологическихПараметров();
	
	// Проверка выполняется если явно включен соответствующий технологический параметр.
	Если НЕ ЗначенияПараметров.ПроверятьСоответствиеСебестоимостиИПартийНДС Тогда
		Возврат;
	КонецЕсли;
	
	ТекстЗапроса =
	ТекстЗапросаТаблицыДляОтбораАналитикУчетаПартийНДС2_4() + "
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|" + "
	|
	|ВЫБРАТЬ
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Т.КоличествоОстаток КАК Количество,
	|	Т.СтоимостьРеглОстаток + Т.ДопРасходыРеглОстаток + Т.ПостатейныеПостоянныеРеглОстаток КАК СтоимостьРегл,
	|	Т.СтоимостьУпрОстаток + Т.ДопРасходыУпрОстаток + Т.ПостатейныеПостоянныеУпрОстаток КАК СтоимостьУпр
	|ПОМЕСТИТЬ ВТСебестоимость
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров.Остатки(
	|		&ГраницаКонецПериода,
	|		Организация В (&МассивОрганизаций)
	|		И &ПартионныйУчетВерсии22
	|		И НЕ РазделУчета В (
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку),
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки))
	|	) КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Т.КоличествоОстаток КАК Количество,
	|	Т.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС
	|ПОМЕСТИТЬ ВТПартииНДС
	|ИЗ
	|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН.Остатки(
	|		&ГраницаКонецПериода,
	|		Организация В (&МассивОрганизаций)
	|		И &ПартионныйУчетВерсии22
	|		И НЕ РазделУчета В (
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку),
	|			ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки))
	|	) КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация КАК Организация,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Т.СтоимостьБезНДСОстаток
	|		+ ВЫБОР
	|			КОГДА Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|				ТОГДА Т.НДСОстаток
	|			ИНАЧЕ 0
	|		КОНЕЦ КАК СтоимостьРегл,
	|	Т.СтоимостьБезНДСУпрОстаток
	|		+ ВЫБОР
	|			КОГДА Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|				ТОГДА Т.НДСУпрОстаток
	|			ИНАЧЕ 0
	|		КОНЕЦ КАК СтоимостьУпр
	|ПОМЕСТИТЬ ВТПартииНДС2_4
	|ИЗ
	|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН2_4.Остатки(
	|		&ГраницаКонецПериода,
	|		Организация В (&МассивОрганизаций)
	|		И &ПартионныйУчетВерсии22
	|	) КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	СУММА(Т.КоличествоСебестоимость) КАК КоличествоСебестоимость,
	|	СУММА(Т.КоличествоПартииНДС) КАК КоличествоПартииНДС
	|ПОМЕСТИТЬ ВТРасхожденияСебестоимостиИПартийНДС
	|ИЗ
	|	(ВЫБРАТЬ
	|		Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Т.РазделУчета КАК РазделУчета,
	|		Т.ВидЗапасов КАК ВидЗапасов,
	|		Т.Организация КАК Организация,
	|		Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|		Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|		Т.Количество КАК КоличествоСебестоимость,
	|		0 КАК КоличествоПартииНДС
	|	ИЗ
	|		ВТСебестоимость КАК Т
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.РазделУчета,
	|		Т.ВидЗапасов,
	|		Т.Организация,
	|		Т.АналитикаФинансовогоУчета,
	|		Т.ВидДеятельностиНДС,
	|		0,
	|		Т.Количество
	|	ИЗ
	|		ВТПартииНДС КАК Т) КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.РазделУчета,
	|	Т.ВидЗапасов,
	|	Т.Организация,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС
	|
	|ИМЕЮЩИЕ
	|	СУММА(Т.КоличествоСебестоимость) >= 0
	|	И СУММА(Т.КоличествоСебестоимость) < СУММА(Т.КоличествоПартииНДС)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	СУММА(Т.КоличествоСебестоимость) КАК КоличествоСебестоимость,
	|	СУММА(Т.СтоимостьРеглСебестоимость) КАК СтоимостьРеглСебестоимость,
	|	СУММА(Т.СтоимостьУпрСебестоимость) КАК СтоимостьУпрСебестоимость,
	|	СУММА(Т.СтоимостьРеглПартииНДС) КАК СтоимостьРеглПартииНДС,
	|	СУММА(Т.СтоимостьУпрПартииНДС) КАК СтоимостьУпрПартииНДС
	|ПОМЕСТИТЬ ВТРасхожденияСебестоимостиИПартийНДС2_4
	|ИЗ
	|	(ВЫБРАТЬ
	|		Т.Организация,
	|		Т.Партия,
	|		ЕСТЬNULL(АналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)) КАК АналитикаУчетаПартий,
	|		Т.ВидДеятельностиНДС,
	|		Т.Количество КАК КоличествоСебестоимость,
	|		Т.СтоимостьРегл КАК СтоимостьРеглСебестоимость,
	|		Т.СтоимостьУпр КАК СтоимостьУпрСебестоимость,
	|		0 КАК СтоимостьРеглПартииНДС,
	|		0 КАК СтоимостьУпрПартииНДС
	|	ИЗ
	|		ВТСебестоимость КАК Т
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТОтборАналитикиУчетаПартийНДС2_4 КАК АналитикиУчетаПартий
	|			ПО Т.АналитикаУчетаПартий = АналитикиУчетаПартий.Ссылка
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Т.Организация,
	|		Т.Партия,
	|		Т.АналитикаУчетаПартий,
	|		Т.ВидДеятельностиНДС,
	|		0 КАК КоличествоСебестоимость,
	|		0 КАК СтоимостьРеглСебестоимость,
	|		0 КАК СтоимостьУпрСебестоимость,
	|		Т.СтоимостьРегл КАК СтоимостьРеглПартииНДС,
	|		Т.СтоимостьУпр КАК СтоимостьУпрПартииНДС
	|	ИЗ
	|		ВТПартииНДС2_4 КАК Т) КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС
	|
	|ИМЕЮЩИЕ
	|	(СУММА(Т.КоличествоСебестоимость) > 0
	|		И СУММА(Т.СтоимостьРеглСебестоимость) + &ЗначениеПогрешностиСебестоимостьРегл < СУММА(Т.СтоимостьРеглПартииНДС))
	|	ИЛИ
	|	(СУММА(Т.КоличествоСебестоимость) > 0
	|		И СУММА(Т.СтоимостьУпрСебестоимость) + &ЗначениеПогрешностиСебестоимостьУпр < СУММА(Т.СтоимостьУпрПартииНДС))
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	СУММА(Т.КоличествоСебестоимость) КАК КоличествоСебестоимость,
	|	СУММА(Т.КоличествоПартииНДС) КАК КоличествоПартииНДС,
	|	СУММА(Т.СтоимостьПартииНДС) КАК СтоимостьПартииНДС
	|ПОМЕСТИТЬ ВТСуммовыеОстаткиПартийНДС
	|ИЗ
	|	(ВЫБРАТЬ
	|		Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Т.РазделУчета КАК РазделУчета,
	|		Т.ВидЗапасов КАК ВидЗапасов,
	|		Т.Организация КАК Организация,
	|		Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|		Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|		Т.Количество КАК КоличествоСебестоимость,
	|		0 КАК КоличествоПартииНДС,
	|		0 КАК СтоимостьПартииНДС
	|	ИЗ
	|		ВТСебестоимость КАК Т
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.РазделУчета,
	|		Т.ВидЗапасов,
	|		Т.Организация,
	|		Т.АналитикаФинансовогоУчета,
	|		Т.ВидДеятельностиНДС,
	|		0 КАК КоличествоСебестоимость,
	|		Т.Количество КАК КоличествоПартииНДС,
	|		Т.СтоимостьБезНДС КАК СтоимостьПартииНДС
	|	ИЗ
	|		ВТПартииНДС КАК Т) КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.РазделУчета,
	|	Т.ВидЗапасов,
	|	Т.Организация,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС
	|
	|ИМЕЮЩИЕ
	|	СУММА(Т.КоличествоСебестоимость) = 0
	|	И СУММА(Т.КоличествоПартииНДС) = 0
	|	И СУММА(Т.СтоимостьПартииНДС) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС,
	|	СУММА(Т.КоличествоСебестоимость) КАК КоличествоСебестоимость,
	|	СУММА(Т.СтоимостьРеглПартииНДС) КАК СтоимостьРеглПартииНДС,
	|	СУММА(Т.СтоимостьУпрПартииНДС) КАК СтоимостьУпрПартииНДС
	|ПОМЕСТИТЬ ВТСуммовыеОстаткиПартийНДС2_4
	|ИЗ
	|	(ВЫБРАТЬ
	|		Т.Организация,
	|		Т.Партия,
	|		ЕСТЬNULL(АналитикиУчетаПартий.Ссылка, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)) КАК АналитикаУчетаПартий,
	|		Т.ВидДеятельностиНДС,
	|		Т.Количество КАК КоличествоСебестоимость,
	|		0 КАК СтоимостьРеглПартииНДС,
	|		0 КАК СтоимостьУпрПартииНДС
	|	ИЗ
	|		ВТСебестоимость КАК Т
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТОтборАналитикиУчетаПартийНДС2_4 КАК АналитикиУчетаПартий
	|			ПО Т.АналитикаУчетаПартий = АналитикиУчетаПартий.Ссылка
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Т.Организация,
	|		Т.Партия,
	|		Т.АналитикаУчетаПартий,
	|		Т.ВидДеятельностиНДС,
	|		0 КАК КоличествоСебестоимость,
	|		Т.СтоимостьРегл КАК СтоимостьРеглПартииНДС,
	|		Т.СтоимостьУпр КАК СтоимостьУпрПартииНДС
	|	ИЗ
	|		ВТПартииНДС2_4 КАК Т) КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.ВидДеятельностиНДС
	|
	|ИМЕЮЩИЕ
	|	СУММА(Т.КоличествоСебестоимость) = 0
	|	И (СУММА(Т.СтоимостьРеглПартииНДС) <> 0
	|		ИЛИ СУММА(Т.СтоимостьУпрПартииНДС) <> 0)
	|";
	
	// Регистрация расхождений по количеству между регистрами себестоимости и партиями НДС 2.2.
	СписокПолей = Новый СписокЗначений;
	СписокПолей.Добавить("Организация");
	СписокПолей.Добавить("РазделУчета",					НСтр("ru='Раздел учета'"));
	СписокПолей.Добавить("АналитикаУчетаНоменклатуры",	НСтр("ru='Аналитика номенклатуры'"));
	СписокПолей.Добавить("ВидЗапасов",					НСтр("ru='Вид запасов'"));
	СписокПолей.Добавить("АналитикаФинансовогоУчета",	НСтр("ru='Аналитика финансового учета'"));
	СписокПолей.Добавить("ВидДеятельностиНДС",			НСтр("ru='Вид деятельности НДС'"));
	СписокПолей.Добавить("КоличествоСебестоимость",		НСтр("ru='Количество (себестоимость)'"));
	СписокПолей.Добавить("КоличествоПартииНДС",			НСтр("ru='Количество (партии НДС)'"));
	
	ПараметрыРегистрации = ЗакрытиеМесяцаСервер.ИнициализироватьПараметрыРегистрацииПроблемПроверки(
		"ВТРасхожденияСебестоимостиИПартийНДС",
		НСтр("ru='Обнаружены расхождения по количеству между регистрами себестоимости и партий НДС (средняя за месяц) по организации ""%1"" на конец периода %2'"),
		СписокПолей,
		,
		Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН.ПолноеИмя());
		
	// Регистрация наличия суммовых остатков в регистре "Детализация партий товаров для НДС и УСН (средняя за месяц)".
	СписокПолей = Новый СписокЗначений;
	СписокПолей.Добавить("Организация");
	СписокПолей.Добавить("РазделУчета",					НСтр("ru='Раздел учета'"));
	СписокПолей.Добавить("АналитикаУчетаНоменклатуры",	НСтр("ru='Аналитика номенклатуры'"));
	СписокПолей.Добавить("ВидЗапасов",					НСтр("ru='Вид запасов'"));
	СписокПолей.Добавить("АналитикаФинансовогоУчета",	НСтр("ru='Аналитика финансового учета'"));
	СписокПолей.Добавить("ВидДеятельностиНДС",			НСтр("ru='Вид деятельности НДС'"));
	СписокПолей.Добавить("СтоимостьПартииНДС",			НСтр("ru='Стоимость без НДС'"));
	
	ЗакрытиеМесяцаСервер.ДополнитьПараметрыРегистрацииПроблемПроверки(ПараметрыРегистрации,
		"ВТСуммовыеОстаткиПартийНДС",
		НСтр("ru='Обнаружены суммовые остатки без количества в регистре ""Детализация партий товаров для НДС и УСН (средняя за месяц)"" по организации ""%1"" на конец периода %2'"),
		СписокПолей,
		,
		Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН.ПолноеИмя());
		
	// Регистрация расхождений по количеству между регистрами себестоимости и партиями НДС 2.4.
	СписокПолей = Новый СписокЗначений;
	СписокПолей.Добавить("Организация");
	СписокПолей.Добавить("Партия",						НСтр("ru='Партия'"));
	СписокПолей.Добавить("АналитикаУчетаПартий",		НСтр("ru='Аналитика партий'"));
	СписокПолей.Добавить("ВидДеятельностиНДС",			НСтр("ru='Вид деятельности НДС'"));
	СписокПолей.Добавить("СтоимостьРеглСебестоимость",	НСтр("ru='Стоимость регл. (себестоимость)'"));
	СписокПолей.Добавить("СтоимостьУпрСебестоимость",	НСтр("ru='Стоимость упр. (себестоимость)'"));
	СписокПолей.Добавить("СтоимостьРеглПартииНДС",		НСтр("ru='Стоимость регл. (партии НДС)'"));
	СписокПолей.Добавить("СтоимостьУпрПартииНДС",		НСтр("ru='Стоимость упр. (партии НДС)'"));
	
	ЗакрытиеМесяцаСервер.ДополнитьПараметрыРегистрацииПроблемПроверки(ПараметрыРегистрации,
		"ВТРасхожденияСебестоимостиИПартийНДС2_4",
		НСтр("ru='Обнаружены расхождения в суммах между регистрами себестоимости и партий НДС (ФИФО скользящая оценка) по организации ""%1"" на конец периода %2'"),
		СписокПолей,
		,
		Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН2_4.ПолноеИмя());
		
	// Регистрация наличия суммовых остатков в регистре "Детализация партий товаров для НДС и УСН (ФИФО скользящая оценка)".
	СписокПолей = Новый СписокЗначений;
	СписокПолей.Добавить("Организация");
	СписокПолей.Добавить("Партия",						НСтр("ru='Партия'"));
	СписокПолей.Добавить("АналитикаУчетаПартий",		НСтр("ru='Аналитика партий'"));
	СписокПолей.Добавить("ВидДеятельностиНДС",			НСтр("ru='Вид деятельности НДС'"));
	СписокПолей.Добавить("СтоимостьРеглПартииНДС",		НСтр("ru='Стоимость регл. (партии НДС)'"));
	СписокПолей.Добавить("СтоимостьУпрПартииНДС",		НСтр("ru='Стоимость упр. (партии НДС)'"));
	
	ЗакрытиеМесяцаСервер.ДополнитьПараметрыРегистрацииПроблемПроверки(ПараметрыРегистрации,
		"ВТСуммовыеОстаткиПартийНДС2_4",
		НСтр("ru='Обнаружены суммовые остатки в регистре ""Детализация партий товаров для НДС и УСН (ФИФО скользящая оценка)"" без остатков в регистре себестоимости по организации ""%1"" на конец периода %2'"),
		СписокПолей,
		,
		Метаданные.РегистрыНакопления.ДетализацияПартийТоваровДляНДСиУСН2_4.ПолноеИмя());
		
	// Регистрация проблем.
	ДопПараметры = Новый Структура;
	ДопПараметры.Вставить("ТипыНалогообложенияНДСУчитываетсяВСтоимости", УчетНДСУП.ВидыДеятельностиНДСУчитываетсяВСтоимости());
	ДопПараметры.Вставить("ЗначениеПогрешностиСебестоимостьРегл", 		 ЗначенияПараметров.ЗначениеПогрешностиСебестоимостьРегл);
	ДопПараметры.Вставить("ЗначениеПогрешностиСебестоимостьУпр", 		 ЗначенияПараметров.ЗначениеПогрешностиСебестоимостьУпр);
	
	ЗакрытиеМесяцаСервер.ЗарегистрироватьПроблемыВыполненияПроверки(
		ПараметрыПроверки,
		ПараметрыРегистрации,
		ТекстЗапроса,
		ДопПараметры);
	
КонецПроцедуры


// Проверка необходимости пересчета себестоимости из-за незаполненного измерения АналитикаУчетаПартий регистра ДетализацияПартийТоваровДляНДСиУСН2_4.
// Вызывается в процедуре определения состояния этапа расчета партий и себестоимости.
//
Функция ПроверкаНеобходимостьПересчетаРегистраПартийНДС(ПараметрыРасчета) Экспорт
	
	Если НЕ РасчетСебестоимостиПовтИсп.ПартионныйУчетВерсии22(НачалоМесяца(ПараметрыРасчета.ПериодРегистрации)) Тогда
		Возврат Неопределено; // проверка нужна только при ПУ22
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
	Запрос.УстановитьПараметр("КонецПериода", 				  КонецМесяца(ПараметрыРасчета.ПериодРегистрации));
	Запрос.УстановитьПараметр("МассивОрганизаций",  		  ПараметрыРасчета.МассивОрганизаций);
	Запрос.УстановитьПараметр("ТипыЗаписейКонвертацииДанных", РасчетСебестоимостиПрикладныеАлгоритмы.ТипыЗаписейКонвертацииДанных());
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	МИНИМУМ(ВЫБОР
	|			КОГДА Т.ТипЗаписи В (&ТипыЗаписейКонвертацииДанных)
	|				ТОГДА ДОБАВИТЬКДАТЕ(Т.Период, МЕСЯЦ, 1)
	|			ИНАЧЕ Т.Период
	|		КОНЕЦ) КАК Период
	|ИЗ
	|	РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН2_4 КАК Т
	|ГДЕ
	|	Т.Организация В(&МассивОрганизаций)
	|	И Т.ДокументПоступления = Т.Партия
	|	И Т.АналитикаУчетаПартий = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|	И Т.АналитикаУчетаДокументаПоступления <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|	И НЕ Т.АналитикаУчетаДокументаПоступления.Контрагент В (ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка), ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка), НЕОПРЕДЕЛЕНО)
	|	И ВЫБОР
	|			КОГДА Т.ТипЗаписи В (&ТипыЗаписейКонвертацииДанных)
	|				ТОГДА ДОБАВИТЬКДАТЕ(Т.Период, МЕСЯЦ, 1)
	|			ИНАЧЕ Т.Период
	|		КОНЕЦ <= &КонецПериода
	|	И Т.Активность";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() И ЗначениеЗаполнено(Выборка.Период) Тогда
		Возврат Выборка.Период;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

#КонецОбласти

#Область Тестирование

Процедура ДополнитьЭтапыСРаспределениемПартий(СписокЭтапов) Экспорт
	
	СписокЭтапов.Добавить("ПодготовкаДанныхДляУчетаНДСиУСН");
	СписокЭтапов.Добавить("ПодготовкаДанныхДляУчетаНДСиУСН2_4");
	
КонецПроцедуры

Процедура ДополнитьЭтапыСТрансляциейПартий(СписокЭтапов) Экспорт
	
	СписокЭтапов.Добавить("ПодготовкаДанныхДляПартийНДСКРаспределению");
	
КонецПроцедуры

Процедура ТекстЗапросаДляРасчетаЭтапа(ИмяЭтапа, ПараметрыРасчета, ТекстЗапроса) Экспорт
	
	Если ИмяЭтапа = "ПодготовкаДанныхДляУчетаНДСиУСН" Тогда
		ТекстЗапроса = ТекстЗапросаДляПартийНДС(ПараметрыРасчета);
		
	ИначеЕсли ИмяЭтапа = "ПодготовкаДанныхДляУчетаНДСиУСН2_4" Тогда
		ТекстЗапроса = ТекстЗапросаДляПартийНДС2_4(ПараметрыРасчета);
		
	ИначеЕсли ИмяЭтапа = "ПодготовкаДанныхДляПартийНДСКРаспределению" Тогда
		ТекстЗапроса = ТекстЗапросаДляПартийНДСКРаспределению(ПараметрыРасчета);
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти