////////////////////////////////////////////////////////////////////////////////
// Процедуры и функции подсистемы ТМЦ в эксплуатации.
// 
////////////////////////////////////////////////////////////////////////////////

#Область СлужебныйПрограммныйИнтерфейс

Процедура ОбработкаПолученияДанныхВыбораПартииТМЦВЭксплуатации(ДанныеВыбора, Параметры, СтандартнаяОбработка) Экспорт
	
	Если НЕ Параметры.Свойство("ОграничениеВыбора") 
		ИЛИ НЕ Параметры.ОграничениеВыбора Тогда
		Возврат;
	КонецЕсли;
		
	Если Параметры.Свойство("ТекущийРегистратор") Тогда
		
		ТекстЗапроса = 
		"ВЫБРАТЬ
		|	ВложенныйЗапрос.Ссылка
		|ИЗ
		|	(ВЫБРАТЬ
		|		ТМЦВЭксплуатацииОбороты.Партия КАК Ссылка,
		|		ТМЦВЭксплуатацииОбороты.КоличествоОборот КАК КоличествоОборот
		|	ИЗ
		|		РегистрНакопления.ТМЦВЭксплуатации.Обороты(
		|				,
		|				,
		|				,
		|				НЕ Партия.ПометкаУдаления
		|					И (НЕ &ОтборДата
		|						ИЛИ Партия.ДатаЗавершенияЭксплуатации > &Дата
		|						ИЛИ Партия.ДатаЗавершенияЭксплуатации = ДАТАВРЕМЯ(1, 1, 1))
		|					И (НЕ &ОтборОрганизация
		|						ИЛИ Организация = &Организация)
		|					И (НЕ &ОтборПодразделение
		|						ИЛИ Подразделение = &Подразделение)
		|					И (НЕ &ОтборФизическоеЛицо
		|						ИЛИ ФизическоеЛицо = &ФизическоеЛицо)
		|					И (НЕ &ОтборНоменклатура
		|						ИЛИ Номенклатура = &Номенклатура)
		|					И (НЕ &ОтборХарактеристика
		|						ИЛИ Характеристика = &Характеристика)) КАК ТМЦВЭксплуатацииОбороты
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		ТМЦВЭксплуатации.Партия,
		|		-ТМЦВЭксплуатации.Количество
		|	ИЗ
		|		РегистрНакопления.ТМЦВЭксплуатации КАК ТМЦВЭксплуатации
		|	ГДЕ
		|		ТМЦВЭксплуатации.Регистратор = &ТекущийРегистратор
		|		И НЕ ТМЦВЭксплуатации.Партия.ПометкаУдаления
		|		И (НЕ &ОтборДата
		|				ИЛИ ТМЦВЭксплуатации.Партия.ДатаЗавершенияЭксплуатации > &Дата
		|				ИЛИ ТМЦВЭксплуатации.Партия.ДатаЗавершенияЭксплуатации = ДАТАВРЕМЯ(1, 1, 1))
		|		И (НЕ &ОтборОрганизация
		|				ИЛИ ТМЦВЭксплуатации.Организация = &Организация)
		|		И (НЕ &ОтборПодразделение
		|				ИЛИ ТМЦВЭксплуатации.Подразделение = &Подразделение)
		|		И (НЕ &ОтборФизическоеЛицо
		|				ИЛИ ТМЦВЭксплуатации.ФизическоеЛицо = &ФизическоеЛицо)
		|		И (НЕ &ОтборНоменклатура
		|				ИЛИ ТМЦВЭксплуатации.Номенклатура = &Номенклатура)
		|		И (НЕ &ОтборХарактеристика
		|				ИЛИ ТМЦВЭксплуатации.Характеристика = &Характеристика)) КАК ВложенныйЗапрос
		|
		|СГРУППИРОВАТЬ ПО
		|	ВложенныйЗапрос.Ссылка
		|
		|ИМЕЮЩИЕ
		|	СУММА(ВложенныйЗапрос.КоличествоОборот) > 0";
		
	Иначе
		
		ТекстЗапроса = 
		"ВЫБРАТЬ
		|	ТМЦВЭксплуатацииОбороты.Партия КАК Ссылка
		|ИЗ
		|	РегистрНакопления.ТМЦВЭксплуатации.Обороты(
		|			,
		|			,
		|			,
		|			НЕ Партия.ПометкаУдаления
		|				И (НЕ &ОтборДата
		|					ИЛИ Партия.ДатаЗавершенияЭксплуатации > &Дата
		|					ИЛИ Партия.ДатаЗавершенияЭксплуатации = ДАТАВРЕМЯ(1, 1, 1))
		|				И (НЕ &ОтборОрганизация
		|					ИЛИ Организация = &Организация)
		|				И (НЕ &ОтборПодразделение
		|					ИЛИ Подразделение = &Подразделение)
		|				И (НЕ &ОтборФизическоеЛицо
		|					ИЛИ ФизическоеЛицо = &ФизическоеЛицо)
		|				И (НЕ &ОтборНоменклатура
		|					ИЛИ Номенклатура = &Номенклатура)
		|				И (НЕ &ОтборХарактеристика
		|					ИЛИ Характеристика = &Характеристика)) КАК ТМЦВЭксплуатацииОбороты
		|ГДЕ
		|	ТМЦВЭксплуатацииОбороты.КоличествоОборот > 0";
		
	КонецЕсли; 
	
	ПараметрыЗапроса = Новый Структура;
	ПараметрыЗапроса.Вставить("Дата", Дата(1, 1, 1, 0, 0, 0));
	ПараметрыЗапроса.Вставить("Организация", Справочники.Организации.ПустаяСсылка());
	ПараметрыЗапроса.Вставить("Подразделение", Справочники.СтруктураПредприятия.ПустаяСсылка());
	ПараметрыЗапроса.Вставить("ФизическоеЛицо", Справочники.ФизическиеЛица.ПустаяСсылка());
	ПараметрыЗапроса.Вставить("Номенклатура", Справочники.Номенклатура.ПустаяСсылка());
	ПараметрыЗапроса.Вставить("Характеристика", Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());
	ПараметрыЗапроса.Вставить("ТекущийРегистратор", Неопределено);
	
	ЗаполнитьЗначенияСвойств(ПараметрыЗапроса, Параметры);
	
	Запрос = Новый Запрос(ТекстЗапроса);
	Для Каждого КлючИЗначение Из ПараметрыЗапроса Цикл
		Запрос.УстановитьПараметр(КлючИЗначение.Ключ, КлючИЗначение.Значение);
		Запрос.УстановитьПараметр("Отбор" + КлючИЗначение.Ключ, ЗначениеЗаполнено(КлючИЗначение.Значение));
	КонецЦикла;
	
	ДанныеВыбора = Новый СписокЗначений;
	
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		СтандартнаяОбработка = Ложь;
	Иначе
		Параметры.Отбор.Вставить("Ссылка", Результат.Выгрузить().ВыгрузитьКолонку("Ссылка"));
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти
