
#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ОбработчикиСобытий

Процедура ПриУстановкеНовогоНомера(СтандартнаяОбработка, Префикс)
	
	КассовыеСменыПереопределяемый.ПриУстановкеНовогоНомера(ЭтотОбъект, СтандартнаяОбработка, Префикс);
	
КонецПроцедуры

Процедура ОбработкаПроверкиЗаполнения(Отказ, ПроверяемыеРеквизиты)
	
	КассовыеСменыПереопределяемый.ОбработкаПроверкиЗаполнения(ЭтотОбъект, Отказ, ПроверяемыеРеквизиты);
	
КонецПроцедуры

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, ТекстЗаполнения, СтандартнаяОбработка)
	
	КассовыеСменыПереопределяемый.ОбработкаЗаполнения(ЭтотОбъект, ДанныеЗаполнения, ТекстЗаполнения, СтандартнаяОбработка);
	
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	Если ЭтотОбъект.Статус = Перечисления.СтатусыКассовойСмены.Закрыта Тогда  
		
		Движения.ШМ_ЗПРаботникам.Записывать = Истина;  
		
		НаборЗаписей = ЗаписиРегистраШМ_Затраты(ЭтотОбъект.НачалоКассовойСмены, ЭтотОбъект.ОкончаниеКассовойСмены);
		
		Для Каждого стр из НаборЗаписей Цикл
			Движение = Движения.ШМ_ЗПРаботникам.Добавить();
			Движение.Период = стр.Период;
			Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
			Движение.Исполнитель = стр.Сотрудник;
			Движение.Сумма= стр.Сумма;
		КонецЦикла;	
	
	КонецЕсли;	
КонецПроцедуры 

&НаСервере
Функция ЗаписиРегистраШМ_Затраты(ДатаНачала, ДатаКонца)

	лТекст = "ВЫБРАТЬ
	         |	ШМ_Затраты.Период КАК Период,
	         |	ШМ_Затраты.Затрата КАК Затрата,
	         |	ШМ_Затраты.Сотрудник КАК Сотрудник,
	         |	ШМ_Затраты.Профессия КАК Профессия,
	         |	ШМ_Затраты.Сумма КАК Сумма
	         |ИЗ
	         |	РегистрСведений.ШМ_Затраты КАК ШМ_Затраты
	         |ГДЕ
	         |	ШМ_Затраты.Период МЕЖДУ &Период1 И &Период2";

	лЗапрос = Новый Запрос(лТекст);
	
	Если ДатаКонца < ДатаНачала Тогда
		ДатаКонца = ТекущаяДата(); 
	КонецЕсли;	
	лЗапрос.УстановитьПараметр("Период1", ДатаНачала);
	лЗапрос.УстановитьПараметр("Период2", ДатаКонца);


	лВыборка = лЗапрос.Выполнить().Выгрузить(); 
	
	Возврат лВыборка

КонецФункции

#КонецОбласти

#КонецЕсли
